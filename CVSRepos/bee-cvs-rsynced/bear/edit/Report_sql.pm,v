head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2004.02.24.10.21.49;	author jiri_schmid;	state Exp;
branches;
next	1.3;

1.3
date	2004.02.05.09.43.40;	author jiri_schmid;	state Exp;
branches;
next	1.2;

1.2
date	2003.11.18.14.38.40;	author jiri_schmid;	state Exp;
branches;
next	1.1;

1.1
date	2003.10.31.12.47.57;	author jiri_schmid;	state Exp;
branches;
next	;


desc
@@


1.4
log
@prefer access and rights logic changed
@
text
@#-----------------------------------------------------
#  Report Editation
#-----------------------------------------------------
# $Id: Report_sql.pm,v 1.3 2004/02/05 09:43:40 jiri_schmid Exp $

package Report_sql;

use strict;

#-----------------------------------------------------
sub generateContent {
my($variables, $lang, $obj) = (shift, shift, shift);

my $saveRun = $$variables->{saveRun} if exists $$variables->{saveRun};
my $imgType = \$$variables->{imgType};
my $skinPath = \$$variables->{skinPath};

#use Data::Dumper;
#print "<pre>".Dumper($variables)."</pre>";

print "<script src='js/report.js' type='text/javascript'></script>";

my $sqlAccess=SOAP->GetSqlAccess($$variables->{user},$$variables->{proj});

return if ($sqlAccess eq 'none');	# user has no access to SQL

my $sql=SOAP->GetSQL($$variables->{id});	# here should be access to SQL Generator --> generateSql();
my $origCustomSql = $$obj->{sql_def};

$sql =~ s/\\n/\n/g;	# substitute <BR> as \n
print <<END;

<br />
<table class="page_skeleton">
<tr class="page_skeleton">
<td class="page_skeleton">
	<table class="neutral">
	<tr><td class="neutral_title">$$lang->{'Report SQL'}</td></tr>
	<tr><td class="neutral">
END
	if ($sqlAccess eq 'edit') {	# user has access to SQL editation
		my %ch;
		my $view;
		my $readOnly;
		if ($origCustomSql) {
			$ch{edited}='checked';
			($view = $origCustomSql) =~ s/\\n/\n/g;
			$readOnly = "";
		} else {
			$origCustomSql = $view = $sql;
			$ch{default}='checked'; 
			$readOnly = "readonly";
		}
		
print <<END ;
		<INPUT TYPE="RADIO" NAME="sql_use" id="generatedSql" onclick="defaultSql()" VALUE="default"$ch{default} />
		<span class="cursor" onclick="switchSql('generatedSql')">$$lang->{'Report Default SQL'}</span>&nbsp;
		<img class="cursor" src="$${skinPath}img/rightArr.$$imgType" onclick="copySql()" title="$$lang->{Copy}">&nbsp;
		<INPUT TYPE="RADIO" NAME="sql_use" id="customSql" onclick="editSql()" VALUE="edited"$ch{edited} />
		<span class="cursor" onclick="switchSql('customSql')">$$lang->{'Report Edited SQL'}</span>
		<img class="cursor" src="$${skinPath}img/delete.$$imgType" onclick="clearSql()" title="$$lang->{Delete}">
	</td></tr>
	<tr><td><TEXTAREA NAME="expr" id="expr" ROWS="$Const::sqlRows" COLS="$Const::wb_const->{ $$variables->{wb} }{sqlCols}" WRAP="SOFT" onchange="object_changed()" $readOnly>$view</TEXTAREA>
	<input type="hidden" value="$sql" name="expr_id" id="expr_id" />
	</td></tr>
	</table>
</td></tr>
<tr class="page_skeleton">
<td class="page_skeleton">
	<table class="neutral_100">
	<tr><td align="center">
		<table class="buttons" cellpading="0" cellspacing="0">
		<tr>	<td class="buttons"><input id='SAVE' type="submit" name="Action" value="$$lang->{'Save'}" id="SQLSAVE" onclick="saveSql()"/></td>
			<td class="buttons"><input type="submit" name="Action" value="$$lang->{'Save and Run'}" onclick="saveSql()" /></td>
			<td class="buttons"><input type="button" name="reset" value="$$lang->{'Reset'}" id="SQLRELOAD" onclick="reloadSql()"/></td>
		</tr>
		</table>
	</td></tr>
	</table>


END
	} elsif ($sqlAccess eq 'view') {	# user has view access to SQL only
		print &Local::SQL2HTML($sql)
	}
print "</td><td></table><script type='text/javascript' src='js/report_sql.js'></script><script type='text/javascript'>";
print "var customSql = '$origCustomSql';";
print "var originalCustomSql = '$origCustomSql';$saveRun</script>";
END
}

#---------------------------------------------------
sub set_next_param {
my ($o,$q) = (shift,shift);

if ($$q->param('expr_id') eq "") {
		delete($$o->{sql_def});
	} else {
		(my $hlp = $$q->param('expr_id')) =~ s/\r//g;
		($$o->{sql_def} = $hlp) =~ s/\n/\\n/g;
	}
}


1
@


1.3
log
@prototype of GetSQL implemented
@
text
@d4 1
a4 1
# $Id: Report_sql.pm,v 1.2 2003/11/18 14:38:40 jiri_schmid Exp $
d12 1
a12 1
my($variables, $lang, $obj, $q) = (shift, shift, shift, shift);
d18 3
d23 2
a24 1
my $sqlAccess=$q->param('sqlA');
d31 1
a31 1
print <<END ;
d41 1
a41 1
	if ($$variables->{allParams} =~ /sqlA=edit/ ) {	# user has access to SQL editation
@


1.2
log
@auto save when changing tabs implemented
@
text
@d4 1
a4 1
# $Id: Report_sql.pm,v 1.1 2003/10/31 12:47:57 jiri_schmid Exp $
d23 1
a23 1
my $sql='nejakej SELECT';	# here should be access to SQL Generator --> generateSql();
@


1.1
log
@mod perl rocks!
@
text
@d4 1
a4 1
# $Id: report_sql_ed.pl,v 1.17 2003/10/17 11:36:16 jiri_schmid Exp $
d69 1
a69 1
		<tr>	<td class="buttons"><input type="submit" name="Action" value="$$lang->{'Save'}" id="SQLSAVE" onclick="saveSql()"/></td>
@

