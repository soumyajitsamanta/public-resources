head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2004.03.01.16.16.49;	author numberone;	state Exp;
branches;
next	;


desc
@@


1.1
log
@
Added beard2 -- new bear daemon source tree.

mdata subsystem works, some docs, some tests, etc.

cached in progress
@
text
@#!/usr/bin/perl -w

use FreezeThaw;
use IPC::ShareLite;
use Data::Dumper;
use Errno qw(EEXIST);

my $key = shift || $$;
my $share_rw = new IPC::ShareLite( 
		-key => $key,
		-create => 'yes', 
		-destroy => 'yes',
		-exclusive =>'yes' );

unless($share_rw) {
	die $! unless($!{EEXIST});
	die "shm with key '$key' exists. another instance of mdata running?\n";
}

$share_rw->store("hello $$") or die $!;

for(1..5) {
	next if fork;

	# hack to IPC::ShareLite -- only parent destroys shm
	$share_rw->{destroy} = 0;

	my $share_ro = new IPC::ShareLite( 
		-key => $key, 
		-create => 'no', 
		-destroy => 'no',
		-exclusive =>'no' ) or die $!;

	print "$$: fetch: ",$share_ro->fetch(),"\n";

	exit;
}

while(waitpid(-1,0) > 0) {}
print "finishing\n";

@
