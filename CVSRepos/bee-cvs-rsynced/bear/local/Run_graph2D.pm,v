head	1.55;
access;
symbols;
locks; strict;
comment	@# @;


1.55
date	2004.05.03.16.22.40;	author michald;	state Exp;
branches;
next	1.54;

1.54
date	2004.04.28.13.52.56;	author vacula;	state Exp;
branches;
next	1.53;

1.53
date	2004.04.22.16.01.45;	author vacula;	state Exp;
branches;
next	1.52;

1.52
date	2004.04.22.11.32.15;	author vacula;	state Exp;
branches;
next	1.51;

1.51
date	2004.04.19.16.41.24;	author vacula;	state Exp;
branches;
next	1.50;

1.50
date	2004.04.16.15.43.31;	author vacula;	state Exp;
branches;
next	1.49;

1.49
date	2004.04.13.12.42.37;	author michald;	state Exp;
branches;
next	1.48;

1.48
date	2004.03.17.17.22.10;	author vacula;	state Exp;
branches;
next	1.47;

1.47
date	2004.02.24.21.01.00;	author vasekd;	state Exp;
branches;
next	1.46;

1.46
date	2004.02.24.14.49.24;	author vacula;	state Exp;
branches;
next	1.45;

1.45
date	2004.02.17.16.45.38;	author vacula;	state Exp;
branches;
next	1.44;

1.44
date	2004.02.17.14.07.27;	author vacula;	state Exp;
branches;
next	1.43;

1.43
date	2004.02.13.16.14.12;	author vacula;	state Exp;
branches;
next	1.42;

1.42
date	2004.02.13.16.11.56;	author vacula;	state Exp;
branches;
next	1.41;

1.41
date	2004.02.03.10.48.06;	author vacula;	state Exp;
branches;
next	1.40;

1.40
date	2004.02.02.14.09.05;	author vacula;	state Exp;
branches;
next	1.39;

1.39
date	2004.01.29.16.45.31;	author vacula;	state Exp;
branches;
next	1.38;

1.38
date	2004.01.29.12.49.09;	author vacula;	state Exp;
branches;
next	1.37;

1.37
date	2004.01.23.15.07.39;	author vacula;	state Exp;
branches;
next	1.36;

1.36
date	2004.01.15.03.22.03;	author michald;	state Exp;
branches;
next	1.35;

1.35
date	2004.01.07.10.59.15;	author vacula;	state Exp;
branches;
next	1.34;

1.34
date	2004.01.07.10.05.25;	author vacula;	state Exp;
branches;
next	1.33;

1.33
date	2003.12.19.12.51.48;	author vacula;	state Exp;
branches;
next	1.32;

1.32
date	2003.12.18.15.53.36;	author vacula;	state Exp;
branches;
next	1.31;

1.31
date	2003.12.16.14.48.09;	author vacula;	state Exp;
branches;
next	1.30;

1.30
date	2003.12.15.17.29.51;	author vacula;	state Exp;
branches;
next	1.29;

1.29
date	2003.12.15.09.45.58;	author vacula;	state Exp;
branches;
next	1.28;

1.28
date	2003.12.12.16.44.36;	author vacula;	state Exp;
branches;
next	1.27;

1.27
date	2003.12.04.18.36.31;	author vacula;	state Exp;
branches;
next	1.26;

1.26
date	2003.12.04.12.46.08;	author vacula;	state Exp;
branches;
next	1.25;

1.25
date	2003.12.03.13.11.59;	author vacula;	state Exp;
branches;
next	1.24;

1.24
date	2003.12.02.12.39.33;	author vacula;	state Exp;
branches;
next	1.23;

1.23
date	2003.12.01.10.05.45;	author vasekd;	state Exp;
branches;
next	1.22;

1.22
date	2003.11.28.20.26.02;	author michald;	state Exp;
branches;
next	1.21;

1.21
date	2003.11.28.15.57.32;	author vacula;	state Exp;
branches;
next	1.20;

1.20
date	2003.11.27.08.52.44;	author jiri_schmid;	state Exp;
branches;
next	1.19;

1.19
date	2003.11.25.22.12.11;	author michald;	state Exp;
branches;
next	1.18;

1.18
date	2003.11.25.16.24.10;	author vacula;	state Exp;
branches;
next	1.17;

1.17
date	2003.11.25.12.10.44;	author jiri_schmid;	state Exp;
branches;
next	1.16;

1.16
date	2003.11.21.12.49.52;	author vacula;	state Exp;
branches;
next	1.15;

1.15
date	2003.11.20.15.58.34;	author vacula;	state Exp;
branches;
next	1.14;

1.14
date	2003.11.19.16.25.28;	author vacula;	state Exp;
branches;
next	1.13;

1.13
date	2003.11.13.17.48.06;	author michald;	state Exp;
branches;
next	1.12;

1.12
date	2003.11.13.13.55.21;	author vacula;	state Exp;
branches;
next	1.11;

1.11
date	2003.11.10.18.52.08;	author michald;	state Exp;
branches;
next	1.10;

1.10
date	2003.11.10.06.36.01;	author michald;	state Exp;
branches;
next	1.9;

1.9
date	2003.11.09.20.41.48;	author vacula;	state Exp;
branches;
next	1.8;

1.8
date	2003.11.09.19.19.11;	author vacula;	state Exp;
branches;
next	1.7;

1.7
date	2003.11.07.10.55.50;	author vacula;	state Exp;
branches;
next	1.6;

1.6
date	2003.11.06.18.43.28;	author vacula;	state Exp;
branches;
next	1.5;

1.5
date	2003.11.06.18.21.48;	author vacula;	state Exp;
branches;
next	1.4;

1.4
date	2003.11.05.15.47.57;	author jiri_schmid;	state Exp;
branches;
next	1.3;

1.3
date	2003.11.04.15.19.01;	author jiri_schmid;	state Exp;
branches;
next	1.2;

1.2
date	2003.11.04.09.38.43;	author jiri_schmid;	state Exp;
branches;
next	1.1;

1.1
date	2003.11.04.04.47.39;	author michald;	state Exp;
branches;
next	;


desc
@@


1.55
log
@some fixes from Vlada
@
text
@# $Id: Run_graph2D.pm,v 1.54 2004/04/28 13:52:56 vacula Exp $
 
package Run_graph2D;

use strict;

use GD;
use GD::Polyline;

require "const/Const.pm";
require "local/Graph2d_report.pm";
require "local/Graph2d_grid.pm";
require "local/Graph2d_form.pm";

use XML::Simple;
use GD::Graph::colour;
use GD::Graph::bars;
use GD::Graph::hbars;
use GD::Graph::lines;
use GD::Graph::points;
use GD::Graph::linespoints;
use GD::Graph::mixed;
use GD::Graph::area;
use GD::Graph::pie;
use GD::Graph::pie3d;
use GD::Graph::bars3d;
use GD::Graph::lines3d;
use GD::Graph::Map;
 
use Data::Dumper;
 
 
#--------------------------------------------------------------------------------------------------------------------------------------------

sub exportToHTML {
	my $variables = shift;			# information about html file (file,skin,id,imgType,user ...)
	my $q = shift;				# information in html header
	my $obj = shift;			# information about report (id,name,description,report_type,acl,meta,format_def,var_def, ...)
	my $style = shift;			# definition of format_def (base,acl,name,description,meta,colors,map ...)
	my $dataset = shift;			# ptr to data hash

	if ( !exists $style->{base} ) {
		my $obj = SOAP->GetMetadata($style->{orig_id});
		$style = $obj->{format2d}{$style->{orig_id}};
	}
	
	my $css = 'default';	# default style (from grid styles) will be used for highlighting of the item in context right click menu
	
	my $report = Graph2d_form::report($obj,$variables);
	$report->{bgcolor} = $style->{layout}{bgclr} if ( exists $style->{layout} and ! $style->{layout}{bg_transparent} ) ;
	$report->{lname} = undef if (! $style->{layout}{show_title});
	$report->{description} = undef if (! $style->{layout}{show_title});
	
	if ( $style->{subtype} ne 'map' ) {
		my $distance = ( $style->{ax_Y}{show_distance} ) ? $style->{ax_Y}{distance_length} : 0;
		my ( $x_label, $y_label, $drill_id, $ids, $legend, $data ) = Graph2d_grid::data( $dataset, $style->{base}->{sets}, $distance );
		my ( $hrefs, $lhrefs, $contexts, $drills ) = Graph2d_grid::areaGraph( $style->{form},$data,$legend,$drill_id,$ids );	
		
		if ( $style->{form} eq 'area' or $style->{form} eq 'lines' ) { 
			($data,$legend) = Graph2d_grid::sortCascade($data,$legend); 	# for cascade drawing
		}
		
		my $chart = "GD::Graph::$style->{form}";																												my $chart_map = ( $style->{form} eq 'lines' or $style->{form} eq 'area' ) ? "GD::Graph::linespoints" : "GD::Graph::$style->{form}" ;
		my $graph = $chart->new( $style->{base}->{width}, $style->{base}->{height} );																			my $graph_map = $chart_map->new( $style->{base}->{width}, $style->{base}->{height} );
		my %attributes = Graph2d_form::defineAttr($style, $report->{lname}, \$x_label, \$y_label, \$legend);
		my $fonts = Graph2d_form::defineFonts($style);
		my ($dclrs,$types,$default_type) = objects($style->{entities}->{data});
		
		$graph->set( %attributes ) or die $graph->error; 																										$graph_map->set( %attributes ) or die $graph->error;
		$graph->set_legend(@@{$legend}) if ( defined $legend and $style->{form} ne 'pie' and $style->{form} ne 'pie3d' );										$graph_map->set_legend(@@{$legend}) if defined $legend ;
		$graph->set( dclrs =>  $dclrs );																														$graph_map->set( dclrs =>  $dclrs  );
		$graph->set( types => $types, default_type => $default_type, ) if $style->{form} eq 'mixed'; 															$graph_map->set( types => $types, default_type => $default_type, ) if $style->{form} eq 'mixed';
		($graph,$graph_map) = set_fonts($graph,$graph_map,$style->{form},\%attributes,$legend,$fonts);

		my $gd = $graph->plot($data) or die $graph->error;																										my $gd_map = $graph_map->plot($data) or die $graph->error;

		writeToImg(\$gd, "$report->{id}-$$variables->{useLang}");		## write to img file (image,name)

		open(RT,">$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");		## create HTML file
		binmode (RT,'utf8');
		print RT Graph2d_report::htmlHead($$variables,$css);
		print RT Graph2d_report::htmlBody($$variables,$report);

		my ($img);
		if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$|^pie$|^pie3d$|^area$/ ) {
	    		#my $map = new GD::Graph::Map($graph, contexts => \@@contexts, drills=> \@@drills, );
			my $map = new GD::Graph::Map($graph_map, hrefs => $hrefs, contexts => $contexts, lhrefs => $lhrefs, drills=> $drills, );
			$img = $map->imagemap("graph2D.cgi?id=$report->{id}-$$variables->{useLang}.$Const::format2DReport", $data);
		} 
		else {
			$img = "<img src=\"graph2D.cgi?id=$report->{id}-$$variables->{useLang}.$Const::format2DReport\">";
		}
		print RT Graph2d_report::htmlTableGraph($$variables,$report,$style,\%attributes,$img,$x_label);

		if (! exists $$variables->{export} ) {	## define context menu 
			my ($objectLinks,$links) = contextMenu($$dataset->{links},$$variables);
			print RT "<script type='text/javascript'>var objectLinks = {$objectLinks}; var lang = {$links};</script>";
		}
		print RT $$q->end_html;
		close(RT);
	} 
	else {	# style is map
		my ($metric,$attr,$title,$header,$drill_id,$ids) = Graph2d_grid::mapdata( $dataset, $style->{base}->{sets} );
		my %attributes_map = Graph2d_form::defineAttrMap($style);
		my $maplist = getmap($style->{form}, "$Const::myPath$Const::graph2Dmaps");
		my $zoom = 1;		## if $zoom == 1 -> zoom function is enabled  / $zoom == 0 zoom function is disabled  !!! will be in interface
		my ($htmlmap,$unfiled,$layer_id);
		foreach ( keys %{$maplist->{layer}} ) {
			if ( $header =~ /$maplist->{layer}{$_}{'attr_re'}/i ) {
				$layer_id = $_;
				last;
			}
		}
		my ($scale,$width,$height,$startx,$starty) = myscale( $style->{base}, $maplist, $attr, $layer_id, $zoom);
		my $colors = $style->{entities}{colors}; 
		
		my $image = new GD::Image ($width,$height);
		my $image_bgclr; 
		if ( defined $attributes_map{"boxclr"} ) {
			$image_bgclr = $image->colorAllocate( split(/,/,$attributes_map{"boxclr"}) );
		}
		else {
			$image_bgclr = $image->colorAllocate( split(/,/,$report->{bgcolor}) );
		}
		$image->transparent($image_bgclr) if ( ! defined $attributes_map{"bgclr"} ) ;
		
		## !!! docasne reseni pro spravne vykresleni kraje praha (A) tak, aby ho neprekryval kraj stredocesky (S), "A" musi byt vykresleno az po "S"
		($attr,$metric,$title,$ids) = order($attr,$metric,$title,$ids); 	#  !!! po vyreseni prekryvani odstranit

		for (my $i=0;$i < scalar @@{$attr};$i++ ) {
			my $polyline;
			if ( exists $maplist->{layer}{$layer_id}{object}{$attr->[$i]} ) {	# drawing polygons with html map
				$polyline =  addPolyline( $maplist->{layer}{$layer_id}{object}->{$attr->[$i]}->{points}, $startx, $starty, $scale ); 
				# !!! v docasnem reseni musi byt html mapa vykreslena v opacnem poradi, tj. "A" musi byt ve skriptu pred "S" po vyreseni prekryvani odstranit a nechat puvodni $htmlmap
				$htmlmap .= area($attr->[$#$attr-$i],$title->[$#$attr-$i],$metric->[$#$attr-$i],$drill_id,$ids->[0][$#$attr-$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$#$attr-$i]}{points_clickmap}) if ( exists $maplist->{layer}{$layer_id}{object}{$attr->[$#$attr-$i]} ) ; 
				#$htmlmap .= area($attr->[$i],$title->[$i],$metric->[$i],$drill_id,$ids->[0][$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$i]}{points_clickmap}) ; 
				my ($r,$g,$b) = metric2clr($colors, $metric->[$i] , $report->{bgcolor} );
				my $fillclr = $image->colorAllocate($r,$g,$b);
				$image->filledPolygon($polyline,$fillclr) ;1
			}
			else  {
				my ($r,$g,$b) = metric2clr($colors, $metric->[$i] , $report->{bgcolor} );
				$unfiled->{$i}{color} = [$r,$g,$b];
				$unfiled->{$i}{title} = $title->[$i];
				$unfiled->{$i}{metric} = $metric->[$i];
			}
		}
		foreach ( keys %{$maplist->{layer}{$layer_id}{object}} ) {		# drawing lines around polygons
			my $borderclr = defined $style->{layout}->{lineclr} ? $image->colorAllocate(split(/,/,$style->{layout}->{lineclr})) : $image->colorAllocate(0,0,0);
			my $polyline =  addPolyline( $maplist->{layer}{$layer_id}{object}->{$_}->{points}, $startx, $starty, $scale ) ; 
			$image->polydraw($polyline, $borderclr);
		}

		writeToImg(\$image,"$report->{id}-$$variables->{useLang}");	## writeToImg(image,name)
		open(RT,">$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
		binmode (RT,'utf8');
		print RT Graph2d_report::htmlHead($$variables,$css);
		print RT Graph2d_report::htmlBody($$variables,$report);
		print RT "<Map Name=mapa> $htmlmap </Map>" if ( ! exists $$variables->{export} ) ;
		print RT Graph2d_report::htmlTableMap($$variables,$report,$colors,$width,$height,$unfiled,\%attributes_map);
		if (! exists $$variables->{export} ) {	## define context menu 
			my ($objectLinks,$links) = contextMenu($$dataset->{links},$$variables);
			print RT "<script type='text/javascript'>var objectLinks = {$objectLinks}; var lang = {$links};</script>";
		}
		print RT $$q->end_html;
		close(RT);

	}

}
#--------------------------------------------------------------------------------------------------------------------------------------------

sub writeToSTDOUT { 	# unused funciton 
	my $gd = shift;
	my $format = shift;
	
	print header("image/$format");
	binmode STDOUT;
	print $gd->$format;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub writeToImg {		## get image and name , write to cachedir, with name and format
	my $gd = shift;
	my $name = shift;
	
	my $format = $Const::format2DReport;
	my $path = $Const::myPath;
	my $cache_dir = $Const::cache2DReport;
	
	open(IMG, ">$path/$cache_dir/$name.$format") or die $!;
	binmode (IMG);
	print IMG $$gd->$format;
	close IMG;
	
	return 1;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub objects { 	# get rgb keys of colors, return array of colors
	my $data_obj = shift;
	my (@@data,@@types,$default_type);

	foreach my $it_data ( @@{$data_obj} ) {
		my $item = $it_data->[0];
		my $form = $it_data->[1];
		my ($r,$g,$b) =  ($it_data->[2] ne '') ? split(/,/,$it_data->[2]) : split(/,/,"0,0,0");
		
		push(@@types,$form);
	    push(@@data,GD::Graph::colour::rgb2hex($r,$g,$b));
	} 
	$default_type = "lines";

	return (\@@data,\@@types,$default_type);
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub getmap {		# load xml file with map and return hash with map definition
	my $namefile = shift;
	my $file = "$namefile.xml";
	my $path = shift;
	
	my $PData = new XML::Simple(keyattr=>['id'], rootname=>'map', forcearray=>['object']);
	my $ml = $PData->XMLin("$path/$file");
	my $maplist;
	
	foreach my $lay (keys %{$ml->{layer}}) {
		foreach my $obj (keys %{$ml->{layer}{$lay}{object}}) {
			my @@p = split(' ',$ml->{layer}{$lay}{object}->{$obj}->{points});
			my @@mp= split(' ',$ml->{layer}{$lay}{object}->{$obj}->{points_clickmap});
			foreach (@@p) {
				my @@pp = split(',',$_);
				push @@{$maplist->{layer}{$lay}{object}->{$obj}->{points}}, [@@pp];
			}
			foreach (@@mp) {
				my @@mpp = split(',',$_);
				push @@{$maplist->{layer}{$lay}{object}->{$obj}->{points_clickmap}}, [@@mpp];
			}
			$maplist->{layer}{$lay}{object}->{$obj}->{x} = $ml->{layer}{$lay}{object}->{$obj}->{x};
			$maplist->{layer}{$lay}{object}->{$obj}->{y} = $ml->{layer}{$lay}{object}->{$obj}->{y};
			$maplist->{layer}{$lay}{object}->{$obj}->{'x_lu'} = $ml->{layer}{$lay}{object}->{$obj}->{'x_lu'};
			$maplist->{layer}{$lay}{object}->{$obj}->{'y_lu'} = $ml->{layer}{$lay}{object}->{$obj}->{'y_lu'};
			$maplist->{layer}{$lay}{object}->{$obj}->{'x_rl'} = $ml->{layer}{$lay}{object}->{$obj}->{'x_rd'};
			$maplist->{layer}{$lay}{object}->{$obj}->{'y_rl'} = $ml->{layer}{$lay}{object}->{$obj}->{'y_rd'};
		}
		$maplist->{layer}{$lay}{'re_lang'} = $ml->{layer}{$lay}{'re_lang'};
		$maplist->{layer}{$lay}{'attr_re'} = $ml->{layer}{$lay}{'attr_re'};
	}	
	$maplist->{measurement}->{width} = $ml->{measurement}->{width};
	$maplist->{measurement}->{height} = $ml->{measurement}->{height};
	$maplist->{measurement}->{x_lu} = $ml->{measurement}->{x_lu};
	$maplist->{measurement}->{y_lu} = $ml->{measurement}->{y_lu};
	$maplist->{measurement}->{x_rl} = $ml->{measurement}->{x_rd};
	$maplist->{measurement}->{y_rl} = $ml->{measurement}->{y_rd};
	
	return $maplist;
#	return "<pre>".Dumper($maplist)."</pre>";
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub metric2clr {		# get array (metrics and colors) and current metric ; return  color, which matching current metric (in array)
	my $colors = shift;	# pointer to array ( [ [metric,'color'],[1000,'255,35,115'] ] )
	my $metric = shift; 	# metric from report
	my $rgbstr = shift;	# report->{bgcolor} - if metric is undef, or   metric > any of defined metric in array 

	if ( defined $metric ) {
		my $max = $colors->[0][0];
		foreach ( @@{$colors} ) {
			if ( @@{$_}[0] > $max) {
				$max = @@{$_}[0];
			}
		}
		my $m = $max + 1;
		foreach ( @@{$colors} ) {
			if ( $metric < @@{$_}[0] and $m > @@{$_}[0] ) {
				$m = @@{$_}[0];
				$rgbstr = @@{$_}[1];
			}
		}
	}
	my ($r,$g,$b) = split(/,/,$rgbstr);

	return ($r,$g,$b);
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub addPolyline {		# add line to map
  my $points = shift;
  my $startx = shift;
  my $starty = shift;
  my $scale = shift;
  
  my $polyline = new GD::Polyline;
  foreach ( @@{$points} ) {
     my $x = ( $_->[0] * $scale ) + ( $startx * $scale );
     my $y = ( $_->[1] * $scale ) + ( $starty * $scale );
     $polyline->addPt( $x,$y );
  }

 return ($polyline);
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub myscale {	# scale of map
	my ($style,$maplist,$attr,$layer_id,$zoom) = @@_;	# $style (gd image), $measurement (xml definition),  
	my ($n_width,$n_height,$startx,$starty);			# normalized width , normalized height, 


	if ( $$maplist{measurement}{width} =~ s/cm// ) {
	   $n_width = 1000 * $$maplist{measurement}{width};
	   $$maplist{measurement}{height} =~ s/cm//;
	   $n_height = 1000 * $$maplist{measurement}{height};
	}

	if ( $zoom == 0 ) {
		$n_width = $n_width;
		$n_height = $n_height;
		$startx = 0;
		$starty = 0;
	}

	if ( $zoom ==  1) {
		my ($xlu,$ylu,$xrl,$yrl); 				# x-left upper, y-left upper , x-right lower, y-right lower
		for (my $i=0;$i < scalar @@{$attr};$i++ ) {
			if ($i == 0) {
				$xlu = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_lu'} if (exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]});
				$ylu = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_lu'} if (exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]});
				$xrl = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_rl'} if (exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]});
				$yrl = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_rl'} if (exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]});
			}
			else {
				if ( exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]} and $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_lu'} < $xlu ) {
					$xlu = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_lu'};
				}
				if ( exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]} and $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_lu'} < $ylu ) {
					$ylu = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_lu'};
				}
				if ( exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]} and $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_rl'} > $xrl ) {
					$xrl = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'x_rl'};
				}
				if ( exists $$maplist{layer}{$layer_id}{object}{$attr->[$i]} and $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_rl'} > $yrl ) {
					$yrl = $$maplist{layer}{$layer_id}{object}{$attr->[$i]}{'y_rl'};
				}
			}
		}

		$n_width = ($xrl - $xlu) + ($$maplist{measurement}{x_lu});
		$n_height = ($yrl - $ylu) + ($$maplist{measurement}{y_lu});
		$startx = -$xlu + ($$maplist{measurement}{x_lu}/2);
		$starty = -$ylu + ($$maplist{measurement}{y_lu}/2);
		
	}

	my $gd_width = $$style{width};
	my $scale = $gd_width/$n_width;
	my $gd_height = $scale * $n_height;
	if ( $gd_height > $$style{height} ) {
		$gd_height = $$style{height};
		$scale = $gd_height/$n_height;
		$gd_width = $scale * $n_width;
	}

  return ($scale,$gd_width,$gd_height,$startx,$starty); 
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub area {				# define click area for maps
   my $short = shift;
   my $name = shift;
   my $value = shift;
   my $drill_id = shift;
   my $id = shift;
   my $scale = shift;
   my $startx = shift;
   my $starty = shift;
   my $points = shift;
   my $coords;

   foreach ( @@{$points} ) {
    # $coords .= ( ($_->[0] * $scale) + ( $startx * $scale ) ).",".( ($_->[1] * $scale) + ( $starty * $scale )).",";
    $coords .= sprintf('%d,%d,', ($_->[0]+$startx)*$scale, ($_->[1]+$starty)*$scale);	# trochu jsem to zde srovnal: HTML s klikaci mapou je ted tretinove :)  --MD
   }
   chop $coords;
#	 my $maparea = "
#                <Area Shape=poly
#                        Coords=\"$coords\"
#                        Href=\"javascript:alert(' $name : $value ! ');\"
#                        Title=\"$name\"
#                        Alt=\"x=1st   y=1\"
#                        onMouseOver=\"window.status='$value'; return true;\"
#                        onMouseOut=\"window.status=''; return true;\"
#                >
#              ";

   if ( $name ne $short ) {
   	return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $name - $short : $value ! ');\" \n Title=\"$name - $short : $value\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'$drill_id')\" \n id=\"$id\">\n";
   }
   else {
   	return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $short : $value ! ');\" \n Title=\"$short : $value\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'$drill_id')\" \n id=\"$id\">\n";
   }

#return $maparea;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub start { 	# convert start position to standard unit 
  my $start = shift;
  my $lu = shift;	# left upper start point  

  if ( $start =~ s/cm// ) {
     $start = 1000 * $start;
  }
  $start = $start - $lu;

  return $start; 
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub contextMenu {
	my $dataset_links = shift;
	my $variables = shift;
	my @@objectLinks;
	my @@links;
	my $links;
	foreach my $ID (keys %{$dataset_links}) {
		#undef @@links;
		#foreach (keys %{$$dataset->{links}{$ID}{current}}) {
		#	push(@@links,"$$dataset->{links}{$ID}{current}{$_}/$_");
		#}
		#$links = join("|",@@links);
		#push (@@objectLinks,"'current$ID':'$links'");
		undef @@links;
		foreach (keys %{$dataset_links->{$ID}{down}}) {
			push(@@links,"$dataset_links->{$ID}{down}{$_}/$_");
		}
		$links = join("|",@@links);
		push (@@objectLinks,"'down$ID':'$links'");
		undef @@links;
		foreach (keys %{$dataset_links->{$ID}{up}}) {
			push(@@links,"$dataset_links->{$ID}{up}{$_}/$_");
		}
		$links = join("|",@@links);
		push (@@objectLinks,"'up$ID':'$links'");
	}
	$links = join("|",@@{$Const::run->{graph2dExport}});
	push (@@objectLinks,"'export':'$links'");
	#$links = join("|",@@{$Const::run->{sort}});
	#push (@@objectLinks,"'sort':'$links'");
	undef @@links;
	foreach (keys %{$Const::RLang->{ $variables->{useLang} }}) {
		push (@@links,"'$_':'$Const::RLang->{ $variables->{useLang} }{$_}'");
	}
	$links = join(",",@@links);
	my $objectLinks = join(",",@@objectLinks);
	
	return ($objectLinks,$links);
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub order {			## attr "A" must be last array element
	my $attr = shift;
	my $metric = shift;
	my $title = shift;
	my $ids = shift;
	my ($a,$m,$t,$id);

	for (my $i=0;$i < scalar @@{$attr};$i++ ) {
		if ( $attr->[$i] eq "A" ) {
			$a = splice(@@{$attr},$i,1);
			$m = splice(@@{$metric},$i,1);
			$t = splice(@@{$title},$i,1);
			$id = splice(@@{$ids->[0]},$i,1);
		}
	}
	push(@@{$attr},$a);
	push(@@{$metric},$m);
	push(@@{$title},$t);
	push(@@{$ids->[0]},$id);
	
	return ($attr,$metric,$title,$ids);
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub set_fonts {
	my $graph = shift;
	my $graph_map = shift;
	my $form = shift;
	my $attributes = shift;
	my $legend = shift;
	my $fonts_o = shift;
	
		$graph->set_title_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{title}".".ttf",$fonts_o->{title_size}) if ( exists $attributes->{title} );											$graph_map->set_title_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{title}".".ttf",$fonts_o->{title_size}) if ( exists $attributes->{title} );	
		if ($form ne 'pie' and $form ne 'pie3d') {
			$graph->set_legend_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{legend}".".ttf",$fonts_o->{legend_size}) if ( defined $legend );																$graph_map->set_legend_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{legend}".".ttf",$fonts_o->{legend_size}) if ( defined $legend );
			$graph->set_x_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{x_label}".".ttf",$fonts_o->{x_label_size}) if ( exists $attributes->{x_label} );												$graph_map->set_x_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{x_label}".".ttf",$fonts_o->{x_label_size}) if ( exists $attributes->{x_label} );	
			$graph->set_y_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{y_label}".".ttf",$fonts_o->{y_label_size}) if ( exists $attributes->{y_label} );												$graph_map->set_y_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{y_label}".".ttf",$fonts_o->{y_label_size}) if ( exists $attributes->{y_label} );	
			$graph->set_x_axis_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{x_axis}".".ttf",$fonts_o->{x_axis_size}) if ( exists $attributes->{x_plot_values} );											$graph_map->set_x_axis_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{x_axis}".".ttf",$fonts_o->{x_axis_size}) if ( exists $attributes->{x_plot_values} );	
			$graph->set_y_axis_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{y_axis}".".ttf",$fonts_o->{y_axis_size}) if ( exists $attributes->{y_plot_values} );											$graph_map->set_y_axis_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{y_axis}".".ttf",$fonts_o->{y_axis_size}) if ( exists $attributes->{y_plot_values} );	
			$graph->set_values_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{values}".".ttf",$fonts_o->{values_size}) if ( exists $attributes->{x_plot_values} or exists $attributes->{y_plot_values} );	$graph_map->set_values_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{values}".".ttf",$fonts_o->{values_size}) if ( exists $attributes->{x_plot_values} or exists $attributes->{y_plot_values} );
		}
		else {
			$graph->set_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{label}".".ttf",$fonts_o->{label_size}) if ( exists $attributes->{label} );														$graph_map->set_label_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{label}".".ttf",$fonts_o->{label_size}) if ( exists $attributes->{label} );	
			$graph->set_value_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{value}".".ttf",$fonts_o->{value_size}) ;																						$graph_map->set_value_font("$Const::myPath$Const::trueTypeFontPath/$fonts_o->{value}".".ttf",$fonts_o->{value_size}) ;
		}
	
	return ($graph,$graph_map);	
}
#--------------------------------------------------------------------------------------------------------------------------------------
1;
@


1.54
log
@changed objects to entities
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.53 2004/04/22 16:01:45 vacula Exp $
d55 2
a56 2

		my ( $x_label, $y_label, $drill_id, $ids, $legend, $data ) = Graph2d_grid::data( $dataset, $style->{base}->{sets} );
a64 1

d116 1
d118 9
a126 2
		my $bgclr = defined $attributes_map{"bgclr"} ? $image->colorAllocate( split(/,/,$attributes_map{"bgclr"}) ) : $image->colorAllocate(split(/,/,$report->{bgcolor}));
		$image->transparent($bgclr);
d212 1
a212 1
	    push(@@data,Graph2d_report::rgb2hexa($r,$g,$b));
@


1.53
log
@some subroutines moved to files
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.52 2004/04/22 11:32:15 vacula Exp $
d68 1
a68 1
		my ($dclrs,$types,$default_type) = objects($style->{objects}->{data});
d116 1
a116 1
		my $colors = $style->{objects}{colors}; 
d119 1
a119 1
		
@


1.52
log
@fix couple attributes of graph
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.51 2004/04/19 16:41:24 vacula Exp $
d11 3
d49 1
a49 1
	my $report = report($obj,$variables);
d56 5
a60 87
		my ( $x_label, $y_label, $drill_id, $ids, $legend, $data ) = data( $dataset, $style->{base}->{sets} );
		my ( @@hrefs, @@lhrefs, @@contexts, @@drills );	

		if ( $style->{form} eq 'bars' or $style->{form} eq 'points' or $style->{form} eq 'linespoints' ) {
			for ( my $i=0; $i < (scalar @@{$data})-1; $i++ ) {
		    		my ( @@hfs, @@cts, @@drs );
		    		for ( my $j=0; $j < @@{$data->[0]}; $j++ ) {
		        		push(@@hfs,"javascript:alert('x : $data->[0][$j] \n y : $data->[$i+1][$j]\n')");
		        		push(@@cts,"return showMenu(this,'$drill_id')");
					push(@@drs,$ids->[$i][$j]);
		    		}
		    		push(@@{$hrefs[$i]},@@hfs);
				push(@@{$contexts[$i]},@@cts);
				push(@@{$drills[$i]},@@drs);
				push(@@lhrefs,"javascript:alert('$legend->[$i]')");
			}
		}	
		elsif ( $style->{form} eq 'lines' or $style->{form} eq 'area' ) {
			for ( my $i=0; $i < (scalar @@{$data})-1; $i++ ) {
		    		my ( @@hfs, @@cts, @@drs );
		    		for ( my $j=0; $j < @@{$data->[0]}; $j++ ) {
		        		push(@@hfs,"javascript:alert('x : $data->[0][$j] \n y : $data->[$i+1][$j]\n')");
		        		push(@@cts,"return showMenu(this,'$drill_id')");
					push(@@drs,$ids->[$i][$j]);
		    		}
		    		push(@@{$hrefs[$i]},@@hfs);
				push(@@{$contexts[$i]},@@cts);
				push(@@{$drills[$i]},@@drs);
				push(@@lhrefs,"javascript:alert('$legend->[$i]')");
			}
=block
			for ( my $i=0; $i < (scalar @@{$data})-1; $i++ ) {
				push(@@contexts,"return showMenu(this,'$drill_id')");
				push(@@lhrefs,"javascript:alert('$legend->[$i]')");
			}
			for ( my $i=0; $i < (scalar @@{$data})-1; $i++ ) {
		    		my ( @@hfs, @@drs );
		    		for ( my $j=0; $j < @@{$data->[0]}; $j++ ) {
		        		push(@@hfs,"javascript:alert('x : $data->[0][$j] \n y : $data->[$i+1][$j]\n')");
					push(@@drs,$ids->[$i][$j]);
		    		}
		    		push(@@{$hrefs[$i]},@@hfs);
				push(@@{$drills[$i]},@@drs);
			}
=cut
		}
		elsif ( $style->{form} eq 'pie' or $style->{form} eq 'pie3d' ) {
	    	  	for ( my $i=0;$i<@@{$data->[0]};$i++ ) {
	        	    push(@@hrefs,"javascript:alert('$data->[0][$i]\n')");
		       	    push(@@contexts,"return showMenu(this,'$drill_id')");
		    	}
			for ( my $i=0; $i < (scalar @@{$data})-1; $i++ ) {
		    		my ( @@drs );
		    		for ( my $j=0; $j < @@{$data->[0]}; $j++ ) {
					push(@@drs,$ids->[$i][$j]);
		    		}
				push(@@{$drills[$i]},@@drs);
			}

			@@lhrefs = ();
		}
		if ( $style->{form} eq 'area' or $style->{form} eq 'lines' ) {		## for cascade drawing attributes (lines and areas)
			my ($sortData,$sortLegend);
			my @@moas=(); 													## moas = maximum of attributes
			my @@x = shift(@@{$data});
			for ( my $i=0; $i < @@{$data}; $i++) {
				my $max = $data->[$i][0];
				for ( my $j=0; $j < @@{$data->[0]}; $j++ ) {
					if ( $max < $data->[$i][$j] ) {
						$max = $data->[$i][$j];
					}
				}
				$moas[$i] = $max;
			}
			
			my @@sortMoas = sort {$b<=>$a} @@moas;
			for ( my $i=0; $i < @@sortMoas; $i++ ) {
				for ( my $j=0; $j<@@moas;$j++ )  {
					if ( $sortMoas[$i] == $moas[$j]) {
						$sortData->[$i] = $data->[$j];
						$sortLegend->[$i] = $legend->[$j] ;
					}
				}
			}
			unshift(@@{$sortData},@@x);
			$data = $sortData;
			$legend = $sortLegend;
d62 1
d66 3
a68 3
		my %attributes = defineAttr($style, $report->{lname}, \$x_label, \$y_label, \$legend);
		my $fonts = defineFonts($style);
		my ($dclrs,$types,$default_type) = objects($style->{objects}->{datas});
d82 2
a83 2
		print RT htmlHead($$variables,$css);
		print RT htmlBody($$variables,$report);
d88 1
a88 1
			my $map = new GD::Graph::Map($graph_map, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, drills=> \@@drills, );
d94 1
a94 1
		print RT htmlTableGraph($$variables,$report,$style,\%attributes,$img,$x_label);
d104 2
a105 2
		my ($metric,$attr,$title,$header,$drill_id,$ids) = mapdata( $dataset, $style->{base}->{sets} );
		my %attributes_map = defineAttrMap($style);
d125 1
a125 1
			if ( exists $maplist->{layer}{$layer_id}{object}{$attr->[$i]} ) {
d141 1
a141 1
		foreach ( keys %{$maplist->{layer}{$layer_id}{object}} ) {
d150 2
a151 2
		print RT htmlHead($$variables,$css);
		print RT htmlBody($$variables,$report);
d153 1
a153 1
		print RT htmlTableMap($$variables,$report,$colors,$width,$height,$unfiled,\%attributes_map);
a165 416
sub report {			# return hash with id,localized name,description and bgcolor of report 
	my $obj = shift;	
	my $variables = shift;	
	my ($report);		
	
	$report->{id} = each(%{$obj->{report}});
	$report->{lname} = &Local::LocalizedObj($obj->{report}{$report->{id}}{name}, $report->{id}, lc($$variables->{useLang}), $$variables->{defaultLang});
	$report->{description} = ($obj->{report}{$report->{id}}{description} =~ /HASH/)  ? $obj->{report}{$report->{id}}{description}{lc($$variables->{useLang})} : $obj->{report}{$report->{id}}{description};
	$report->{bgcolor} = '255,255,255';
	
	return $report;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub data {				# # from dataset extract datas an labels for graph 
	my $dataset = shift;
	my $datasheet = shift;

	if ( scalar @@{$$dataset->{col}} == 0 ) {
		if ( exists $$dataset->{colHeader} ) {
			$$dataset->{col}[0] = ["$$dataset->{colHeader}{0}{name}|$$dataset->{colHeader}{0}{id}"] ;
		}
		else {
			foreach ( keys %{$$dataset->{rowHeader}} ) {
				if ( $$dataset->{rowHeader}{$_}{id} eq '-METRICS-' ) {
					$$dataset->{col}[0] = ["$$dataset->{rowHeader}{$_}{name}|$$dataset->{rowHeader}{$_}{id}"];
				}
			}	
		}
	}
	if ( scalar @@{$$dataset->{row}} == 0 ) {
		if ( exists $$dataset->{rowHeader} ) {
			$$dataset->{row}[0] = ["$$dataset->{rowHeader}{0}{name}|$$dataset->{rowHeader}{0}{id}"] ;
		}
		else {
			foreach ( keys %{$$dataset->{colHeader}} ) {
				if ( $$dataset->{colHeader}{$_}{id} eq '-METRICS-' ) {
					$$dataset->{row}[0] = ["$$dataset->{colHeader}{$_}{name}|$$dataset->{colHeader}{$_}{id}"];
				}
			}	
		}
	}
	
	my ($id_row,$at_row,@@datarow) = joinDataset(\$$dataset->{row}) ;
	my ($id_col,$at_col,@@datacol) = joinDataset(\$$dataset->{col}) ;

	my ( @@data, $legend, @@lhrefs, $x_label, $y_label ,$drill, @@ids_col, @@ids_row, @@ids, );

	for (my $i=0;$i < @@{$id_col};$i++ ) {
	     my @@elements = split(/\t/,$id_col->[$i]);
	     push(@@ids_col,$elements[$#elements]);
	}
	for (my $i=0;$i < @@{$id_row};$i++ ) {
	     my @@elements = split(/\t/,$id_row->[$i]);
	     push(@@ids_row,$elements[$#elements]);
	}

	my (@@rowHeader,@@colHeader);
	foreach ( keys(%{$$dataset->{rowHeader}}) ) {
	     push(@@rowHeader,$_);
	}
	foreach ( keys(%{$$dataset->{colHeader}}) ) {
	     push(@@colHeader,$_);
	}
	my @@sortHeaderR = sort {$a<=>$b} @@rowHeader;
	my @@sortHeaderC = sort {$a<=>$b} @@colHeader;

	if ( $datasheet eq 'rows' ) {
	   if ( scalar(@@datacol) == 0 ) {
	   	push(@@datacol,$$dataset->{colHeader}{0}{name});
	   }
	   if ( scalar(@@datarow) == 0 ) {
	   	push(@@datarow,$$dataset->{rowHeader}{0}{name});
	   }
	   for ( my $i=0;$i<@@datarow;$i++ ) {
	       my @@datas;
	       for ( my $j=0;$j<@@datacol;$j++ ) {
	  	   push(@@datas,(exists $$dataset->{c}{$i}{$j}) ? $$dataset->{c}{$i}{$j} : undef);
	       }
	       push(@@{$data[$i]},@@datas);
	   }
	   unshift(@@data,\@@datacol);
	   my $key = 0;
	   foreach ( sort ( keys %{$$dataset->{colHeader}} ) ) {
	      if ( $at_col->[$key] == 0  ) {
	      	 my ($name,$id)	= split(/\|/,$$dataset->{col}[0][$key]);
		 $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name}."(".$name.")" : $$dataset->{colHeader}{$_}{name}."(".$name.")"." ** ";
	      }
	      else {
	      	 $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." ** ";
	      }
	      $key++;
	   }
	   if ( exists $$dataset->{metric} ) {
	       $y_label = $$dataset->{metric};
	   }
	   else {
	   	for ( my $i=0; $i < keys %{$$dataset->{rowHeader}};$i++ ) {
	   		$y_label .= ($i == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$i}{name} : $$dataset->{rowHeader}{$i}{name}." ** ";
	  	}
	   }	 
	   $legend = \@@datarow;
	   $drill = $$dataset->{colHeader}{@@sortHeaderC[$#sortHeaderC]}{id};
	   for ( my $i=0; $i<@@ids_row; $i++ ) {
	   	for ( my $j=0; $j<@@ids_col; $j++ ) {
			$ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
		}
	   }
	   
	}
	if ( $datasheet eq 'cols' ) {
	   if ( scalar(@@datacol) == 0 ) {
	   	push(@@datacol,$$dataset->{colHeader}{0}{name});
	   }
	   if ( scalar(@@datarow) == 0 ) {
	   	push(@@datarow,$$dataset->{rowHeader}{0}{name});
	   }
	   for ( my $i=0;$i<@@datacol;$i++ ) {
	       my @@datas;
	       for ( my $j=0;$j<@@datarow;$j++ ) {
	  	  push(@@datas,(exists $$dataset->{c}{$j}{$i}) ? $$dataset->{c}{$j}{$i} : undef);
	       }
	       push(@@{$data[$i]},@@datas);
	   }
	   unshift(@@data,\@@datarow);
	   my $key = 0;
	   foreach ( sort ( keys %{$$dataset->{rowHeader}} ) ) {
	      if ( $at_row->[$key] == 0  ) {
	      	my ($name,$id)	= split(/\|/,$$dataset->{row}[0][$key]);
	      	$x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name}."(".$name.")" : $$dataset->{rowHeader}{$_}{name}."(".$name.")"." ** ";
	      }
	      else {
	      	$x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." ** ";
	      }
	      $key++;
	   }
	   if ( exists $$dataset->{metric} ) {
	       $y_label = $$dataset->{metric};
	   }
	   else {
	   	for ( my $i=0; $i < keys %{$$dataset->{colHeader}}; $i++ ) {
	      		$y_label .= ($i == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$i}{name} : $$dataset->{colHeader}{$i}{name}." ** ";
	   	}
	   }
	   $legend = \@@datacol;
	   $drill = $$dataset->{rowHeader}{@@sortHeaderR[$#sortHeaderR]}{id};
	   for ( my $i=0; $i<@@ids_col; $i++ ) {
	   	for ( my $j=0; $j<@@ids_row; $j++ ) {
			$ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
		}
	   }

	}

	return ( $x_label, $y_label, $drill, \@@ids, $legend, \@@data, );
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub joinDataset {		# 
	my $dataset = shift;
	my (@@data,@@ids,@@at);

#	if ((exists $$dataset->[0])&&( scalar @@{$$dataset->[0]} > 1 )) {
	if ( scalar @@{$$dataset} != 0 ) {
#	if ( exists $$dataset->[0] ) {
		if ( scalar @@{$$dataset->[0]} > 1 ) {
			for ( my $i=0; $i<scalar @@{$$dataset->[0]}; $i++ ) {
				$at[$i] = 0;  my $item = $$dataset->[0][$i];
				for ( my $j=0; $j<scalar @@{$$dataset}; $j++ ) {
	    				if ( $$dataset->[$j][$i] ne $item ) {
						$at[$i] = 1 ;				## draw label of item of attribute
					}
				}	
			}
		}
		else {
			$at[0] = 1;							## if number of items = 1 or less label of item will be drawn
		}
		for ( my $i=0; $i<scalar @@{$$dataset}; $i++ ) {
		    my ($rowItem,$idItem);
		    for ( my $j=0;$j<scalar @@{$$dataset->[$i]};$j++ ){
				my ($name,$id) = split(/\|/,$$dataset->[$i][$j]);
				$idItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $id : $id."\t";
	    			if ( $at[$j] == 1 ) {
	        			$rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $name : $name."**";
	    			}
		    }
		    push(@@data,$rowItem);
		    push(@@ids,$idItem);
		}
		return (\@@ids,\@@at,@@data);
	}

}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub defineAttr {			# define attributes of graph 
	my $style = shift;
	my $title = shift;		# title of graph
	my $x_label = shift;	# pointer to label of x axis
	my $y_label = shift;	# pointer to label of y axis
	my $legend = shift; 	# pointer to legend
	my (%attr);
	my $chart = $style->{form};


#------------------- B A S E --------------------------
	$attr{"t_margin"} = $style->{base}{t_margin};
	$attr{"b_margin"} = $style->{base}{b_margin};
	$attr{"l_margin"} = $style->{base}{l_margin};
	$attr{"r_margin"} = $style->{base}{r_margin};
	if ( $chart=~/^pie$|^pie3d$/ ) {
		$attr{"3d"} = ( $chart eq 'pie' ) ? 0 : 1;
	}
#------------------- L A Y O U T --------------------------
	if ( $chart=~/^bars$|^lines$|^points$|^linespoints$|^area$/ ) {
		$attr{"axis_space"} = $style->{layout}{axis_space};
		$attr{"text_space"} = $style->{layout}{text_space};
		$attr{"transparent"} = $style->{layout}{bg_transparent};
		if ( ! $attr{"transparent"} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{bgclr});
			$attr{"bgclr"} = rgb2hexa($r,$g,$b);
		}
		if ( $style->{layout}{show_boxclr} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{boxclr});
			$attr{"boxclr"} = rgb2hexa($r,$g,$b);
		}
		if ( $style->{layout}{show_axis} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{fgclr});
			$attr{"fgclr"} = rgb2hexa($r,$g,$b);
			if ( $style->{layout}{show_axis_box} ) {
				$attr{"box_axis"} = 1;
			}
			else {
				$attr{"box_axis"} = 0;
			}
		}
		else {
			$attr{"no_axes"} = 1;
		}
		if ( $style->{layout}{show_title} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{title});
			$attr{"textclr"} = rgb2hexa($r,$g,$b);
		}
		if ( $style->{layout}{show_labels} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{labels});
			$attr{"labelclr"} = rgb2hexa($r,$g,$b);
			$attr{"y_label"} = $$y_label;
		}
		else {
			$$x_label = undef;
			$$y_label = undef;
		}
		if ( $style->{layout}{show_axis_labels} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{axislabels});
			$attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
		}
		else {
			$attr{"x_plot_values"} = 0;
			$attr{"y_plot_values"} = 0;
		}
	}
	elsif ( $chart=~/^pie$|^pie3d$/ ) {
		if ( ! $attr{"transparent"} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{bgclr});
			$attr{"bgclr"} = rgb2hexa($r,$g,$b);
		}
		if ( $style->{layout}{show_boxclr} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{boxclr});
			$attr{"boxclr"} = rgb2hexa($r,$g,$b);
		}
		if ( $style->{layout}{show_title} ) {
			my ($r,$g,$b) = split(/,/,$style->{layout}{title});
			$attr{"textclr"} = rgb2hexa($r,$g,$b);
		}		
	}

#------------------- A X I S _ X --------------------------
	if ( $chart=~/^bars$|^lines$|^points$|^linespoints$|^area$/ ) {
		if ( $style->{ax_X}{show_label} ) {
			$attr{"x_label_position"} = $style->{ax_X}{label_position};
			#$fonts{"x_label_font"} = $style->{ax_X}{label_font};		
			#$fonts{"x_label_fontsize"} = $style->{ax_X}{label_fontsize};		
		}
		else {
			$attr{"x_label_position"} = 'NO';
			#$fonts{"x_label_font"} = 'NO';
		}
		if ( $style->{ax_X}{show_axislabel} ) {
			$attr{"x_plot_values"} = 1;
			if ( $style->{ax_X}{axislabel_vertical} ) {
				$attr{"x_labels_vertical"} = 1;
			}
			$attr{"x_label_skip"} = $style->{ax_X}{axislabel_skip};		
			$attr{"x_tick_offset"} = $style->{ax_X}{axislabel_offset} if $attr{"x_label_skip"};		
		}
		else {
			$attr{"x_plot_values"} = 0;
			#$fonts{"x_axis_font"} = 'NO';
		}
		if ( $style->{ax_X}{show_ticks} ) {
			$attr{"x_ticks"} = 1;
			$attr{"x_long_ticks"} = ($style->{ax_X}{long_ticks}) ? 1 : 0;		
			$attr{"x_tick_length"} = $style->{ax_X}{tick_length};		
		}
		else {
			$attr{"x_ticks"} = 0;
		}
	}
	if ( $chart=~/^pie$|^pie3d$/ ) {
		$$x_label = undef;
	}
#------------------- A X I S _ Y --------------------------	
	if ( $chart=~/^bars$|^lines$|^points$|^linespoints$|^area$/ ) {
		if ( $style->{ax_Y}{show_label} ) {
			$attr{"y_label_position"} = $style->{ax_Y}{label_position};
			#$fonts{"y_label_font"} = $style->{ax_Y}{label_font};		
			#$fonts{"y_label_fontsize"} = $style->{ax_Y}{label_fontsize};		
		}
		else {
			$attr{"y_label"} = undef;
			$attr{"y_label_position"} = 'NO';
	#		$fonts{"y_label_font"} = 'NO';
		}
		if ( $style->{ax_Y}{show_axislabel} ) {
			$attr{"y_plot_values"} = 1;
			$attr{"y_tick_number"} = $style->{ax_Y}{tick_number};		
			$attr{"y_label_skip"} = $style->{ax_Y}{axislabel_skip};		
		}
		else {
			$attr{"y_plot_values"} = 0;
	#		$fonts{"y_axis_font"} = 'NO';
		}
		if ( $style->{ax_Y}{show_ticks} ) {
			$attr{"y_long_ticks"} = ($style->{ax_Y}{long_ticks}) ? 1 : 0;		
			$attr{"y_tick_length"} = $style->{ax_Y}{tick_length};		
		}
		else {
			$attr{"y_tick_length"} = 0;
		}
		if ( ! $style->{ax_Y}{'amplitude_compute'} ) {
			$attr{"y_min_value"} = $style->{ax_Y}{amplitude_min};		
			$attr{"y_max_value"} = $style->{ax_Y}{amplitude_max};		
		}
	}
	if ( $chart=~/^pie$|^pie3d$/ ) {
		$$y_label = undef;
	}
#------------------- L E G E N D and L O G O --------------------------	
	if ( $chart=~/^bars$|^lines$|^points$|^linespoints$|^area$/ ) {	
		if ( $style->{legend}{show_legend} ) {
			$attr{"legend_placement"} = $style->{legend}{legend_placement};
			$attr{"legend_spacing"} = $style->{legend}{legend_spacing};
			$attr{"legend_marker_width"} = $style->{legend}{legend_marker_width};
			$attr{"legend_marker_height"} = $style->{legend}{legend_marker_height};
			if ( ! $style->{legend}{cols_compute} ) {
				$attr{"lg_cols"} = ( $style->{legend}{lg_cols} ne "" and $style->{legend}{lg_cols} ne "0" ) ? $style->{legend}{lg_cols} : undef;
			}
		}
		else {
			$$legend = undef;
		}
	}
	if ( $style->{legend}{show_logo} ) {
		$attr{"logo"} = "$Const::myPath"."img/logo/$style->{legend}{src_logo}.". GD::Graph->export_format;
		$attr{"logo_position"} = $style->{legend}{logo_position};
	}
	else {
		$attr{"logo"} = undef;
	}

#------------------- O B J E C T S --------------------------	
	if ( $chart=~/^bars$/ ) {						
		if ( $style->{objects}{show_shadow} ) { 						# shadow of objects currently only for bars
			$attr{"shadow_depth"} = $style->{objects}{shadow_depth};
			my ($r,$g,$b) = split(/,/,$style->{objects}{shadowclr});
			$attr{"shadowclr"} = rgb2hexa($r,$g,$b);
		}
	}

	return %attr;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub defineFonts {
	my $style_o = shift;		# style original 
	my $fonts;

	$fonts->{title} = $Const::fonts->{$style_o->{layout}{title_font}};		# font title of graph for pie and pie3d graphs
	$fonts->{title_size} = $style_o->{layout}{title_fontsize};				# fontsize title of graph for pie and pie3d graphs
	$fonts->{legend} = $Const::fonts->{$style_o->{legend}{legend_font}};
	$fonts->{legend_size} = $style_o->{legend}{legend_fontsize};
	$fonts->{values} = $Const::fonts->{$style_o->{objects}{values_font}};	# values font for axis type graph
	$fonts->{values_size} = $style_o->{objects}{values_fontsize};			# values fontsize for axis type graph
	$fonts->{label} = $Const::fonts->{$style_o->{layout}{title_font}};		# font title of graph for pie and pie3d graphs
	$fonts->{label_size} = $style_o->{layout}{title_fontsize};				# fontsize title of graph for pie and pie3d graphs
	$fonts->{value} = $Const::fonts->{$style_o->{objects}{values_font}};	# value font for pie and pie3d graphs
	$fonts->{value_size} = $style_o->{objects}{values_fontsize};			# value fontsize for pie and pie3d graphs
	$fonts->{x_label} = $Const::fonts->{$style_o->{ax_X}{label_font}};
	$fonts->{x_label_size} = $style_o->{ax_X}{label_fontsize};
	$fonts->{y_label} = $Const::fonts->{$style_o->{ax_Y}{label_font}};
	$fonts->{y_label_size} = $style_o->{ax_Y}{label_fontsize};
	$fonts->{x_axis} = $Const::fonts->{$style_o->{ax_X}{axislabel_font}};
	$fonts->{x_axis_size} = $style_o->{ax_X}{axislabel_fontsize};
	$fonts->{y_axis} = $Const::fonts->{$style_o->{ax_Y}{axislabel_font}};
	$fonts->{y_axis_size} = $style_o->{ax_Y}{axislabel_fontsize};

	return $fonts;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

d196 1
a196 1
	my $datas = shift;
d199 1
a199 1
	foreach my $it_data ( @@{$datas} ) {
d205 1
a205 1
	    push(@@data,rgb2hexa($r,$g,$b));
a213 162
sub rgb2hexa {	# transform rgb to hexa
	return unless @@_ == 3;
	my $color = '#';
	foreach my $cc (@@_) {
	  $color .= sprintf("%02x", $cc);
	}
	return $color;

}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub mapdata {				# from dataset extract datas an labels for map
	my $dataset = shift;
	my $datasheet = shift;

	if ( scalar @@{$$dataset->{col}} == 0 ) {
		if ( exists $$dataset->{colHeader} ) {
			$$dataset->{col}[0] = ["$$dataset->{colHeader}{0}{name}|$$dataset->{colHeader}{0}{id}"] ;
		}
		else {
			foreach ( keys %{$$dataset->{rowHeader}} ) {
				if ( $$dataset->{rowHeader}{$_}{id} eq '-METRICS-' ) {
					$$dataset->{col}[0] = ["$$dataset->{rowHeader}{$_}{name}|$$dataset->{rowHeader}{$_}{id}"];
				}
			}	
		}
	}
	if ( scalar @@{$$dataset->{row}} == 0 ) {
		if ( exists $$dataset->{rowHeader} ) {
			$$dataset->{row}[0] = ["$$dataset->{rowHeader}{0}{name}|$$dataset->{rowHeader}{0}{id}"] ;
		}
		else {
			foreach ( keys %{$$dataset->{colHeader}} ) {
				if ( $$dataset->{colHeader}{$_}{id} eq '-METRICS-' ) {
					$$dataset->{row}[0] = ["$$dataset->{colHeader}{$_}{name}|$$dataset->{colHeader}{$_}{id}"];
				}
			}	
		}
	}

	my ($id_row,@@datarow) = joinDataset(\$$dataset->{row}) ;
	my ($id_col,@@datacol) = joinDataset(\$$dataset->{col}) ;
	
	my ( @@rowHeader, @@colHeader, @@ids_col, @@ids_row  );
	for (my $i=0;$i < @@{$id_col};$i++ ) {
	     my @@elements = split(/\t/,$id_col->[$i]);
	     push(@@ids_col,$elements[$#elements]);
	}
	for (my $i=0;$i < @@{$id_row};$i++ ) {
	     my @@elements = split(/\t/,$id_row->[$i]);
	     push(@@ids_row,$elements[$#elements]);
	}
	foreach ( keys(%{$$dataset->{rowHeader}}) ) {
	     push(@@rowHeader,$_);
	}
	foreach ( keys(%{$$dataset->{colHeader}}) ) {
	     push(@@colHeader,$_);
	}
	my @@sortHeaderR = sort {$a<=>$b} @@rowHeader;
	my @@sortHeaderC = sort {$a<=>$b} @@colHeader;

	my (@@metric,@@attr,@@title,$header,$drill,@@ids);
	if ( $datasheet eq 'rows' ) { 
		$header = $$dataset->{rowHeader}{@@sortHeaderR[$#sortHeaderR]}{id};
		for ( my $i=0;$i < @@{$$dataset->{row}};$i++ ) {
			push(@@metric,$$dataset->{c}{$i}{0});
			my ($at_short,$id_s) = split(/\|/,$$dataset->{row}[$i][$#sortHeaderR]); 
			#push(@@attr, ($at_short ne '') ? $at_short : $id_s);
			push(@@attr,$at_short);
			my ($at_name,$id_n) = split(/\|/,$$dataset->{row}[$i][$#sortHeaderR-1]); 
			my $title;
			if ( $id_s eq $id_n ) {
				$title = ($at_name ne '') ? $at_name : $id_n ;
			}
			else {
				$title = ($at_short ne '') ? $at_short : $id_s;
			}
			push(@@title,$title);
		}
		$drill = $$dataset->{rowHeader}{@@sortHeaderR[$#sortHeaderR]}{id};

		for ( my $i=0; $i<@@ids_col; $i++ ) {
	   	     for ( my $j=0; $j<@@ids_row; $j++ ) {
			     $ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
			     #$ids[$i][$j] = "c.$#sortHeaderC|*,r.$#sortHeaderR|*";
		     }
		}
	}

	if ( $datasheet eq 'cols' ) { 
		my (@@colHeader,@@sortHeader);
		foreach ( keys(%{$$dataset->{colHeader}}) ) {
			push(@@colHeader,$_);
		}
		@@sortHeader = sort {$a<=>$b} @@colHeader;
		$header = $$dataset->{colHeader}{@@sortHeader[$#sortHeader]}{id};
		for ( my $i=0;$i < @@{$$dataset->{col}};$i++ ) {
			push(@@metric,$$dataset->{c}{0}{$i});
			my ($at_short,$id_s) = split(/\|/,$$dataset->{col}[$i][$#sortHeader]); 
			#push(@@attr, ($at_short ne '') ? $at_short : $id_s);
			push(@@attr,$at_short);
			my ($at_name,$id_n) = split(/\|/,$$dataset->{col}[$i][$#sortHeader-1]); 
			my $title;
			if ( $id_s eq $id_n ) {
				$title = ($at_name ne '') ? $at_name : $id_n ;
			}
			else {
				$title = ($at_short ne '') ? $at_short : $id_s;
			}
			push(@@title,$title);
		}
		$drill = $$dataset->{colHeader}{@@sortHeaderC[$#sortHeaderC]}{id};
		for ( my $i=0; $i<@@ids_row; $i++ ) {
	   	     for ( my $j=0; $j<@@ids_col; $j++ ) {
			     $ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
			     #$ids[$i][$j] = "c.$#sortHeaderC|*,r.$#sortHeaderR|*";
		     }
		}

	}

	return ( \@@metric,\@@attr,\@@title, $header, $drill, \@@ids );

}


#--------------------------------------------------------------------------------------------------------------------------------------------

sub defineAttrMap {
	my $style_o = shift;
	my %attrMap;

#------------------- B A S E --------------------------
	$attrMap{"t_margin"} = $style_o->{base}{t_margin};
	$attrMap{"b_margin"} = $style_o->{base}{b_margin};
	$attrMap{"l_margin"} = $style_o->{base}{l_margin};
	$attrMap{"r_margin"} = $style_o->{base}{r_margin};

#------------------- L A Y O U T --------------------------
	if ( ! $style_o->{layout}{bg_transparent} ) {
		$attrMap{"bgclr"} = $style_o->{layout}{bgclr};
	}
	else {
		$attrMap{"bgclr"} = undef;
	}
	if ( $style_o->{layout}{show_boxclr} ) {
		my ($r,$g,$b) = split(/,/,$style_o->{layout}{boxclr});
		$attrMap{"boxclr"} = rgb2hexa($r,$g,$b);
	}
	if ( $style_o->{layout}{show_title} ) {
		my ($r,$g,$b) = split(/,/,$style_o->{layout}{title});
		$attrMap{"titleclr"} = rgb2hexa($r,$g,$b);
	}		

#------------------- L A Y O U T --------------------------
	
	return %attrMap;
}

#--------------------------------------------------------------------------------------------------------------------------------------------

d215 2
a216 1
	my $file = shift.".xml";
a420 313
sub htmlHead {				# return html head of report 
	my $variables = shift;
	my $css = shift;
	my $htmlHead = "";
	
	if ( exists $variables->{export} ) {	#  print head for export format
		$htmlHead .= &Local::customHTMLHead(0,0,$variables->{useEnc},$Const::languages->{ $variables->{useLang} }->{lang},'Report Result');
	}
	else {
		$htmlHead .= &Local::customHTMLHead(0,0,$variables->{useEnc},$Const::languages->{ $variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$variables->{skinPath}menu.css');</style>");
	}
	
	return $htmlHead;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub htmlBody {				# return html body of report 
	my $variables = shift;		# 
	my $report = shift;		# 
	my $htmlBody = "";
	
	if ( exists $variables->{export} ) {	# print html 3.2 for export function in HtmlDoc else print html 4
		my ($r,$g,$b) = split(/,/,$report->{bgcolor});
		my $bgcolor = rgb2hexa($r,$g,$b);
		$htmlBody .= "<body bgcolor=\"$bgcolor\">";
	}
	else {
			my $all = "item_id=$variables->{orig_id}&Lang=$variables->{useLang}&Did=$variables->{id}&Skin=$variables->{skin}&Proj=$variables->{proj}";
			$htmlBody .= "
<body onload=\"init_menu()\" onclick=\"hideAllMenus()\" style=\"background-color: rgb($report->{bgcolor})\" >
<input type=\"hidden\" value=\"$variables->{orig_id}\" id=\"ID\" name=\"item_id\" />
<input type=\"hidden\" value=\"$variables->{id}\" id=\"DID\" name=\"derivated_id\" />
<input type=\"hidden\" value=\"$variables->{useLang}\" id=\"LANG\" name=\"lang\" />
<input type=\"hidden\" value=\"$all\" id=\"ALL\" />
<input type=\"hidden\" value=\"$variables->{skin}\" id=\"SKIN\" name=\"skin\" />
<div class=\"Menu\" id=\"userMenu\" style=\"display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:5;\"  onmouseover=\"hideSubmenus()\"></div>
<div class=\"Menu\" id=\"userSubMenu\" style=\"display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:6;\"></div>
<iframe width='1' height='1' frameborder='0' srolling='no' src='' style='display:none' id='EXPRT'></iframe>
";
	}
	
	return $htmlBody;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub htmlTableGraph {				## return complete html table with all parts in page of graph
use Encode;
	my $variables = shift;
	my $report = shift;
	my $style_o = shift;
	my $attributes = shift;
	my $img = shift;
	my $x_label = shift;
	my $table = "";
	my $exportAction = exists $variables->{export};
	my $x_label_html = str2htmltable($x_label,$style_o->{ax_X}{label_font},$style_o->{ax_X}{label_fontsize},$attributes,$exportAction);

	if ( $exportAction ) {
		$table .= "
<table  border=\"0\" width=\"$style_o->{base}->{width}\">
 <tr> 
      <td width=\"100%\" align=\"center\"> <font family=\"$style_o->{layout}{title_font}\" size=\"$style_o->{layout}{title_fontsize}\" color=\"$attributes->{textclr}\"> <b> $report->{lname} </b> </font></td> 
 </tr>
 <tr> 
     <td width=\"100%\" align=\"center\"> <font family=\"$style_o->{layout}{title_font}\" size=\"$style_o->{layout}{title_fontsize}\" color=\"$attributes->{textclr}\"> $report->{description} </font></td> 
 </tr>
 <tr> 
     <td> <img Src=\"$report->{id}-$variables->{useLang}.$Const::format2DReport\"> </td>
 </tr> 
 <tr> 
     <td align=\"$attributes->{x_label_position}\" >  $x_label_html </font> </td> 
 </tr>
</table>
			  ";
	}
	else {
		$table .= "
<table style=\"width:$style_o->{base}->{width};border:0;font-size:12\" >
 <tr> 
     <td style=\"font-family:$style_o->{layout}{title_font}; font-size:$style_o->{layout}{title_fontsize}; text-align:center;color:$attributes->{textclr};width=100%\"> <b>$report->{lname}</b> </td> 
 </tr>
 <tr> 
     <td style=\"font-family:$style_o->{layout}{title_font}; font-size:$style_o->{layout}{title_fontsize}; text-align:center;color:$attributes->{textclr};width=100%\"> $report->{description} </td>
 </tr>
 <tr> 
     <td style=\"text-align:center\">  $img  </td> 
 </tr> 
 <tr> 
     <td style=\"text-align:center\"> $x_label_html </td> 
 </tr>
</table>
			  ";
	}
	return $table;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub htmlTableMap {			## return complete html table with all parts in page of map
	my $variables = shift;
	my $report = shift;
	my $colors = shift;
	my $width = shift;
	my $height = shift;
	my $unfiled = shift;
	my $attributes_map_o = shift;
	
	my $exportAction = exists $variables->{export};
	my $map_legend = map_legend( $exportAction, $colors, $report->{bgcolor} );
	my $map_unfiled = map_unfiled( $exportAction, $unfiled, $report->{bgcolor} );
	my $table = "";

	if ( $exportAction ) {
		$table .= "
<table width=\"100%\" border=\"0px\" >
 <tr> 
     <td width=\"$width\" align=\"center\"> <h4>$report->{lname}</h4> </td> 
     <td align=\"center\" rowspan=\"6\"> $map_legend </td> 
 </tr>
 <tr> 
     <td width=\"$width\" align=\"center\"> <h6>$report->{description}</h6> </td> 
 </tr>
 <tr> 
     <td width=\"$width\" align=\"center\"> <Img UseMap=\"#mapa\" Src=\"$report->{id}-$variables->{useLang}.$Const::format2DReport\" border=0 Height=$height Width=$width > </td> 
 </tr>
 <tr> 
     <td width=\"$width\" align=\"center\"> $map_unfiled </td>  
 </tr> 
</table>
			  ";
	}
	else {
		$table .= "
<table style=\"width:100%;border:0px\" >
 <tr> 
     <td style=\"text-align:center;width:$width\"> <h4>$report->{lname}</h4> </td> 
     <td style=\"text-align:center;border:50px solid rgb($report->{bgcolor})\" rowspan=\"4\"> $map_legend </td> 
 </tr>
 <tr> 
     <td style=\"text-align:center;width:$width\"> <h6>$report->{description}</h6> </td> 
 </tr>
 <tr> 
     <td style=\"align:center;width:$width;\"> <Img UseMap=\"#mapa\" Src=\"graph2D.cgi?id=$report->{id}-$variables->{useLang}.$Const::format2DReport\" border=0 Height=$height Width=$width > </td> 
 </tr>
 <tr> 
     <td style=\"text-align:center;width:$width\"> $map_unfiled </td>  
 </tr> 
</table>
			  ";
	}
	return $table;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub str2htmltable { 	# convert string with contains ** to table -> ** means end of row (for example a**b return table with 2 rows: a,b )
	my $str = shift;
	my $font_family = shift;
	my $font_size = shift;
	my $attributes = shift;
	my $exportAction = shift;
	my @@strings = split(/\*\*/,$str);
	my $table = "";
	if ($attributes->{x_label_position} ne 'NO') {
		if ($exportAction) {
			foreach ( @@strings ) {
				$table.= "<tr> <td width=\"100%\" align=\"$attributes->{x_label_position}\"><font color=\"$attributes->{labelclr}\"> $_ </font></td> </tr>";
			}
		}
		else {
			foreach ( @@strings ) {
				$table.= "<tr> <td style='font-family:$font_family; font-size:$font_size; text-align:$attributes->{x_label_position};color:$attributes->{labelclr};width=100%;padding:0px 0px 0px $attributes->{l_margin}px'> $_ </td> </tr>";
				#$table.= "<tr> <td style='text-align:center;color:$color;width=100%' onContextMenu=\"return showMenu(this,'pohyb')\" > $_ </td> </tr>";
			}
		}
	}
	else {
		$table.= "<tr> <td width=\"100%\">&nbsp;</td> </tr>"
	}
	return $table;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub map_legend {			## get array, where are defined range of attributes and corresponded color ; return html table 
	my $exportAction = shift;	## 
	my $map_colors = shift;		## hash , which contains array with definition ranges and colors
	my $bgclr = shift;		## background color of document report
	#my $map_colors = $style->{objects}{colors}; ## 'colors' => [['1000','0,0,0'],['10000','79,90,145']],
	my ($map_colors_revers,@@ranges);	
	my $legend = "";
	

	for ( my $i=0; $i < scalar @@{$map_colors} ; $i++ ) {
#		$map_colors_revers->[(scalar@@{$map_colors}-1) - $i] = $map_colors->[$i];
		$ranges[$i] = $map_colors->[$i][0];
	}
	my @@sortRanges = sort {$b<=>$a} @@ranges;
	
	for ( my $i=0; $i < scalar @@sortRanges ; $i++ ) {
		for ( my $j=0; $j < scalar @@sortRanges; $j++ ) {
			if ( $sortRanges[$i] == $map_colors->[$j][0]) {
				$map_colors_revers->[$i] = $map_colors->[$j];
			}
		}
	}

	if ( $exportAction ) { 
		$legend .= " <table width=\"100%\" border=\"0px\" align=\"center\" cellspacing=\"2px\" >";
		foreach  ( @@{$map_colors_revers} ) {
			#$legend = $_->[0];
			my($r,$g,$b) = split(/,/,$_->[1]);
			my $color = rgb2hexa($r,$g,$b);
			$legend .= "
 <tr>
     <td title='' bgcolor=\"$color\" width=\"25px\">&nbsp;</td>
     <td align=\"left\" >  < $_->[0]</td>
 </tr>
				   ";
		}
	}
	else {
		$legend .= " <table style=\"width:100%;border:0px;text-align:center\">";
		foreach  ( @@{$map_colors_revers} ) {
			#$legend = $_->[0];
			my($r,$g,$b) = split(/,/,$_->[1]);
			$legend .= "
 <tr>
     <td title='' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($bgclr)'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
     <td style='text-align:left;border:2px solid rgb($bgclr)'>  < $_->[0]</td>
 </tr>
				    ";
		}
	}
	$legend .= "
 </table>";
	
	return $legend;
}

#--------------------------------------------------------------------------------------------------------------------------------------

sub map_unfiled {			## get attr and corresponded color , return html table
	my $exportAction = shift;
	my $unfiled = shift;		## hash with definitions attributes, which are not in xml file of map 
	my $bgclr = shift;		## background color of document report
	
	my $table = "
";
	
	my $row = 0;
	if ( $exportAction ) {
		$table .= " <table  width=\"100%\" border=\"0px\" align=\"left\" cellspacing=\"2px\" >";
		foreach ( keys (%{$unfiled}) ) {
			my $color = rgb2hexa($unfiled->{$_}{color}[0],$unfiled->{$_}{color}[1],$unfiled->{$_}{color}[2]);
			if ( $row%3 == 0 and $row == 0) {
				$table .= "
 <tr> 
     <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" bgcolor=\"$color\" width=\"25px\" > &nbsp; </td>
     <td align=\"left\" > $unfiled->{$_}{title} </td>
			 		  ";
			}
			elsif ( $row%3 == 0 and $row != 0 ) {
				$table .= "
 </tr>
 <tr> 
     <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" bgcolor=\"$color\" width=\"25px\" > &nbsp; </td>
     <td align=\"left\" > $unfiled->{$_}{title} </td>
			 		  ";
			}
			else {
				$table .= "
    <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" bgcolor=\"$color\" width=\"25px\" > &nbsp; </td>
    <td align=\"left\" > $unfiled->{$_}{title} </td>
					 ";
			}
			$row++;
		}
		$table .= "
 </tr>
			  "; 
	
	}
	else {
		$table .= "<table style=\"width:100%;border:0px\">";
		foreach ( keys (%{$unfiled}) ) {
			if ( $row%3 == 0 ) {
				$table .= "
 </tr>
 <tr> 
     <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" style=\"background-color:rgb($unfiled->{$_}{color}[0],$unfiled->{$_}{color}[1],$unfiled->{$_}{color}[2]);width:25px;border:2px solid rgb($bgclr)\"> </td>
     <td style=\"text-align:left;border:2px solid rgb($bgclr)\"> $unfiled->{$_}{title} </td>
					 ";
			}
			else {
				$table .= "
     <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" style=\"background-color:rgb($unfiled->{$_}{color}[0],$unfiled->{$_}{color}[1],$unfiled->{$_}{color}[2]);width:25px;border:2px solid rgb($bgclr)\"> </td>
     <td style=\"text-align:left;border:2px solid rgb($bgclr)\"> $unfiled->{$_}{title} </td>
					 ";
			}
			$row++;
		} 
	}
	
	$table .= "
 </table>";

	return $table;
}
#--------------------------------------------------------------------------------------------------------------------------------------

@


1.51
log
@fix couple of attributes, added mixed graph
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.50 2004/04/16 15:43:31 vacula Exp $
a42 9
#open TEST,">$Const::myPath/html/data.tst";
#print TEST Dumper($Const::cache2DReport);
#print TEST Dumper($variables);
#print TEST Dumper($q);
#print TEST Dumper($ID);
#print TEST Dumper($obj);
#print TEST Dumper($style);
#print TEST Dumper($dataset);
#close TEST;
d145 1
a145 1
		my %fonts = defineFonts($style);
d149 2
a150 1
		$graph->set( dclrs =>  $dclrs );																													$graph_map->set( dclrs =>  $dclrs  );
d152 1
a152 14
		$graph->set_title_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{title} );														$graph_map->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );	
		if ($style->{form} ne 'pie' and $style->{form} ne 'pie3d') {
			$graph->set_legend(@@{$legend}) if defined $legend;																									$graph_map->set_legend(@@{$legend}) if defined $legend ;
			$graph->set_legend_font("$Const::trueTypeFontPath/times.ttf",9) if ( defined $legend );																$graph_map->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );
			$graph->set_x_label_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{x_label} );												$graph_map->set_x_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_label} );	
			$graph->set_y_label_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{y_label} );												$graph_map->set_y_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_label} );	
			$graph->set_x_axis_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{x_plot_values} );											$graph_map->set_x_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} );	
			$graph->set_y_axis_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{y_plot_values} );											$graph_map->set_y_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_plot_values} );	
			$graph->set_values_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );		$graph_map->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );
		}
		else {
			$graph->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );													$graph_map->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );	
			$graph->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) ;																					$graph_map->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) ;
		}
d183 1
d196 1
a196 1
		my $bgclr = defined $style->{layout}->{bgclr} ? $image->colorAllocate(split(/,/,$style->{layout}->{bgclr})) : $image->colorAllocate(split(/,/,$report->{bgcolor}));
d199 1
a199 1
		($attr,$metric,$title,$ids) = order($attr,$metric,$title,$ids); 
d205 1
a205 1
				# !!! v docasnem reseni musi byt html mapa vykreslena v opacnem poradi, tj. "A" musi byt ve skriptu pred "S"
d210 1
a210 1
				$image->filledPolygon($polyline,$fillclr) ;
d231 1
a231 1
		print RT htmlTableMap($$variables,$report,$colors,$width,$height,$unfiled);
d619 12
a630 1
   
d632 22
d655 1
a655 1
	return %attr;
d837 33
d1127 1
a1127 1
	my $style = shift;
d1133 1
a1133 1
	my $x_label_html = str2htmltable($x_label,$attributes,$exportAction);
d1137 1
a1137 1
<table  border=\"0\" width=\"$style->{base}->{width}\">
d1139 1
a1139 1
      <td width=\"100%\" align=\"center\"> <font color=\"$attributes->{textclr}\"><h3> $report->{lname} </h3> </font></td> 
d1142 1
a1142 1
     <td width=\"100%\" align=\"center\"> <font color=\"$attributes->{textclr}\"><h6>$report->{description}</h6> </font></td> 
d1148 1
a1148 1
     <td align=\"$attributes->{x_label_position}\" > $x_label_html </td> 
d1155 1
a1155 1
<table style=\"width:$style->{base}->{width};border:0;font-size:12\" >
d1157 1
a1157 1
     <td style=\"text-align:center;color:$attributes->{textclr};width=100%\"> <h3>$report->{lname}</h3> </td> 
d1160 1
a1160 1
     <td style=\"text-align:center;color:$attributes->{textclr};width=100%\"> <h6>$report->{description}</h6> </td>
d1166 1
a1166 1
     <td style=\"text-align:center}\"> $x_label_html </td> 
d1183 1
d1220 1
a1220 1
     <td style=\"text-align:center;width:$width\"> <Img UseMap=\"#mapa\" Src=\"graph2D.cgi?id=$report->{id}-$variables->{useLang}.$Const::format2DReport\" border=0 Height=$height Width=$width > </td> 
d1235 2
d1249 1
a1249 1
				$table.= "<tr> <td style='text-align:$attributes->{x_label_position};color:$attributes->{labelclr};width=100%;padding:0px 0px 0px $attributes->{l_margin}px'> $_ </td> </tr>";
d1455 26
@


1.50
log
@changes for new interface
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.49 2004/04/13 12:42:37 michald Exp $
d155 1
d158 2
a159 4
		if ( exists $style->{colors}->{datas} ) {
			my @@dclrs = dclrs($style->{colors}->{datas});
			$graph->set( dclrs =>  \@@dclrs  );																													$graph_map->set( dclrs =>  \@@dclrs  );
		}
d163 1
a163 1
			$graph->set_legend_font("$Const::trueTypeFontPath/times.ttf",9) if ( defined $legend );															$graph_map->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );
d168 1
a168 1
			$graph->set_values_font("$Const::trueTypeFontPath/times.ttf",9) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );	$graph_map->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );
d240 1
a240 1
			my $borderclr = defined $style->{colors}->{borderclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{borderclr})) : $image->colorAllocate(0,0,0);
d251 1
a251 1
		print RT htmlTableMap($$variables,$report,$style,$width,$height,$unfiled);
d473 1
a473 1
#------------------- BASE --------------------------
d478 45
a522 18

#------------------- LAYOUT --------------------------
	$attr{"axis_space"} = $style->{layout}{axis_space};
	$attr{"text_space"} = $style->{layout}{text_space};
	$attr{"transparent"} = $style->{layout}{bg_transparent};
	if ( ! $attr{"transparent"} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{bgclr});
		$attr{"bgclr"} = rgb2hexa($r,$g,$b);
	}
	if ( $style->{layout}{show_boxclr} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{boxclr});
		$attr{"boxclr"} = rgb2hexa($r,$g,$b);
	}
	if ( $style->{layout}{show_axis} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{fgclr});
		$attr{"fgclr"} = rgb2hexa($r,$g,$b);
		if ( $style->{layout}{show_axis_box} ) {
			$attr{"box_axis"} = 1;
d525 2
a526 1
			$attr{"box_axis"} = 0;
d529 46
a574 2
	else {
		$attr{"no_axes"} = 1;
d576 1
a576 10
	if ( $style->{layout}{show_title} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{title});
		$attr{"textclr"} = rgb2hexa($r,$g,$b);
	}
	if ( $style->{layout}{show_labels} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{labels});
		$attr{"labelclr"} = rgb2hexa($r,$g,$b);
		$attr{"y_label"} = $$y_label;
	}
	else {
a577 1
		$$y_label = undef;
d579 32
a610 3
	if ( $style->{layout}{show_axis_labels} ) {
		my ($r,$g,$b) = split(/,/,$style->{layout}{axislabels});
		$attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
d612 2
a613 3
	else {
		$attr{"x_plot_values"} = 0;
		$attr{"y_plot_values"} = 0;
d615 10
a624 16


#------------------- axis_X --------------------------
	if ( $style->{ax_X}{show_label} ) {
		$attr{"x_label_position"} = $style->{ax_X}{label_position};
#		$fonts{"x_label_font"} = $style->{ax_X}{label_font};		
#		$fonts{"x_label_fontsize"} = $style->{ax_X}{label_fontsize};		
	}
	else {
		$attr{"x_label_position"} = 'NO';
#		$fonts{"x_label_font"} = 'NO';
	}
	if ( $style->{ax_X}{show_axislabel} ) {
		$attr{"x_plot_values"} = 1;
		if ( $style->{ax_X}{axislabel_vertical} ) {
			$attr{"x_labels_vertical"} = 1;
d626 2
a627 56
		$attr{"x_label_skip"} = $style->{ax_X}{axislabel_skip};		
		$attr{"x_tick_offset"} = $style->{ax_X}{axislabel_offset} if $attr{"x_label_skip"};		
	}
	else {
		$attr{"x_plot_values"} = 0;
#		$fonts{"x_axis_font"} = 'NO';
	}
	if ( $style->{ax_X}{show_ticks} ) {
		$attr{"x_ticks"} = 1;
		$attr{"x_long_ticks"} = ($style->{ax_X}{long_ticks}) ? 1 : 0;		
		$attr{"x_tick_length"} = $style->{ax_X}{tick_length};		
	}
	else {
		$attr{"x_ticks"} = 0;
	}
	
#------------------- axis_Y --------------------------	
	if ( $style->{ax_Y}{show_label} ) {
		$attr{"y_label_position"} = $style->{ax_Y}{label_position};
#		$fonts{"y_label_font"} = $style->{ax_Y}{label_font};		
#		$fonts{"y_label_fontsize"} = $style->{ax_Y}{label_fontsize};		
	}
	else {
		$attr{"y_label"} = undef;
		$attr{"y_label_position"} = 'NO';
#		$fonts{"y_label_font"} = 'NO';
	}
	if ( $style->{ax_Y}{show_axislabel} ) {
		$attr{"y_plot_values"} = 1;
		$attr{"y_tick_number"} = $style->{ax_Y}{tick_number};		
		$attr{"y_label_skip"} = $style->{ax_Y}{axislabel_skip};		
	}
	else {
		$attr{"y_plot_values"} = 0;
#		$fonts{"y_axis_font"} = 'NO';
	}
	if ( $style->{ax_Y}{show_ticks} ) {
		$attr{"y_long_ticks"} = ($style->{ax_Y}{long_ticks}) ? 1 : 0;		
		$attr{"y_tick_length"} = $style->{ax_Y}{tick_length};		
	}
	else {
		$attr{"y_tick_length"} = 0;
	}
	if ( ! $style->{ax_Y}{'amplitude_compute'} ) {
		$attr{"y_min_value"} = $style->{ax_Y}{amplitude_min};		
		$attr{"y_max_value"} = $style->{ax_Y}{amplitude_max};		
	}
	
#------------------- LEGEND and LOGO --------------------------	
	if ( $style->{legend}{show_legend} ) {
		$attr{"legend_placement"} = $style->{legend}{legend_placement};
		$attr{"legend_spacing"} = $style->{legend}{legend_spacing};
		$attr{"legend_marker_width"} = $style->{legend}{legend_marker_width};
		$attr{"legend_marker_height"} = $style->{legend}{legend_marker_height};
		if ( ! $style->{legend}{cols_compute} ) {
			$attr{"lg_cols"} = ( $style->{legend}{lg_cols} ne "" and $style->{legend}{lg_cols} ne "0" ) ? $style->{legend}{lg_cols} : undef;
a629 3
	else {
		$$legend = undef;
	}
a636 2
	
=pod
d638 4
a641 32
	if ( $chart eq 'bars' or $chart eq 'hbars' or $chart eq 'bars3d') {
	   $attr{"bar_spacing"} = 7;
#	   $attr{"shadowclr"} = rgb2hexa(204,204,204);
	   $attr{"shadowclr"} = rgb2hexa(40,40,40);
	   $attr{"shadow_depth"} = 5; 
	}
	
	if ( $chart ne 'pie'  and  $chart ne 'pie3d'  ) {
	   $attr{"legend_placement"} = 'RT';
	   #$attr{"title"} = $title;
	   #$attr{"x_label"} = $x_label;
	   $attr{"y_label"} = $y_label;
	   $attr{"x_long_ticks"} = (exists $layout->{x_long_ticks}) ? $layout->{x_long_ticks} : 0;
	   $attr{"y_long_ticks"} = (exists $layout->{y_long_ticks}) ? $layout->{y_long_ticks} : 0;
	   $attr{"x_label_position"} = (exists $layout->{x_label_position}) ? $layout->{x_label_position} : 3/4;
	   $attr{"y_label_position"} = (exists $layout->{y_label_position}) ? $layout->{y_label_position} : 3/4;
	   $attr{"x_plot_values"} = (exists $layout->{x_plot_values}) ? $layout->{x_plot_values} : 0;
	   $attr{"y_plot_values"} = (exists $layout->{y_plot_values}) ? $layout->{y_plot_values} : 0;
	   $attr{"x_label_skip"} = (exists $layout->{x_label_skip}) ? $layout->{x_label_skip} : 1;
	   $attr{"y_label_skip"} = (exists $layout->{y_label_skip}) ? $layout->{y_label_skip} : 1;
	   $attr{"x_tick_offset"} = (exists $layout->{x_tick_offset}) ? $layout->{x_tick_offset} : 0;
	   $attr{"x_labels_vertical"} = (exists $layout->{x_labels_vertical}) ? $layout->{x_labels_vertical} : 0;
	   $attr{"axis_space"} = (exists $layout->{axis_space}) ? $layout->{axis_space} : 4;
	   $attr{"text_space"} = (exists $layout->{text_space}) ? $layout->{text_space} : 8;
	   $attr{"overwrite"} = 0;
	   $attr{"cumulate"} = 0;
	}
	else {
	   #$attr{"label"} = $title;
	   $attr{"3d"} = ( $chart eq 'pie' ) ? 0 : 1;
	}
=cut
d676 1
a676 1
sub dclrs { 	# get rgb keys of colors, return array of colors
d678 1
a678 1
	my (@@data,$r,$g,$b);
d680 6
a685 2
	foreach ( @@{$datas} ) {
	    ($r,$g,$b) =  ($_ ne '') ? split(/,/,$_) : split(/,/,"0,0,0");
d688 1
d690 1
a690 1
	return @@data;
d1133 1
a1133 1
	my $style = shift;
d1139 1
a1139 1
	my $map_legend = map_legend( $exportAction, $style, $report->{bgcolor} );
d1215 1
a1215 1
	my $style = shift;		## hash , which contains array with definition ranges and colors
d1217 1
a1217 1
	my $map_colors = $style->{objects}{colors}; ## 'colors' => [['1000','0,0,0'],['10000','79,90,145']],
@


1.49
log
@foundation for N:M relations
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.48 2004/03/17 17:22:10 vacula Exp $
d48 1
d56 3
a58 1
	$report->{bgcolor} = $style->{colors}{bgclr} if ( exists $style->{colors} and defined $style->{colors}{bgclr} ) ;
d60 1
a60 1
	if ( $style->{form} ne 'map' ) {
d125 1
a125 1
			my @@moas=(); 
d150 2
a151 2
		my $chart = "GD::Graph::$style->{form}";															my $chart_map = ( $style->{form} eq 'lines' or $style->{form} eq 'area' ) ? "GD::Graph::linespoints" : "GD::Graph::$style->{form}" ;
		my $graph = $chart->new( $style->{base}->{width}, $style->{base}->{height} );											my $graph_map = $chart_map->new( $style->{base}->{width}, $style->{base}->{height} );
d153 4
a156 3
		my %attributes = defineAttr($style->{form}, $report->{lname}, $x_label, $y_label, $style->{layout}, $style->{colors});

		$graph->set( %attributes ) or die $graph->error; 														$graph_map->set( %attributes ) or die $graph->error;
d159 1
a159 1
			$graph->set( dclrs =>  \@@dclrs  );															$graph_map->set( dclrs =>  \@@dclrs  );
d161 1
a161 1
		$graph->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );								$graph_map->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );	
d163 7
a169 8
			$graph->set_legend(@@{$legend}) ;															$graph_map->set_legend(@@{$legend}) ;
			$graph->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );								$graph_map->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );
			$graph->set_x_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_label} );							$graph_map->set_x_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_label} );	
			$graph->set_y_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_label} );							$graph_map->set_y_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_label} );	
			$graph->set_x_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} );						$graph_map->set_x_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} );	
			$graph->set_y_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_plot_values} );						$graph_map->set_y_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_plot_values} );	
			$graph->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );	$graph_map->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );

d172 2
a173 2
			$graph->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );							$graph_map->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );	
			$graph->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) ;											$graph_map->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) ;
d176 1
a176 1
		my $gd = $graph->plot($data) or die $graph->error;														my $gd_map = $graph_map->plot($data) or die $graph->error;
d205 2
a206 2
		my $maplist = getmap($style->{map}->{use}, "$Const::myPath$Const::graph2Ddefinitions");
		my $zoom = 1;		## if $zoom == 1 -> zoom function is enabled  / $zoom == 0 zoom function is disabled
d215 1
a215 1
		my $colors = $style->{map}{colors}; 
d217 1
a217 1
		my $bgclr = defined $style->{colors}->{bgclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{bgclr})) : $image->colorAllocate(split(/,/,$report->{bgcolor}));
d280 1
a280 1
sub data {
d425 1
a425 1
sub joinDataset {
d464 6
a469 7
sub defineAttr {
	my $chart = shift;
	my $title = shift;
	my $x_label = shift;
	my $y_label = shift;
	my $layout = shift;
	my $colors = shift;
d471 1
d473 48
a520 6
	$attr{"t_margin"} = (exists $layout->{t_margin}) ? $layout->{t_margin} : 0;
	$attr{"b_margin"} = (exists $layout->{b_margin}) ? $layout->{b_margin} : 0;
	$attr{"l_margin"} = (exists $layout->{l_margin}) ? $layout->{l_margin} : 0;
	$attr{"r_margin"} = (exists $layout->{r_margin}) ? $layout->{r_margin} : 0;
	if ( $colors->{transparent} )  {
	   $attr{"transparent"} = 1; 
d523 2
a524 1
	   $attr{"transparent"} = 0; 
d526 87
a612 35
	if ( defined $colors->{bgclr} ) {
	   my ($r,$g,$b) = split(/,/,$colors->{bgclr}); 
	   $attr{"bgclr"} = rgb2hexa($r,$g,$b);
	}
	if (defined $colors->{fgclr}) {
	   my ($r,$g,$b) = split(/,/,$colors->{fgclr});
	   $attr{"fgclr"} = rgb2hexa($r,$g,$b);
	   $attr{"labelclr"} = rgb2hexa($r,$g,$b);
	   $attr{"textclr"} = rgb2hexa($r,$g,$b);
	   $attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
	   $attr{"legendclr"} = rgb2hexa($r,$g,$b);
	}
	if (defined $colors->{labelclr}) {
	   my ($r,$g,$b) = split(/,/,$colors->{labelclr});
	   $attr{"labelclr"} = rgb2hexa($r,$g,$b);
	}
	if (defined $colors->{textclr}) {
	   my ($r,$g,$b) = split(/,/,$colors->{textclr});
	   $attr{"textclr"} = rgb2hexa($r,$g,$b);
	}
	if (defined $colors->{axislabelclr}) {
	   my ($r,$g,$b) = split(/,/,$colors->{axislabelclr});
	   $attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
	   $attr{"legendclr"} = rgb2hexa($r,$g,$b);
	}
	if (defined $colors->{borderclr}) {
	   my ($r,$g,$b) = split(/,/,$colors->{borderclr});
	   $attr{"fgclr"} = rgb2hexa($r,$g,$b);
	}

	$attr{"fgclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{fgclr} );
	$attr{"labelclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{labelclr} );
	$attr{"textclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{textclr} );	   
	$attr{"axislabelclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{axislabelclr} );
	$attr{"legendclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{legendclr} );	   
d645 1
a645 1

d651 1
a651 1
sub writeToSTDOUT {
d680 1
a680 1
sub dclrs {
d694 1
a694 1
sub rgb2hexa {
d706 1
a706 1
sub mapdata {
d823 2
a824 2
sub getmap {
	my $file = shift;
d866 1
a866 1
sub metric2clr {
d893 1
a893 1
sub addPolyline {
d911 1
a911 1
sub myscale {
d975 1
a975 1
sub area {
d1015 1
a1015 1
sub start {
d1076 1
a1076 1
sub htmlTableGraph {				## return complete html table with all parts in page 
d1086 1
a1086 1
	my $x_label_html = str2htmltable($x_label,$attributes->{labelclr},$exportAction);
d1101 1
a1101 1
     <td align=\"center\" > $x_label_html </td> 
d1119 1
a1119 1
     <td style=\"text-align:center\"> $x_label_html </td> 
a1123 1
	
d1129 1
a1129 1
sub htmlTableMap {
d1185 1
a1185 1
sub str2htmltable {
d1187 1
a1187 1
	my $color = shift;
d1191 11
a1201 3
	if ($exportAction) {
		foreach ( @@strings ) {
			$table.= "<tr> <td width=\"100%\" align=\"center\"><font color=\"$color\"> $_ </font></td> </tr>";
d1205 1
a1205 4
		foreach ( @@strings ) {
			$table.= "<tr> <td style='text-align:center;color:$color;width=100%'> $_ </td> </tr>";
			#$table.= "<tr> <td style='text-align:center;color:$color;width=100%' onContextMenu=\"return showMenu(this,'pohyb')\" > $_ </td> </tr>";
		}
a1206 1
	
d1216 1
a1216 1
	my $map_colors = $style->{map}{colors}; ## 'colors' => [['1000','0,0,0'],['10000','79,90,145']],
d1218 2
a1219 2
	my $legend = "
";
@


1.48
log
@set binmode for html with graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.47 2004/02/24 21:01:00 vasekd Exp $
d203 1
a203 1
my $zoom = 1;		## if $zoom == 1 -> zoom function is enabled  / $zoom == 0 zoom function is disabled
@


1.47
log
@Fix of the drill
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.46 2004/02/24 14:49:24 vacula Exp $
d178 1
a178 1

d245 1
d979 1
d989 1
a989 1
	
d994 1
a994 1
      <td width=\"100%\" align=\"center\"> <font color=\"$attributes->{textclr}\"><h3>$report->{lname}</h3> </font></td> 
@


1.46
log
@added id=ALL to input in htmlbody
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.45 2004/02/17 16:45:38 vacula Exp $
d958 2
a959 1
		$htmlBody .= "
@


1.45
log
@minor changes in function metric2clr
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.44 2004/02/17 14:07:27 vacula Exp $
d963 1
@


1.44
log
@fix color in graph map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.43 2004/02/13 16:14:12 vacula Exp $
d226 1
a226 1
				my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i] , $report->{bgcolor} );
d231 1
a231 1
				my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i] , $report->{bgcolor} );
d773 10
a782 2
		foreach ( @@{$$colors} ) {
			if ( $metric < @@{$_}[0] ) {
a783 1
				#last;
@


1.43
log
@fix drawing graph which is defined only 1 attribute and 1 metric
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.42 2004/02/13 16:11:56 vacula Exp $
d776 1
a776 1
				last;
@


1.42
log
@fix drawing graph which is defined only 1 attribute and 1 metric
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.41 2004/02/03 10:48:06 vacula Exp $
a771 8
open TEST,">$Const::myPath/html/data.tst";
print TEST Dumper($colors);
print TEST Dumper($metric);
print TEST Dumper($rgbstr);
#print TEST Dumper($ID);
#print TEST Dumper($style);
#print TEST Dumper($dataset);
close TEST;
@


1.41
log
@fix problem with color and drawing atributes outside map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.40 2004/02/02 14:09:05 vacula Exp $
a105 2


d222 7
a228 7
					$polyline =  addPolyline( $maplist->{layer}{$layer_id}{object}->{$attr->[$i]}->{points}, $startx, $starty, $scale ); 
					# !!! v docasnem reseni musi byt html mapa vykreslena v opacnem poradi, tj. "A" musi byt ve skriptu pred "S"
					$htmlmap .= area($attr->[$#$attr-$i],$title->[$#$attr-$i],$metric->[$#$attr-$i],$drill_id,$ids->[0][$#$attr-$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$#$attr-$i]}{points_clickmap}) if ( exists $maplist->{layer}{$layer_id}{object}{$attr->[$#$attr-$i]} ) ; 
					#$htmlmap .= area($attr->[$i],$title->[$i],$metric->[$i],$drill_id,$ids->[0][$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$i]}{points_clickmap}) ; 
					my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i] , $report->{bgcolor} );
					my $fillclr = $image->colorAllocate($r,$g,$b);
					$image->filledPolygon($polyline,$fillclr) ;
d231 4
a234 4
					my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i] , $report->{bgcolor} );
					$unfiled->{$i}{color} = [$r,$g,$b];
					$unfiled->{$i}{title} = $title->[$i];
					$unfiled->{$i}{metric} = $metric->[$i];
d280 25
d455 1
d611 25
d772 8
@


1.40
log
@fix problem with  colors in map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.39 2004/01/29 16:45:31 vacula Exp $
d226 1
a226 1
					$htmlmap .= area($attr->[$#$attr-$i],$title->[$#$attr-$i],$metric->[$#$attr-$i],$drill_id,$ids->[0][$#$attr-$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$#$attr-$i]}{points_clickmap}) ; 
d727 1
a727 1
				#last;
d1226 1
a1226 1
	
d1232 1
a1232 1
			$id = splice(@@{$ids},$i,1);
d1238 1
a1238 1
	push(@@{$ids},$id);
@


1.39
log
@fix problem with bgcolor in map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.38 2004/01/29 12:49:09 vacula Exp $
d217 4
a223 1
				if ( defined $metric->[$i] ) {
d225 4
a228 2
					$htmlmap .= area($attr->[$i],$title->[$i],$metric->[$i],$drill_id,$ids->[0][$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$i]}{points_clickmap}) ; 
					my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i]);
a230 1
				}
d233 1
a233 2
				if ( defined $metric->[$i] ) {
					my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i]);
a236 1
				}	
d719 10
a728 8
	my $colors = shift;
	my $metric = shift; 
	my $rgbstr = '255,255,255'; 

	foreach ( @@{$$colors} ) {
		if ( $metric < @@{$_}[0] ) {
			$rgbstr = @@{$_}[1];
			last;
d1218 26
@


1.38
log
@modified structure of script,fix export to pdf
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.37 2004/01/23 15:07:39 vacula Exp $
d55 1
a55 1
	$report->{bgcolor} = $style->{colors}->{bgclr} if ( $style->{colors}->{bgclr} ne undef ) ;
d216 1
a216 2
		my $bgclr = defined $style->{colors}->{bgclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{bgclr})) : $image->colorAllocate($report->{bgcolor});

d1052 1
a1052 1
	my ($map_colors_revers);	
d1057 11
a1067 1
		$map_colors_revers->[(scalar@@{$map_colors}-1) - $i] = $map_colors->[$i];
@


1.37
log
@implement zoom to graphs with map, fix export on graphs with map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.36 2004/01/15 03:22:03 michald Exp $
a152 3
#open TEST,">$Const::myPath/html/data.tst";
#print TEST Dumper($$variables->{export});
#close TEST;
d177 1
a177 3
		writeToImg(\$gd, "$report->{id}-$$variables->{useLang}");		## writeToImg(image,name)

		open(RT,">$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
d179 1
a179 2
		my $use_lang = $$variables->{useLang};
		my $use_enc = $$variables->{useEnc};
d181 2
d184 2
a185 25
		my $exportAction = exists $$variables->{export};
		if ($exportAction) {
			print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result');
			print RT "<body>"
		} 
		else {
			print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
			print RT <<END;
<body onload="init_menu()" onclick='hideAllMenus()' style="background-color: rgb($report->{bgcolor})" >
<input type="hidden" value="$$variables->{orig_id}" id="ID" name="item_id" />
<input type="hidden" value="$$variables->{id}" id="DID" name="derivated_id" />
<input type="hidden" value="$$variables->{useLang}" id="LANG" name="lang" />
<input type="hidden" value="$$variables->{skin}" id="SKIN" name="skin" />
<div class="Menu" id="userMenu" style="display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:5;"  onmouseover='hideSubmenus()'></div>
<div class="Menu" id="userSubMenu" style="display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:6;"></div>
<table  style="width:$style->{base}->{width};border:0;font-size:12" >
<tr> <td style="text-align:center;color:$attributes{textclr};width=100%"> <h3>$report->{lname}</h3> </td> </tr>
<tr> <td style="text-align:center;color:$attributes{textclr};width=100%"> <h6>$report->{description}</h6> </td> </tr>
END

			print RT "<iframe width='1' height='1' frameborder='0' srolling='no' src='' style='display:none' id='EXPRT'></iframe>";
		}

		if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$|^pie$|^pie3d$|^area$/ && !$exportAction ) {

d188 1
a188 48
			print RT <<END;
 <tr> 
     <td style="text-align:center"> 
END
	    		print RT $map->imagemap("graph2D.cgi?id=$report->{id}-$$variables->{useLang}.$Const::format2DReport", $data);
			print RT <<END;
     </td> 
 </tr> 
END
			my $export = join("|",@@{$Const::run->{graph2dExport}});

			if (! exists $$variables->{export} ) {	## define context menu 
				my @@objectLinks;
				my @@links;
				my $links;
				foreach my $ID (keys %{$$dataset->{links}}) {
					#undef @@links;
					#foreach (keys %{$$dataset->{links}{$ID}{current}}) {
					#	push(@@links,"$$dataset->{links}{$ID}{current}{$_}/$_");
					#}
					#$links = join("|",@@links);
					#push (@@objectLinks,"'current$ID':'$links'");
					undef @@links;
					foreach (keys %{$$dataset->{links}{$ID}{down}}) {
						push(@@links,"$$dataset->{links}{$ID}{down}{$_}/$_");
					}
					$links = join("|",@@links);
					push (@@objectLinks,"'down$ID':'$links'");
					undef @@links;
					foreach (keys %{$$dataset->{links}{$ID}{up}}) {
						push(@@links,"$$dataset->{links}{$ID}{up}{$_}/$_");
					}
					$links = join("|",@@links);
					push (@@objectLinks,"'up$ID':'$links'");
				}
				$links = join("|",@@{$Const::run->{graph2dExport}});
				push (@@objectLinks,"'export':'$links'");
				#$links = join("|",@@{$Const::run->{sort}});
				#push (@@objectLinks,"'sort':'$links'");
				undef @@links;
				foreach (keys %{$Const::RLang->{ $$variables->{useLang} }}) {
					push (@@links,"'$_':'$Const::RLang->{ $$variables->{useLang} }{$_}'");
				}
				$links = join(",",@@links);
				my $objectLinks = join(",",@@objectLinks);
				print RT "<script type='text/javascript'>var objectLinks = {$objectLinks}; var lang = {$links};</script>";
			}

d191 1
a191 5
			if ($exportAction) {
				print RT "<img src='$report->{id}-$$variables->{useLang}.$Const::format2DReport'>";
			} else {
				print RT "<img src=\"graph2D.cgi?id=$report->{id}-$$variables->{useLang}.$Const::format2DReport\">";	
			}
d193 1
d195 4
a198 5
		my $x_label_html = str2htmltable($x_label,$attributes{labelclr});	# string convert to html table; "**" means end of current row 	
		print RT <<END;
$x_label_html
</table>
END
a200 2


a202 3
		my $use_lang = $$variables->{useLang};
		my $use_enc = $$variables->{useEnc};

a243 2
		my $map_legend = map_legend($style,$report->{bgcolor});
		my $map_unfiled = map_unfiled($unfiled,$report->{bgcolor});
a244 1

d246 4
a249 51

		my $exportAction = exists $$variables->{export};

		if ($exportAction) {
			print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result');
			print RT "<body>"
		}
		else {
			print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
			print RT <<END;
<body onload="init_menu()" onclick='hideAllMenus()' style="background-color: rgb($report->{bgcolor})">
<input type="hidden" value="$$variables->{orig_id}" id="ID" name="item_id" />
<input type="hidden" value="$$variables->{id}" id="DID" name="derivated_id" />
<input type="hidden" value="$$variables->{useLang}" id="LANG" name="lang" />
<input type="hidden" value="$$variables->{skin}" id="SKIN" name="skin" />
<div class="Menu" id="userMenu" style="display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:5;"  onmouseover='hideSubmenus()'></div>
<div class="Menu" id="userSubMenu" style="display:block; position:absolute; top:0px; left:0px; visibility:hidden; z-index:6;"></div>
<table onContextMenu =" return showMenu(this)" style="width:100%;border:0px" >
 <tr> 
     <td style="text-align:center;width:$width"> <h4>$report->{lname}</h4> </td> <td style="text-align:center;border:50px solid rgb($report->{bgcolor})" rowspan="4"> $map_legend </td>  
 </tr>
 <tr> 
     <td style="text-align:center;width:$width"> <h6>$report->{description}</h6> </td> 
 </tr>
END
		print RT "<iframe width='1' height='1' frameborder='0' srolling='no' src='' style='display:none' id='EXPRT'></iframe>";
		}
		my $export = join("|",@@{$Const::run->{graph2dExport}});
		if ($exportAction) {
			print RT <<END;
 <tr> 
     <td style="text-align:center;width:$width"> <Img UseMap="#mapa" Src="$report->{id}-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width > </td> 
 </tr>
END
		} 
		else {
			print RT <<END;
<Map Name=mapa>
$htmlmap
</Map>
 <tr> 
     <td style="text-align:center;width:$width"> <Img UseMap="#mapa" Src="graph2D.cgi?id=$report->{id}-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width > </td> 
 </tr>
END
		}
		print RT <<END;
 <tr> 
     <td style="text-align:center;width:$width"> $map_unfiled </td> 
 </tr> 
</table>
END
d251 1
a251 33
			my @@objectLinks;
			my @@links;
			my $links;
			foreach my $ID (keys %{$$dataset->{links}}) {
				#undef @@links;
				#foreach (keys %{$$dataset->{links}{$ID}{current}}) {
				#	push(@@links,"$$dataset->{links}{$ID}{current}{$_}/$_");
				#}
				#$links = join("|",@@links);
				#push (@@objectLinks,"'current$ID':'$links'");
				undef @@links;
				foreach (keys %{$$dataset->{links}{$ID}{down}}) {
					push(@@links,"$$dataset->{links}{$ID}{down}{$_}/$_");
				}
				$links = join("|",@@links);
				push (@@objectLinks,"'down$ID':'$links'");
				undef @@links;
				foreach (keys %{$$dataset->{links}{$ID}{up}}) {
					push(@@links,"$$dataset->{links}{$ID}{up}{$_}/$_");
				}
				$links = join("|",@@links);
				push (@@objectLinks,"'up$ID':'$links'");
			}
			$links = join("|",@@{$Const::run->{graph2dExport}});
			push (@@objectLinks,"'export':'$links'");
			#$links = join("|",@@{$Const::run->{sort}});
			#push (@@objectLinks,"'sort':'$links'");
			undef @@links;
			foreach (keys %{$Const::RLang->{ $$variables->{useLang} }}) {
				push (@@links,"'$_':'$Const::RLang->{ $$variables->{useLang} }{$_}'");
			}
			$links = join(",",@@links);
			my $objectLinks = join(",",@@objectLinks);
d871 154
d1028 1
d1031 10
a1040 3
	foreach ( @@strings ) {
		$table.= "<tr> <td style='text-align:center;color:$color;width=100%'> $_ </td> </tr>";
		#$table.= "<tr> <td style='text-align:center;color:$color;width=100%' onContextMenu=\"return showMenu(this,'pohyb')\" > $_ </td> </tr>";
d1048 4
a1051 3
sub map_legend {		## get array, where are defined range of attributes and corresponded color ; return html table 
	my $style = shift;
	my $bgclr = shift;	## background color of document report
d1054 2
a1055 1
	my $legend = "<table style=\"width:100%;border:0px;text-align:center\">";
d1061 13
a1073 7
	foreach  ( @@{$map_colors_revers} ) {
		#$legend = $_->[0];
		my($r,$g,$b) = split(/,/,$_->[1]);
		$legend .= "<tr>
				<td title='' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($bgclr)'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
				<td style='text-align:left;border:2px solid rgb($bgclr)'>  < $_->[0]</td>
			    </tr>";
d1075 15
a1089 1
	$legend .= "</table>";
d1096 4
a1099 3
sub map_unfiled {		## get attr and corresponded color , return html table
	my $unfiled = shift;
	my $bgclr = shift;	## background color of document report
d1101 2
a1102 1
	my $html = "<table style=\"width:100%;border:0px\">";
d1105 26
a1130 6
	foreach ( keys (%{$unfiled}) ) {
		if ( $row%3 == 0 ) {
			$html .= "</tr>
				  <tr> <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" style=\"background-color:rgb($unfiled->{$_}{color}[0],$unfiled->{$_}{color}[1],$unfiled->{$_}{color}[2]);width:25px;border:2px solid rgb($bgclr)\"> </td>
				       <td style=\"text-align:left;border:2px solid rgb($bgclr)\"> $unfiled->{$_}{title} </td>
				 ";
d1132 25
a1156 8
		else {
			$html .= "
				  <td title=\"$unfiled->{$_}{title} : $unfiled->{$_}{metric}\" style=\"background-color:rgb($unfiled->{$_}{color}[0],$unfiled->{$_}{color}[1],$unfiled->{$_}{color}[2]);width:25px;border:2px solid rgb($bgclr)\"> </td>
				  <td style=\"text-align:left;border:2px solid rgb($bgclr)\"> $unfiled->{$_}{title} </td>
				 ";
		}
		$row++;
	} 
d1158 2
a1159 1
	$html .= "</table>";
d1161 1
a1161 1
	return $html;
d1165 40
@


1.36
log
@fixing of the bug - Map graph failed if columns are missing
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.35 2004/01/07 10:59:15 vacula Exp $
d33 5
a37 8
	my $variables = shift;
	my $q = shift;
	my $name = shift;
	my $ID = shift;
	
	my $style = shift;
	my $cache_dir = shift;
	my $dataset = shift;	# ptr to data hash
d44 1
d54 2
a55 4
	my $lname = &Local::LocalizedObj($name, "$ID", lc($$variables->{useLang}), $$variables->{defaultLang});
	my $description = ($style->{description} =~ /HASH/)  ? $style->{description}{lc($$variables->{useLang})} : $style->{description};

	if ( $style->{colors}->{bgclr} eq undef ) { $style->{colors}->{bgclr} = '255,255,255' };		# for background-color in RT
a150 1
#my $graph = GD::Graph::boxplot->new(800, 600);my $graph_map = $chart_map->new( $style->{base}->{width}, $style->{base}->{height} );
d152 5
a156 1
		my %attributes = defineAttr($style->{form}, $lname, $x_label, $y_label, $style->{layout}, $style->{colors});
d180 1
a180 1
		writeToImg(\$gd, $Const::format2DReport, $cache_dir, "$ID-$$variables->{useLang}");
d196 1
a196 1
<body onload="init_menu()" onclick='hideAllMenus()' style="background-color: rgb($style->{colors}->{bgclr})" >
d203 3
a205 4
<table style="width:$style->{base}->{width};border:0" >
<tr> <td style="text-align:center;color:$attributes{textclr};width=100%"> <h4>$lname</h4> </td> </tr>
<tr> <td style="text-align:center;color:$attributes{textclr};width=100%"> <h6>$description</h6> </td> </tr>
</table>
d207 1
d215 9
a223 3
	    		print RT $map->imagemap("graph2D.cgi?id=$ID-$$variables->{useLang}.$Const::format2DReport", $data);
			# !!! testing parameters only:

d266 1
a266 1
				print RT "<img src='$ID-$$variables->{useLang}.$Const::format2DReport'>";
d268 1
a268 1
				print RT "<img src=\"graph2D.cgi?id=$ID-$$variables->{useLang}.$Const::format2DReport\">";	
a273 1
<table style="width:$style->{base}->{width};border:0;font-size:12" >
a279 3
open TEST,">$Const::myPath/html/data.tst";
print TEST Dumper($x_label_html);
close TEST;
d288 2
a289 5
		my ($scale,$width,$height) = myscale($style->{base}->{width}, $style->{base}->{height}, $maplist->{measurement}{width}, $maplist->{measurement}{height});
		my $colors = $style->{map}{colors}; 
		my $image = new GD::Image ($width,$height);
		my $bgclr = defined $style->{colors}->{bgclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{bgclr})) : $image->colorAllocate(255,255,255);
		my ($htmlmap,$html_obj,$layer_id);my $row = 0;
d296 5
d303 2
a304 4
			if ( defined $metric->[$i] ) {
				if ( exists $maplist->{layer}{$layer_id}{object}->{$attr->[$i]} ) {
					my $startx = start($maplist->{layer}{$layer_id}{object}->{$attr->[$i]}->{x});
					my $starty = start($maplist->{layer}{$layer_id}{object}->{$attr->[$i]}->{y});
d312 7
a318 9
			if ( ! exists $maplist->{layer}{$layer_id}{object}->{$attr->[$i]} ) {
				my ($r,$g,$b) = metric2clr(\$colors, $metric->[$i]);
				if ( $row%3 == 0 ) {
					$html_obj .= "<tr><td title='$title->[$i] : $metric->[$i]' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$title->[$i]";
				}
				else {
					$html_obj .= "<td title='$title->[$i] : $metric->[$i]' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$title->[$i]";
				}
				$row++;
d321 1
a321 3
		foreach (keys %{$maplist->{layer}{$layer_id}{object}} ) {
			my $startx = start($maplist->{layer}{$layer_id}{object}->{$_}->{x});
			my $starty = start($maplist->{layer}{$layer_id}{object}->{$_}->{y});
d326 4
a329 2
			
		writeToImg(\$image, $Const::format2DReport, $cache_dir, "$ID-$$variables->{useLang}");
d332 1
d334 1
d342 1
a342 1
<body onload="init_menu()" onclick='hideAllMenus()' style="background-color: rgb($style->{colors}->{bgclr})">
d349 20
a368 4
<table style="width:$width;border:0" >
<tr> <td style='text-align:center;width=100%'> <h4>$lname</h4> </td> </tr>
<tr> <td style='text-align:center;width=100%'> <h6>$description</h6> </td> </tr>
</table>
d372 3
d377 6
a382 2
		my $export = join("|",@@{$Const::run->{graph2dExport}});

a418 18
		
		if ($exportAction) {
			print RT <<END;
<Img UseMap="#mapa" Src="$ID-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width>
END
		} 
		else {
			print RT <<END;
<Img UseMap="#mapa" Src="$Const::cache2DReport/$ID-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width>
END
		
		}
		
		print RT <<END;
<table style="width:$width;border:0">
$html_obj
</table>
END
d425 14
d446 2
a447 2
	my ($id_row,$at_row,@@datarow) = joinDataset(\$$dataset->{row});
	my ($id_col,$at_col,@@datacol) = joinDataset(\$$dataset->{col});
d565 12
a576 8
	
	if ((exists $$dataset->[0])&&( scalar @@{$$dataset->[0]} > 1 )) {
		for ( my $i=0; $i<scalar @@{$$dataset->[0]}; $i++ ) {
			$at[$i] = 0;  my $item = $$dataset->[0][$i];
			for ( my $j=0; $j<scalar @@{$$dataset}; $j++ ) {
	    			if ( $$dataset->[$j][$i] ne $item ) {
					$at[$i] = 1 ;				## draw label of item of attribute
				}
d579 16
a595 16
	else {
		$at[0] = 1;							## if number of items = 1 or less label of item will be drawn
	}
	for ( my $i=0; $i<scalar @@{$$dataset}; $i++ ) {
	    my ($rowItem,$idItem);
	    for ( my $j=0;$j<scalar @@{$$dataset->[$i]};$j++ ){
			my ($name,$id) = split(/\|/,$$dataset->[$i][$j]);
			$idItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $id : $id."\t";
	    		if ( $at[$j] == 1 ) {
	        		$rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $name : $name."**";
	    		}
	    }
	    push(@@data,$rowItem);
	    push(@@ids,$idItem);
	}
	return (\@@ids,\@@at,@@data);
d623 32
a680 30
	   if (defined $colors->{fgclr}) {
	      my ($r,$g,$b) = split(/,/,$colors->{fgclr});
	      $attr{"fgclr"} = rgb2hexa($r,$g,$b);
	      $attr{"labelclr"} = rgb2hexa($r,$g,$b);
	      $attr{"textclr"} = rgb2hexa($r,$g,$b);
	      $attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
	      $attr{"legendclr"} = rgb2hexa($r,$g,$b);
	   }
	   if (defined $colors->{labelclr}) {
	      my ($r,$g,$b) = split(/,/,$colors->{labelclr});
	      $attr{"labelclr"} = rgb2hexa($r,$g,$b);
	   }
	   if (defined $colors->{textclr}) {
	      my ($r,$g,$b) = split(/,/,$colors->{textclr});
	      $attr{"textclr"} = rgb2hexa($r,$g,$b);
	   }
	   if (defined $colors->{axislabelclr}) {
	      my ($r,$g,$b) = split(/,/,$colors->{axislabelclr});
	      $attr{"axislabelclr"} = rgb2hexa($r,$g,$b);
	      $attr{"legendclr"} = rgb2hexa($r,$g,$b);
	   }
	   if (defined $colors->{borderclr}) {
	      my ($r,$g,$b) = split(/,/,$colors->{borderclr});
	      $attr{"fgclr"} = rgb2hexa($r,$g,$b);
	   }
	   $attr{"labelclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{labelclr} );
	   $attr{"textclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{textclr} );	   
	   $attr{"axislabelclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{axislabelclr} );
	   $attr{"legendclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{legendclr} );	   
	   $attr{"fgclr"} = rgb2hexa(0,0,0) if ( ! exists $attr{fgclr} );
d703 1
a703 1
sub writeToImg {
a704 2
	my $format = shift;
	my $cache_dir = shift;
d707 5
a711 1
	open(IMG, ">$cache_dir/$name.$format") or die $!;
d715 2
d751 2
a752 2
	my ($id_row,@@datarow) = joinDataset(\$$dataset->{row});
	my ($id_col,@@datacol) = joinDataset(\$$dataset->{col});
d794 2
a795 2
			     #$ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
			     $ids[$i][$j] = "c.$#sortHeaderC|*,r.$#sortHeaderR|*";
d825 2
a826 2
			     #$ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
			     $ids[$i][$j] = "c.$#sortHeaderC|*,r.$#sortHeaderR|*";
d861 4
d871 4
d919 57
a975 11
  my ($im_width,$im_height,$sheet_width,$sheet_height) = @@_;
  my ($scale,$iwidth,$iheight);
  
  if ( $sheet_width =~ s/cm// ) {
     my $swidth = 1000 * $sheet_width;
     $sheet_height =~ s/cm//;
     my $sheight = 1000 * $sheet_height;
     $iwidth = $im_width;
     $scale = $iwidth/$swidth;
     $iheight = $scale * $sheight;
  }
d977 1
a977 1
  return ($scale,$iwidth,$iheight); 
d996 1
a996 1
    $coords .= sprintf('%d,%d,', ($_->[0]+$starty)*$scale, ($_->[1]+$starty)*$scale);	# trochu jsem to zde srovnal: HTML s klikaci mapou je ted tretinove :)  --MD
d1023 2
a1024 1
  my $start = shift;  
d1029 1
d1051 55
@


1.35
log
@minor changes in html header
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.34 2004/01/07 10:05:25 vacula Exp $
d546 1
a546 1
	if ( scalar @@{$$dataset->[0]} > 1 ) {
@


1.34
log
@convert axis label to html
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.33 2003/12/19 12:51:48 vacula Exp $
d198 2
a199 1
<input type="hidden" value="$$variables->{id}" id="ID" name="id" />
d342 2
a343 1
<input type="hidden" value="$$variables->{id}" id="ID" name="id" />
@


1.33
log
@added decription of report to graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.32 2003/12/18 15:53:36 vacula Exp $
d46 1
a46 1
open TEST,">$Const::myPath/html/data.tst";
d50 1
a50 1
print TEST Dumper($style);
d52 1
a52 1
close TEST;
d155 1
a155 1
#			my $graph = GD::Graph::bars->new(800, 600);
d204 2
a205 2
<tr> <td style='text-align:center;width=100%'> <h4>$lname</h4> </td> </tr>
<tr> <td style='text-align:center;width=100%'> <h6>$description</h6> </td> </tr>
d210 1
d266 6
d275 4
a354 11
		if ($exportAction) {
			print RT <<END;
<Img UseMap="#mapa" Src="$ID-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width>
END
		} 
		else {
			print RT <<END;
<Img UseMap="#mapa" Src="$Const::cache2DReport/$ID-$$variables->{useLang}.$Const::format2DReport" border=0 Height=$height Width=$width>
END
		
		}
a356 1

d394 12
d607 1
a607 1
	   $attr{"x_label"} = $x_label;
d626 4
d640 1
a640 1
	      my ($r,$g,$b) = split(/,/,$colors->{labelclr});
d642 1
d646 1
a646 1
	      $attr{"borderclrs"} = rgb2hexa($r,$g,$b);
d648 5
d944 15
@


1.32
log
@better placement labels of attributes
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.31 2003/12/16 14:48:09 vacula Exp $
d47 2
a48 2
print TEST Dumper($variables);
print TEST Dumper($q);
d57 1
d205 1
a205 1
<tr> <td style='text-align:center;width=100%'> <h6>$style->{description}</h6> </td> </tr>
d337 1
a337 1
<tr> <td style='text-align:center;width=100%'> <h6>$style->{description}</h6> </td> </tr>
@


1.31
log
@right click for line and area types of graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.30 2003/12/15 17:29:51 vacula Exp $
a40 10
	
	
#open TEST,">$Const::myPath/html/data.tst";
#print TEST Dumper($variables);
#print TEST Dumper($name);
#print TEST Dumper($ID);
#print TEST Dumper($style);
#print TEST Dumper($dataset);
#close TEST;

d46 7
d157 1
a157 1
		$graph->set( %attributes ) or die $graph->error; $graph_map->set( %attributes ) or die $graph->error;
d160 1
a160 1
			$graph->set( dclrs =>  \@@dclrs  );	$graph_map->set( dclrs =>  \@@dclrs  );
a162 1

d177 1
d196 1
a196 1
<body onload="init_menu()" onclick='hideAllMenus()' style="background-color: rgb($style->{colors}->{bgclr})">
d202 4
a272 5

#open TEST,">$Const::myPath/html/data.tst";
#print TEST Dumper($dataset);
#close TEST;

d336 1
d412 2
a413 2
	my ($id_row,@@datarow) = joinDataset(\$$dataset->{row});
	my ($id_col,@@datacol) = joinDataset(\$$dataset->{col});
d416 1
a416 1
	
d453 7
a459 1
	      $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." ** ";
d496 7
a502 1
	      $x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." ** ";
a522 1

d530 1
a530 1
	my (@@data,@@ids);
d532 13
d548 5
a552 3
	    	my ($name,$id) = split(/\|/,$$dataset->[$i][$j]);
	        $rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $name : $name."**";
		$idItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $id : $id."\t";
d557 1
a557 1
	return (\@@ids,@@data);
d594 1
a594 1
	   $attr{"title"} = $title;
d633 1
a633 1
	   $attr{"label"} = $title;
@


1.30
log
@fix showing names of metrics
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.29 2003/12/15 09:45:58 vacula Exp $
a56 2


d68 1
a68 1
		if ( $style->{form} eq 'bars' or $style->{form} eq 'points' or $style->{form} eq 'linespoints' or $style->{form} eq 'lines' ) {
d83 13
a95 1

d109 1
d155 2
a156 4
		my $chart = "GD::Graph::$style->{form}";
#			my $name = $ID; #(exists $style->{name}{$lang}) ? $style->{name}{$lang} : $ID;

		my $graph = $chart->new( $style->{base}->{width}, $style->{base}->{height} );
d160 1
a160 1
		$graph->set( %attributes ) or die $graph->error;
d163 1
a163 1
			$graph->set( dclrs =>  \@@dclrs  );
d165 1
a165 1
		$graph->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );	
d168 7
a174 7
			$graph->set_legend(@@{$legend}) ;
			$graph->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );
			$graph->set_x_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_label} );	
			$graph->set_y_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_label} );	
			$graph->set_x_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} );	
			$graph->set_y_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_plot_values} );	
			$graph->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );	
d178 2
a179 2
			$graph->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );	
			$graph->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) ;
d181 1
a181 2

		my $gd = $graph->plot($data) or die $graph->error;
d211 1
a211 1
			my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, drills=> \@@drills, );
a437 7
open TEST,">$Const::myPath/html/data.tst";
print TEST Dumper(@@datarow);
print TEST Dumper(@@datacol);
#print TEST Dumper($ID);
#print TEST Dumper($style);
print TEST Dumper($dataset);
close TEST;
@


1.29
log
@sort attributes by size (for area and lines graphs)
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.28 2003/12/12 16:44:36 vacula Exp $
a44 1
#print TEST Dumper($q);
d430 7
d439 6
d458 2
a459 10
	   $key = 0;
	   foreach ( keys %{$$dataset->{rowHeader}} ) {
	      if ( $$dataset->{rowHeader}{$_}{name} eq 'Metrics' ) {
	          $y_label = "Metrics";
	      }
	      else {
	          $y_label = "Metric";
	      }
#	      $y_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." | ";
#	      $key++;
d461 5
d476 6
d495 7
a501 10
	   $key = 0;
	   foreach ( keys %{$$dataset->{colHeader}} ) {
	      if ( $$dataset->{colHeader}{$_}{name} eq 'Metrics' ) {
	          $y_label = "Metrics";
	      }
	      else {
	          $y_label = "Metric";
	      }
#	      $y_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." | ";
#	      $key++;
d716 2
a717 2
			     $ids[$i][$j] = "c.$#sortHeaderC|$ids_col[$i],r.$#sortHeaderR|$ids_row[$j]";
			     #$ids[$i][$j] = "c.$#sortHeaderC|*,r.$#sortHeaderR|*";
@


1.28
log
@fix right click
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.27 2003/12/04 18:36:31 vacula Exp $
a53 1
		#$ID = $style->{orig_id};
d118 1
a118 2
=block		
		if ( $style->{form} eq 'area' or $style->{form} eq 'lines' ) {		## for cascade drawing attributes
d121 2
a122 1
			for ( my $i=1; $i < @@{$data}; $i++) {
d137 1
a137 1
						$sortLegend->[$i] = $legend->[$j+1] if ( $i != scalar(@@sortMoas) );
d141 1
a141 1
			unshift(@@{$sortData},pop(@@{$sortData}));
d143 1
a143 1
			$legend = \@@sortMoas;#$sortLegend;
a144 5
open TEST,">$Const::myPath/html/data.tst";
print TEST Dumper($legend);
print TEST Dumper($data);
close TEST;
=cut
@


1.27
log
@drill on bars graph
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.26 2003/12/04 12:46:08 vacula Exp $
d41 11
d54 1
a58 3
#open TEST,">$Const::myPath/html/data.tst";
#print TEST Dumper($dataset);
#close TEST;
d69 1
a69 1
		my ( $x_label, $y_label, $drill_id, $ids, $legend, @@data ) = data( $dataset, $style->{base}->{sets} );
d71 15
a85 18
		if ( $style->{form} eq 'bars' or $style->{form} eq 'points' or $style->{form} eq 'linespoints' ) {
			my $counter = 0;
			for ( my $i=0; $i<@@data; $i++ ) {
		    	   my ( @@hfs, @@cts, @@drs );
		    	   for ( my $j=0;$j<@@{$data[0]};$j++ ) {
		        	push(@@hfs,"javascript:alert('x : $data[0][$i] \n y : $data[$i][$j]\n')");
		        	push(@@cts,"return showMenu(this,'$drill_id')");
				push(@@drs,$ids->[$counter]);
				$counter++;
		    	   }
		    	   push(@@{$hrefs[$i]},@@hfs);
		    	   push(@@{$contexts[$i]},@@cts);
			   push(@@{$drills[$i]},@@drs);
			}
#			for ( my $i=0;$i<@@{$legend};$i++ ) {
#		    	   push(@@lhrefs,"javascript:alert('$data[$i]')");
#			}
		} 
d87 13
a99 6
			for ( my $i=0; $i<@@data; $i++ ) {
		    	   push(@@hrefs,"javascript:alert('$data[$i]')");
		    	   push(@@contexts,"return showMenu(this,'9210.fakturace')");
			}
			for ( my $i=0;$i<@@{$legend};$i++ ) {
		    	   push(@@lhrefs,"javascript:alert('$legend->[$i]')");
d103 5
a107 3
	    	  	for ( my $i=0;$i<@@{$data[0]};$i++ ) {
	        	    push(@@hrefs,"javascript:alert('$data[0][$i]\n')");
		       	    push(@@contexts,"return showMenu(this,'9210.fakturace')");
d109 8
d119 32
d180 1
a180 1
		my $gd = $graph->plot(\@@data) or die $graph->error;
d209 3
a211 4
	    		my $map = new GD::Graph::Map($graph, contexts => \@@contexts, drills=> \@@drills, );
	    		
			#my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, drills=> \@@drills, );
	    		print RT $map->imagemap("graph2D.cgi?id=$ID-$$variables->{useLang}.$Const::format2DReport", \@@data);
a219 1
if ($style->{form} eq 'bars') {					## curently only for bars
a239 1
}
d270 6
a275 1
		my ($metric,$attr,$title,$header) = mapdata( $dataset, $style->{base}->{sets} );
d295 1
a295 1
					$htmlmap .= area($attr->[$i],$title->[$i],$metric->[$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$i]}{points_clickmap}) ; 
d358 38
a396 1
<script type='text/javascript'>var objectLinks = {'export':'$export'}; var lang = {'export':'exportovat'};</script>
d419 19
a438 8
	   for (my $i=0;$i < @@{$id_col};$i++ ) {
		my @@elements = split(/\t/,$id_col->[$i]);
		push(@@ids_col,$elements[$#elements]);
	   }
	   for (my $i=0;$i < @@{$id_row};$i++ ) {
		my @@elements = split(/\t/,$id_row->[$i]);
		push(@@ids_row,$elements[$#elements]);
	   }
d464 1
a464 8
	   my (@@colHeader,@@sortHeader);
	   foreach ( keys(%{$$dataset->{colHeader}}) ) {
		push(@@colHeader,$_);
	   }
	   @@sortHeader = sort {$a<=>$b} @@colHeader;
	   $drill = $$dataset->{colHeader}{@@sortHeader[$#sortHeader]}{id};
	   
	   my $counter = 0;
d467 1
a467 2
			$ids[$counter] = "c.0|$ids_col[$j],r.0|$ids_row[$i]";
			$counter++;
a472 9
	   for (my $i=0;$i < @@{$id_col};$i++ ) {
		my @@elements = split(/\t/,$id_col->[$i]);
		push(@@ids_col,$elements[$#elements]);
	   }
	   for (my $i=0;$i < @@{$id_row};$i++ ) {
		my @@elements = split(/\t/,$id_row->[$i]);
		push(@@ids_row,$elements[$#elements]);
	   }

d498 1
a498 8
	   my (@@rowHeader,@@sortHeader);
	   foreach ( keys(%{$$dataset->{rowHeader}}) ) {
		push(@@rowHeader,$_);
	   }
	   @@sortHeader = sort {$a<=>$b} @@rowHeader;
	   $drill = $$dataset->{rowHeader}{@@sortHeader[$#sortHeader]}{id};

	   my $counter = 0;
d501 1
a501 2
			$ids[$counter] = "c.0|$ids_col[$j],r.0|$ids_row[$i]";
			$counter++;
d508 1
a508 2

	return ( $x_label, $y_label, $drill, \@@ids, $legend, @@data, );
d579 2
d667 2
a668 1
	my (@@metric,@@attr,@@title,$header);
d670 19
d690 1
a690 6
		my (@@rowHeader,@@sortHeader);
		foreach ( keys(%{$$dataset->{rowHeader}}) ) {
			push(@@rowHeader,$_);
		}
		@@sortHeader = sort {$a<=>$b} @@rowHeader;
		$header = $$dataset->{rowHeader}{@@sortHeader[$#sortHeader]}{id};
d693 1
a693 1
			my ($at_short,$id_s) = split(/\|/,$$dataset->{row}[$i][$#sortHeader]); 
d696 1
a696 1
			my ($at_name,$id_n) = split(/\|/,$$dataset->{row}[$i][$#sortHeader-1]); 
d706 8
d738 8
d748 1
a748 4



	return ( \@@metric,\@@attr,\@@title, $header );
d848 2
d873 1
a873 1
   	return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $name - $short : $value ! ');\" \n Title=\"$name - $short : $value\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'9210.fakturace')\">\n";
d876 1
a876 1
   	return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $short : $value ! ');\" \n Title=\"$short : $value\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'9210.fakturace')\">\n";
d878 1
@


1.26
log
@changes in definition of attributes for graphs with map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.25 2003/12/03 13:11:59 vacula Exp $
d42 10
d63 1
d69 2
a70 1
				push(@@drs,$ids->[$i]);
d124 1
d154 3
a156 2
	    		#my $map = new GD::Graph::Map($graph, contexts => \@@contexts, );
	    		my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, drills=> \@@drills, );
d162 1
a162 1
			if (! exists $$variables->{export}) {	## define context menu
d166 1
d168 1
a168 1
					undef @@links;
d174 1
a174 1
					#undef @@links;
d187 1
a187 1

d302 1
a302 1
<script type='text/javascript'>var objectLinks = {'current9202.fakturace':'9202.fakturace|Datum (Fakturace)|kal|Kalendar|sum|Poznamka','down9202.fakturace':'','up9202.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','current9214.fakturace':'9214.fakturace|Rok (Fakturace)','down9214.fakturace':'9202.fakturace|Datum (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','up9214.fakturace':'','current9201':'desc|Popis|po|Objednavka|9201|Vyrobek','down9201':'','up9201':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku|9203|Typ vyrobku','current9203':'9203|Typ vyrobku','down9203':'9201|Vyrobek','up9203':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku','current9210.fakturace':'9210.fakturace|Mesic (Fakturace)','down9210.fakturace':'9202.fakturace|Datum (Fakturace)','up9210.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9221.fakturace|Kvartal (Fakturace)','export':'$export','sort':'AZ|A-Z|ZA|Z-A','pivotY':'0|Rok (Fakturace)|0.5|MID|1|Mesic (Fakturace)|1.5|MID|2|Datum (Fakturace)|2.5|MID','pivotX':'0|Typ vyrobku|0.5|MID|1|Vyrobek|1.5|MID|2|Metrics|2.5|MID'}; var lang = {'pivotX':'pivot na osu X','sort':'t\x{0159}dit','pivotY':'pivot na osu Y','down':'drill down','up':'drill up','export':'exportovat'};</script>
d320 2
a321 2
	my @@datarow = joinDataset(\$$dataset->{row});
	my @@datacol = joinDataset(\$$dataset->{col});
d323 1
a323 1
	my ( @@data, $legend, @@lhrefs, $x_label, $y_label ,$drill, @@ids );
d326 7
a332 8
	   for (my $i=0;$i < @@datacol;$i++ ) {
	   	my ($name,$id) = split(/\|/,$datacol[$i]);
		$datacol[$i] = $name;
		$ids[$i]     = $id;
	   }
	   for (my $i=0;$i < @@datarow;$i++ ) {
	   	my ($name,$id) = split(/\|/,$datarow[$i]);
		$datarow[$i] = $name;
d359 15
a373 1
	   $drill = $$dataset->{colHeader}{0}{id};
d376 7
a382 8
	   for (my $i=0;$i < @@datarow;$i++ ) {
	   	my ($name,$id) = split(/\|/,$datarow[$i]);
		$datarow[$i] = $name;
		$ids[$i]     = $id;
	   }
	   for (my $i=0;$i < @@datacol;$i++ ) {
	   	my ($name,$id) = split(/\|/,$datacol[$i]);
		$datacol[$i] = $name;
d410 15
a424 1
	   $drill = $$dataset->{rowHeader}{0}{id};
d427 2
d436 1
a436 1
	my (@@data);
d439 1
a439 1
	    my $rowItem;
d441 3
a443 1
	        $rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $$dataset->[$i][$j] : $$dataset->[$i][$j].'**';
d446 1
d448 1
a448 1
	return @@data;
d601 24
@


1.25
log
@graph map with layers
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.24 2003/12/02 12:39:33 vacula Exp $
d41 1
a41 1
	
d50 2
a51 2
		my ( $x_label, $y_label, $drill, $legend, @@data ) = data( $dataset, $style->{base}->{sets} );
		my ( @@hrefs, @@lhrefs, @@contexts );	
d54 1
a54 1
		    	   my ( @@hfs, @@cts );
d56 3
a58 2
		        	push(@@hfs,"javascript:alert('x : $data[0][$j]\n y : $data[$i][$j]\n')");
		        	push(@@cts,"return showMenu(this,'$drill')");
d62 1
d64 3
a66 3
			for ( my $i=0;$i<@@{$legend};$i++ ) {
		    	   push(@@lhrefs,"return showMenu(this,'$drill')");
			}
d142 1
a142 1
	    		my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, );
d148 24
d173 11
a183 41
if (! exists $$variables->{export}) {
	my @@objectLinks;
	my @@links;
	my $links;
	foreach my $ID (keys %{$$dataset->{links}}) {
		undef @@links;
		foreach (keys %{$$dataset->{links}{$ID}{current}}) {
			push(@@links,"$$dataset->{links}{$ID}{current}{$_}/$_");
		}
		$links = join("|",@@links);
		push (@@objectLinks,"'current$ID':'$links'");
		undef @@links;
		foreach (keys %{$$dataset->{links}{$ID}{down}}) {
			push(@@links,"$$dataset->{links}{$ID}{down}{$_}/$_");
		}
		$links = join("|",@@links);
		push (@@objectLinks,"'down$ID':'$links'");
		undef @@links;
		foreach (keys %{$$dataset->{links}{$ID}{up}}) {
			push(@@links,"$$dataset->{links}{$ID}{up}{$_}/$_");
		}
		$links = join("|",@@links);
		push (@@objectLinks,"'up$ID':'$links'");
	}

	$links = join("|",@@{$Const::run->{gridExport}});
	push (@@objectLinks,"'export':'$links'");
	$links = join("|",@@{$Const::run->{sort}});
	push (@@objectLinks,"'sort':'$links'");
	foreach my $type ('rowHeader','colHeader') {
		my $ok = 0;
		undef @@links;
		do {
			if (exists $$dataset->{$type}{$ok}) {
				push (@@links, "$ok|$$dataset->{$type}{$ok}{name}");
				my $hlp = $ok;
				$hlp += 0.5;
				$ok++;
				push (@@links, "$hlp|MID");
			} else {
				undef $ok;
a184 16
		} while ($ok);
		$links = join("|",@@links);
		if ($type eq 'rowHeader') {
			push (@@objectLinks,"'pivotY':'$links'")
		} else {
			push (@@objectLinks,"'pivotX':'$links'")
		}
	}
	undef @@links;
	foreach (keys %{$Const::RLang->{ $$variables->{useLang} }}) {
		push (@@links,"'$_':'$Const::RLang->{ $$variables->{useLang} }{$_}'");
	}
	$links = join(",",@@links);
	my $objectLinks = join(",",@@objectLinks);
	print RT "<script type='text/javascript'>var objectLinks = {$objectLinks}; var lang = {$links};</script>";
}
d203 1
a203 1
		my ($metric,$attr,$names,$header) = mapdata( $dataset, $style->{base}->{sets} );
d223 1
a223 1
					$htmlmap .= area($attr->[$i],$names->[$i],$metric->[$i],$scale,$startx,$starty,$maplist->{layer}{$layer_id}{object}{$attr->[$i]}{points_clickmap}) ; 
d232 1
a232 1
					$html_obj .= "<tr><td title='$names->[$i]' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$names->[$i]";
d235 1
a235 1
					$html_obj .= "<td title='$names->[$i]' style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$names->[$i]";
d308 2
a309 2
	my ( @@data, $legend, @@lhrefs, $x_label, $y_label ,$drill );

d311 9
d330 1
a330 1
	      $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." | ";
d348 10
d368 1
a368 1
	      $x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." | ";
d386 1
a386 1
	return ( $x_label, $y_label, $drill, $legend, @@data, );
d398 1
a398 1
	        $rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $$dataset->[$i][$j] : $$dataset->[$i][$j].'|';
d430 2
a431 2
#	if ( $chart eq 'bars' or $chart eq 'hbars' or $chart eq 'bars3d') {
#	   $attr{"bar_spacing"} = 5;
d433 3
a435 2
#	   $attr{"shadow_depth"} = 5; 
#	}
d540 1
a540 5
	my @@datarow = joinDataset(\$$dataset->{row});
	my @@datacol = joinDataset(\$$dataset->{col});

	my ( @@mapdata,@@attr,@@names);
	my $header = 0;
d542 21
a562 12
	if ( $datasheet eq 'rows' ) {
	   for ( my $i=0;$i<@@datarow;$i++ ) {
#	        $datarow[$i] =~ /\|(.*?)$/;
#		push(@@attr,$1);
		my @@atributes = split(/\|/,$datarow[$i]);
		push(@@names,$atributes[$#atributes-3]);
		push(@@attr,$atributes[$#atributes-1]);
		push(@@mapdata,(exists $$dataset->{c}{$i}{0}) ? $$dataset->{c}{$i}{0} : undef);
	   }
	   foreach ( keys(%{$$dataset->{rowHeader}}) ) {
	   	if ( $_ > $header ) {
			$header = $_;
a563 2
	   }
	   $header = $$dataset->{rowHeader}{$header}{id}
a565 14
	if ( $datasheet eq 'cols' ) {
	   for ( my $i=0;$i<@@datacol;$i++ ) {
#	        $datacol[$i] =~ /\|(.*?)$/;
#	        push(@@attr,$1);
		my @@atributes = split(/\|/,$datacol[$i]);
		push(@@names,$atributes[$#atributes-3]);
		push(@@attr,$atributes[$#atributes-1]);
	       push(@@mapdata,(exists $$dataset->{c}{0}{$i}) ? $$dataset->{c}{0}{$i} : undef);
	   }
	   foreach ( keys(%{$$dataset->{rowHeader}}) ) {
	   	if ( $_ > $header ) {
			$header = $_;
		}
	   }
a566 1
	}
d568 3
a570 2
	
	return ( \@@mapdata,\@@attr,\@@names, $header );
d573 1
d691 6
a696 1
   return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $short - $name : $value ! ');\" \n Title=\"$short - $name : $value\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'9210.fakturace')\">\n";
@


1.24
log
@added sqare for attr which is not defined in XML file
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.23 2003/12/01 10:05:45 vasekd Exp $
a50 1
print "<pre>".Dumper($dataset)."</pre>";print $drill;
d223 1
a223 1
		my ($metric,$attr,$names) = mapdata( $dataset, $style->{base}->{sets} );
a225 2
#		my $colors = colors($style->{map}->{clr},$style->{map}->{int}); 
#		my $colors = [[100000,'160,0,80'],[200000,'0,155,60'],[500000,'25,0,165']]; 
d229 7
a235 1
		my ($htmlmap,$html_obj);my $row = 0;
d239 5
a243 5
				if ( exists $maplist->{object}->{$attr->[$i]} ) {
					my $startx = start($maplist->{object}->{$attr->[$i]}->{x});
					my $starty = start($maplist->{object}->{$attr->[$i]}->{y});
					$polyline =  addPolyline( $maplist->{object}->{$attr->[$i]}->{points}, $startx, $starty, $scale ); 
					$htmlmap .= area($attr->[$i],$metric->[$i],$scale,$startx,$starty,$maplist->{object}{$attr->[$i]}{points_clickmap}) ; 
d249 1
a249 1
			if ( ! exists $maplist->{object}->{$attr->[$i]} ) {
a250 1
#				$html_obj .= "<tr><td id='' style='background-color:rgb($r,$g,$b); width=25px' title='a' onclick='' rowspan='4'>&nbsp</td></tr> "; 
d252 1
a252 1
					$html_obj .= "<tr><td style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$names->[$i]";
d255 1
a255 1
					$html_obj .= "<td style='background-color:rgb($r,$g,$b);width:25px;border:2px solid rgb($style->{colors}->{bgclr})'><td style='text-align:left; border:2px solid rgb($style->{colors}->{bgclr})'>$names->[$i]";
d260 3
a262 3
		foreach (keys %{$maplist->{object}} ) {
			my $startx = start($maplist->{object}->{$_}->{x});
			my $starty = start($maplist->{object}->{$_}->{y});
d264 1
a264 1
			my $polyline =  addPolyline( $maplist->{object}->{$_}->{points}, $startx, $starty, $scale ) ; 
a311 1
#print Dumper($attr);
d341 1
a341 1
	      $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." ** ";
d369 1
a369 1
	      $x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." ** ";
d399 1
a399 1
	        $rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $$dataset->[$i][$j] : $$dataset->[$i][$j].'**';
d543 3
a545 2
	my ( @@mapdata,@@attr,@@names );

d555 6
d572 6
d581 1
a581 1
	return ( \@@mapdata,\@@attr,\@@names  );
d594 14
a607 10
	foreach my $obj (keys %{$ml->{object}}) {
		my @@p = split(' ',$ml->{object}->{$obj}->{points});
		my @@mp= split(' ',$ml->{object}->{$obj}->{points_clickmap});
		foreach (@@p) {
			my @@pp = split(',',$_);
			push @@{$maplist->{object}->{$obj}->{points}}, [@@pp];
		}
		foreach (@@mp) {
			my @@mpp = split(',',$_);
			push @@{$maplist->{object}->{$obj}->{points_clickmap}}, [@@mpp];
d609 3
a611 3
		$maplist->{object}->{$obj}->{x} = $ml->{object}->{$obj}->{x};
		$maplist->{object}->{$obj}->{y} = $ml->{object}->{$obj}->{y};
	}
d676 1
d701 1
a701 1
   return "<Area Shape=poly Coords=\"$coords\" \n Href=\"javascript:alert(' $name : $value ! ');\" \n Title=\"$name\"\n Alt=\"x=1st y=1\"\n onMouseOver=\"window.status='$value'; return true;\"\n onMouseOut=\"window.status=''; return true;\"\n onContextMenu = \"return showMenu(this,'9210.fakturace')\">\n";
@


1.23
log
@fix
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.22 2003/11/28 20:26:02 michald Exp $
d50 2
a51 2
		my ( $x_label, $y_label, $legend, @@data ) = data( $dataset, $style->{base}->{sets} );

d58 1
a58 1
		        	push(@@cts,"return showMenu(this,'9210.fakturace')");
d64 1
a64 1
		    	   push(@@lhrefs,"javascript:alert('$legend->[$i]')");
d140 2
a141 2
	    		my $map = new GD::Graph::Map($graph, contexts => \@@contexts, );
	    		#my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, );
d147 60
a206 3
			print RT <<END;
<script type='text/javascript'>var objectLinks = {'current9202.fakturace':'9202.fakturace|Datum (Fakturace)|kal|Kalendar|sum|Poznamka','down9202.fakturace':'','up9202.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','current9214.fakturace':'9214.fakturace|Rok (Fakturace)','down9214.fakturace':'9202.fakturace|Datum (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','up9214.fakturace':'','current9201':'desc|Popis|po|Objednavka|9201|Vyrobek','down9201':'','up9201':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku|9203|Typ vyrobku','current9203':'9203|Typ vyrobku','down9203':'9201|Vyrobek','up9203':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku','current9210.fakturace':'9210.fakturace|Mesic (Fakturace)','down9210.fakturace':'9202.fakturace|Datum (Fakturace)','up9210.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9221.fakturace|Kvartal (Fakturace)','export':'$export','sort':'AZ|A-Z|ZA|Z-A','pivotY':'0|Rok (Fakturace)|0.5|MID|1|Mesic (Fakturace)|1.5|MID|2|Datum (Fakturace)|2.5|MID','pivotX':'0|Typ vyrobku|0.5|MID|1|Vyrobek|1.5|MID|2|Metrics|2.5|MID'}; var lang = {'pivotX':'pivot na osu X','sort':'t\x{0159}dit','pivotY':'pivot na osu Y','down':'drill down','up':'drill up','export':'exportovat'};</script>
END
d215 1
d224 1
a224 1
		my ($metric,$attr) = mapdata( $dataset, $style->{base}->{sets} );
d232 1
a232 1
		my ($htmlmap,$html_obj);
d246 11
d283 3
a285 1
<h4>$lname</h4>
d306 2
a307 4
<table>
	<tr>
		$html_obj
	</tr>
d327 1
a327 1
	my ( @@data, $legend, @@lhrefs, $x_label, $y_label );
d340 1
a340 1
	      $x_label .= ($key == ( keys(%{$$dataset->{colHeader}}) - 1) ) ? $$dataset->{colHeader}{$_}{name} : $$dataset->{colHeader}{$_}{name}." | ";
d355 1
d368 1
a368 1
	      $x_label .= ($key == ( keys(%{$$dataset->{rowHeader}}) - 1) ) ? $$dataset->{rowHeader}{$_}{name} : $$dataset->{rowHeader}{$_}{name}." | ";
d383 1
d386 1
a386 1
	return ( $x_label, $y_label, $legend, @@data, );
d398 1
a398 1
	        $rowItem .= ($j == (scalar @@{$$dataset->[$i]}-1)) ? $$dataset->[$i][$j] : $$dataset->[$i][$j].'|';
d542 1
a542 1
	my ( @@mapdata,@@attr );
d549 1
d557 5
a561 2
	       $datacol[$i] =~ /\|(.*?)$/;
	       push(@@attr,$1);
d567 1
a567 1
	return ( \@@mapdata,\@@attr );
@


1.22
log
@HTML map optimization
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.21 2003/11/28 15:57:32 vacula Exp $
d592 2
a593 2
#      $coords .= ( ($_->[0] * $scale) + ( $startx * $scale ) ).",".( ($_->[1] * $scale) + ( $starty * $scale )).",";
      $coords .= sprintf('%d,%d,', ($_->[1]+$starty)*$scale, ($_->[1]+$starty)*$scale);	# trochu jsem to zde srovnal: HTML s klikaci mapou je ted tretinove :)  --MD
d596 10
d607 2
a608 2
   return "<Area Shape=poly Coords=\"$coords\" Href=\"javascript:alert(' $name : $value ! ');\" Title=\"$name\" Alt=\"x=1st y=1\" onMouseOver=\"window.status='$value'; return true;\" onMouseOut=\"window.status=''; return true;\" onContextMenu = \"return showMenu(this,'9210.fakturace')\">\n";

@


1.21
log
@fix problem with different mdata
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.20 2003/11/27 08:52:44 jiri_schmid Exp $
d592 2
a593 1
      $coords .= ( ($_->[0] * $scale) + ( $startx * $scale ) ).",".( ($_->[1] * $scale) + ( $starty * $scale )).",";
d595 1
d597 1
a597 11
   my $maparea = " 
        	<Area Shape=poly 
	      		Coords=\"$coords\" 
	      		Href=\"javascript:alert(' $name : $value ! ');\" 
	      		Title=\"$name\" 
	      		Alt=\"x=1st   y=1\" 
	      		onMouseOver=\"window.status='$value'; return true;\" 
	      		onMouseOut=\"window.status=''; return true;\"
			onContextMenu = \" return showMenu(this,'9210.fakturace') \"
		>	    		
   	      ";
a598 1
   return $maparea;
@


1.20
log
@1.step for drilling implemented
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.19 2003/11/25 22:12:11 michald Exp $
a89 1
		my @@dclrs = dclrs($style->{colors}->{datas});
d91 4
a94 1
		$graph->set( dclrs =>  \@@dclrs  );
d121 8
a128 7
my $exportAction = exists $$variables->{export};
if ($exportAction) {
	print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result');
	print RT "<body>"
} else {
print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
print RT <<END;
d136 2
a137 2
print RT "<iframe width='1' height='1' frameborder='0' srolling='no' src='' style='display:none' id='EXPRT'></iframe>";
}
d145 1
a145 1
	my $export = join("|",@@{$Const::run->{graph2dExport}});
d150 2
a151 1
		} else {
d161 2
a162 1
	} else {	# style is map
d174 1
a174 1
		my $htmlmap;
d176 1
d181 2
a182 1
					my $polyline =  addPolyline( $maplist->{object}->{$attr->[$i]}->{points}, $startx, $starty, $scale ); 
a185 1
					$htmlmap .= area($attr->[$i],$metric->[$i],$scale,$startx,$starty,$maplist->{object}{$attr->[$i]}{points}) ; 
d197 1
a197 1
		writeToImg(\$image, $Const::format2DReport, $cache_dir, $ID);
d200 12
a211 5
		print RT &Local::customHTMLHead(0,0,$$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
		print RT <<END;
<body style="background-color: rgb($style->{colors}->{bgclr})">
<input type='hidden' value='$ID' id='ID' name='id' />
<input type='hidden' value='$$variables->{useLang}' id='LANG' name='lang' />
d214 1
a217 1
<Img UseMap="#mapa" Src="$Const::cache2DReport/$ID.$Const::format2DReport" border=0 Height=$height Width=$width>
d219 23
a241 1
#print "<pre>".Dumper($colors)."</pre>";
d443 1
a443 1
	    ($r,$g,$b) = split(/,/,$_);
d475 4
a478 2
	        $datarow[$i] =~ /\|(.*?)$/;
		push(@@attr,$1);
d507 1
d512 4
d603 1
@


1.19
log
@fix Save and Run again
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.18 2003/11/25 16:24:10 vacula Exp $
d133 1
@


1.18
log
@changes in colors
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.17 2003/11/25 12:10:44 jiri_schmid Exp $
a129 1
>>>>>>> 1.17
@


1.17
log
@export rutines implemented for graph 2D
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.16 2003/11/21 12:49:52 vacula Exp $
d118 1
d130 1
d165 2
a166 1
		my $colors = [[100000,'160,0,80'],[200000,'0,155,60'],[500000,'25,0,165']]; 
d168 1
a168 1
		my $bgclr = exists $style->{colors}->{bgclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{bgclr})) : $image->colorAllocate(255,255,255);
d186 1
a186 1
			my $borderclr = exists $style->{colors}->{borderclr} ? $image->colorAllocate(split(/,/,$style->{colors}->{borderclr})) : $image->colorAllocate(0,0,0);
d194 1
a194 1
		print RT &Local::customHTMLHead($$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
d206 1
a206 1

a481 15
}

#--------------------------------------------------------------------------------------------------------------------------------------------

sub colors {
	my $clrs = shift; 
	my $ints = shift;
	my $colors;

	for ( my $i=0; $i < @@{$clrs};$i++ ) {
		my ($a,$b) = split(/,/,$ints->[$i]);
		push( @@{$colors->{$clrs->[$i]}},$a,$b);  
	}
  
	return $colors;
@


1.16
log
@fix graphs without html map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.15 2003/11/20 15:58:34 vacula Exp $
d111 1
a111 1
		writeToImg(\$gd, $Const::format2DReport, $cache_dir, $ID);
d118 11
a128 6
		print RT &Local::customHTMLHead($$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");

		print RT <<END;
<body onload="init_menu()" style="background-color: rgb($style->{colors}->{bgclr})">
<input type='hidden' value='$ID' id='ID' name='id' />
<input type='hidden' value='$$variables->{useLang}' id='LANG' name='lang' />
d132 2
a133 1
		if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$|^pie$|^pie3d$|^area$/ ) {
d137 1
a137 1
	    		print RT $map->imagemap("graph2D.cgi?id=$ID.$Const::format2DReport", \@@data);
d139 3
d143 1
a143 1
<script type='text/javascript'>var objectLinks = {'current9202.fakturace':'9202.fakturace|Datum (Fakturace)|kal|Kalendar|sum|Poznamka','down9202.fakturace':'','up9202.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','current9214.fakturace':'9214.fakturace|Rok (Fakturace)','down9214.fakturace':'9202.fakturace|Datum (Fakturace)|9210.fakturace|Mesic (Fakturace)|9221.fakturace|Kvartal (Fakturace)','up9214.fakturace':'','current9201':'desc|Popis|po|Objednavka|9201|Vyrobek','down9201':'','up9201':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku|9203|Typ vyrobku','current9203':'9203|Typ vyrobku','down9203':'9201|Vyrobek','up9203':'9204|Subkategorie vyrobku|9205|Kategorie vyrobku','current9210.fakturace':'9210.fakturace|Mesic (Fakturace)','down9210.fakturace':'9202.fakturace|Datum (Fakturace)','up9210.fakturace':'9212.fakturace|Mesic v roce (Fakturace)|9214.fakturace|Rok (Fakturace)|9221.fakturace|Kvartal (Fakturace)','export':'pdf|Portable Data Format (pdf)|xls|Excel Sheet (xls)|txt|Text (txt)','sort':'AZ|A-Z|ZA|Z-A','pivotY':'0|Rok (Fakturace)|0.5|MID|1|Mesic (Fakturace)|1.5|MID|2|Datum (Fakturace)|2.5|MID','pivotX':'0|Typ vyrobku|0.5|MID|1|Vyrobek|1.5|MID|2|Metrics|2.5|MID'}; var lang = {'pivotX':'pivot na osu X','sort':'t\x{0159}dit','pivotY':'pivot na osu Y','down':'drill down','up':'drill up','export':'exportovat'};</script>
d146 5
a150 1
			print RT "<img  src=\"graph2D.cgi?id=$ID.$Const::format2DReport\">";	
@


1.15
log
@right click in all graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.14 2003/11/19 16:25:28 vacula Exp $
d69 1
a69 1
		    	   push(@@hrefs,"javascript:alert('')");
d73 1
a73 1
		    	   push(@@lhrefs,"javascript:alert('')");
d113 1
a113 2
		if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$|^pie$|^pie3d$|^area$/ ) {
			open(RT,">$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
d115 2
a116 2
			my $use_lang = $$variables->{useLang};
			my $use_enc = $$variables->{useEnc};
d118 1
a118 1
			print RT &Local::customHTMLHead($$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
d120 1
a120 1
			print RT <<END;
d127 1
d129 3
a131 2
	    	my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, contexts => \@@contexts, lhrefs => \@@lhrefs, );
	    	print RT $map->imagemap("graph2D.cgi?id=$ID.$Const::format2DReport", \@@data);
a135 2
			print RT $$q->end_html;
			close(RT);
d137 1
a137 1
	    	print $$q->header( -location=>"graph2D.cgi?id=$ID.$Const::format2DReport");
d139 2
@


1.14
log
@map for all graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.13 2003/11/13 17:48:06 michald Exp $
d53 22
a74 8
		for ( my $i=1; $i<@@data; $i++ ) {
	    	   my ( @@hfs, @@cts );
	    	   for ( my $j=0;$j<@@{$data[0]};$j++ ) {
	        	push(@@hfs,"javascript:alert('Test in objects')");
	        	push(@@cts,"return showMenu(this,'9210.fakturace')");
	    	   }
	    	   push(@@{$hrefs[$i]},@@hfs);
	    	   push(@@{$contexts[$i]},@@cts);
d76 6
a81 2
		for ( my $i=0;$i<@@{$legend};$i++ ) {
	    	   push(@@lhrefs,"javascript:alert('Test in legends')");
a82 1

d129 1
a129 1
	    	my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, lhrefs => \@@lhrefs, contexts => \@@contexts );
d307 5
@


1.13
log
@fix of wrong path definition for Graph Map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.12 2003/11/13 13:55:21 vacula Exp $
d47 1
d72 6
d79 1
a79 5
			my %attributes = defineAttr($style->{form}, $lname, $x_label, $y_label, $style->{layout}, $style->{colors});
			my @@dclrs = dclrs($style->{colors}->{datas});
			$graph->set( %attributes ) or die $graph->error;
			$graph->set_legend(@@{$legend});
			$graph->set( dclrs =>  \@@dclrs  );
a80 2
			$graph->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );	
#				$graph->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );	
d85 6
a90 2
#				$graph->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );	
			$graph->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{value} );
d96 1
a96 1
		if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$/ ) {
d290 1
a290 1
	$attr{"legend_placement"} = 'RT';
d292 1
d328 4
@


1.12
log
@fix right menu options
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.11 2003/11/10 18:52:08 michald Exp $
d124 1
a124 1
		my $maplist = getmap($style->{map}->{use}, "$Const::myPath$Const::graph2Dtypes");
@


1.11
log
@.pl to .pm transition
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.10 2003/11/10 06:36:01 michald Exp $
d53 2
a54 2
	    	my ( @@hfs, @@cts );
	    	for ( my $j=0;$j<@@{$data[0]};$j++ ) {
d57 3
a59 3
	    	}
	    	push(@@{$hrefs[$i]},@@hfs);
	    	push(@@{$contexts[$i]},@@cts);
d62 1
a62 1
	    	push(@@lhrefs,"javascript:alert('Test in legends')");
d100 1
a100 1
<body style="background-color: rgb($style->{colors}->{bgclr})">
d106 1
@


1.10
log
@map graph prototype
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.9 2003/11/09 20:41:48 vacula Exp $
d92 1
a92 1
			open(RT,">$Const::cache2DReport/$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
@


1.9
log
@added graph 2d map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.8 2003/11/09 19:19:11 vacula Exp $
d46 21
a66 1
	if ( $style->{colors}->{bgclr} eq undef ) { $style->{colors}->{bgclr} = '255,255,255' }		# for background-color in RT
d68 22
a89 1
	if ( $style->{form} ne 'map' ) {
d91 2
a92 1
	my ( $x_label, $y_label, $legend, @@data ) = data( $dataset, $style->{base}->{sets} );
d94 2
a95 37
	my ( @@hrefs, @@lhrefs, @@contexts );	
	for ( my $i=1; $i<@@data; $i++ ) {
	    my ( @@hfs, @@cts );
	    for ( my $j=0;$j<@@{$data[0]};$j++ ) {
	        push(@@hfs,"javascript:alert('Test in objects')");
	        push(@@cts,"return showMenu(this,'9210.fakturace')");
	    }
	    push(@@{$hrefs[$i]},@@hfs);
	    push(@@{$contexts[$i]},@@cts);
	}
	for ( my $i=0;$i<@@{$legend};$i++ ) {
	    push(@@lhrefs,"javascript:alert('Test in legends')");
	}
	
	my $chart = "GD::Graph::$style->{form}";
#	my $name = $ID; #(exists $style->{name}{$lang}) ? $style->{name}{$lang} : $ID;
	   
	my $graph = $chart->new( $style->{base}->{width}, $style->{base}->{height} );
#	my $graph = GD::Graph::bars->new(800, 600);

if ($style->{form} ne 'pie' and $style->{form} ne 'pie3d') {
	my %attributes = defineAttr($style->{form}, $lname, $x_label, $y_label, $style->{layout}, $style->{colors});
	my @@dclrs = dclrs($style->{colors}->{datas});
	$graph->set( %attributes ) or die $graph->error;
	$graph->set_legend(@@{$legend});
	$graph->set( dclrs =>  \@@dclrs  );
	$graph->set_legend_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( defined $legend );
	$graph->set_title_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{title} );	
#	$graph->set_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{label} );	
	$graph->set_x_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_label} );	
	$graph->set_y_label_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_label} );	
	$graph->set_x_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} );	
	$graph->set_y_axis_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{y_plot_values} );	
#	$graph->set_values_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{x_plot_values} or exists $attributes{y_plot_values} );	
	$graph->set_value_font("$Const::trueTypeFontPath/luximbi.ttf",7) if ( exists $attributes{value} );
}
	my $gd = $graph->plot(\@@data) or die $graph->error;
d97 1
a97 4
	writeToImg(\$gd, $Const::format2DReport, $cache_dir, $ID);
	
	if ( $style->{form}=~/^bars$|^lines$|^points$|^linespoints$/ ) {
		open(RT,">$Cache::cacheReport/$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
d99 1
a99 6
		my $use_lang = $$variables->{useLang};
		my $use_enc = $$variables->{useEnc};
		
		print RT &Local::customHTMLHead($$variables->{useEnc},$Const::languages->{ $$variables->{useLang} }->{lang},'Report Result','right_menu',"<style>\@@import url('./CSS/$css.css');\@@import url('$$variables->{skinPath}menu.css');</style>");
		
		print RT <<END;
d106 4
a109 4
	    my $map = new GD::Graph::Map($graph, hrefs => \@@hrefs, lhrefs => \@@lhrefs, contexts => \@@contexts );
	    print RT $map->imagemap("graph2D.cgi?id=$ID.$Const::format2DReport", \@@data);
		# !!! testing parameters only:
		print RT <<END;
d112 7
a118 9
		print RT $$q->end_html;
		close(RT);
	}
	else {
	    print $$q->header( -location=>"graph2D.cgi?id=$ID.$Const::format2DReport");
	}
	
	}
	else {
d121 1
a121 1
		
d123 4
a126 3
		my $maplist = getmap($style->{map}{use},$Const::myPath,$Const::graph2Ddefinitions);
		my ($scale,$width,$height) = myscale($style->{base}->{width}, $style->{base}->{height},$maplist->{measurement}{width},$maplist->{measurement}{height});
		my $colors = colors($style->{map}{clr},$style->{map}{int}); 
d128 1
a128 2
		my ($br,$bg,$bb) = split(/,/,$style->{colors}->{bgclr});
		my $bgclr = $image->colorAllocate($br,$bg,$bb);
d132 5
a136 5
				if ( exists $maplist->{object}{$attr->[$i]} ) {
					my $startx = start($maplist->{object}{$attr->[$i]}{x});
					my $starty = start($maplist->{object}{$attr->[$i]}{y});
					my $polyline =  addPolyline( $maplist->{object}{$attr->[$i]}{points},$startx,$starty,$scale ) ; 
					my ($r,$g,$b) = metric2clr(\$colors,$metric->[$i]);
d143 6
a148 6
		foreach ( @@{$attr} ) {
			my $startx = start($maplist->{object}{$_}{x});
			my $starty = start($maplist->{object}{$_}{y});
			my $borderclr = $image->colorAllocate(0,0,0);
			my $polyline =  addPolyline( $maplist->{object}{$_}{points},$startx,$starty,$scale ) ; 
			$image->polydraw($polyline,$borderclr) if ( exists $maplist->{object}{$_} );
d150 1
a150 1
		
d153 1
a153 1
		open(RT,">$Cache::cacheReport/$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
d164 1
a164 1
<Img UseMap="#mapa" Src=\"$Const::cache2DReport/$ID.$Const::format2DReport\" border=0 Height=$height Width=$width>
a166 1

a412 1
	my $graph = shift;
d414 15
a428 4
	my $xml = new XML::Simple();
	my $xmlfile = "$path$graph/$file";
	my $maplist = $xml->XMLin($xmlfile);

d431 1
d437 8
a444 3
  my $clrs = shift; 
  my $ints = shift;
  my $colors;
d446 1
a446 6
  for ( my $i=0; $i < @@{$clrs};$i++ ) {
      my ($a,$b) = split(/,/,$ints->[$i]);
      push( @@{$colors->{$clrs->[$i]}},$a,$b);  
  }
  
  return $colors;
d452 11
a462 11
  my $colors = shift;
  my $metric = shift; 
  my $rgbstr = '255,255,255'; 

  foreach ( keys %{$$colors} ) {
      if ( $$colors->{$_}[0] <= $metric and $metric < $$colors->{$_}[1] ) {
         $rgbstr = $_;
	 last;
      }
  }
  my ($r,$g,$b) = split(/,/,$rgbstr);
d464 1
a464 1
  return ($r,$g,$b);
@


1.8
log
@added graph 2d map
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.7 2003/11/07 10:55:50 vacula Exp $
d135 4
a138 4
				if ( exists $maplist->{layers}{$attr->[$i]} ) {
					my $startx = start($maplist->{layers}{$attr->[$i]}{elem}{x});
					my $starty = start($maplist->{layers}{$attr->[$i]}{elem}{y});
					my $polyline =  addPolyline( $maplist->{layers}{$attr->[$i]}{elem}{points},$startx,$starty,$scale ) ; 
a140 1
					my $borderclr = $image->colorAllocate(0,0,0);
d142 1
a142 2
					$image->polydraw($polyline,$borderclr) ;
					$htmlmap .= area($attr->[$i],$metric->[$i],$scale,$startx,$starty,$maplist->{layers}{$attr->[$i]}{elem}{points}) ; 
d146 7
d169 1
@


1.7
log
@fix background in html
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.6 2003/11/06 18:43:28 vacula Exp $
d7 3
d12 1
a12 1
#use Local;
d45 5
d51 1
d71 1
a72 1

a90 1
	if ( $style->{colors}->{bgclr} eq undef ) { $style->{colors}->{bgclr} = '255,255,255' }		# for background-color in RT
d116 6
a121 3
	elsif ( $style->{form} eq 'map' ) {
		open(RT,">$Cache::cacheReport/$$variables->{file}") || &ErrorDie(" ERROR: can't write into report cache.");
		
d125 27
d153 11
d167 1
a167 3
	}
	else {
	    print $$q->header( -location=>"graph2D.cgi?id=$ID.$Const::format2DReport");
d376 156
@


1.6
log
@name of report in title
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.5 2003/11/06 18:21:48 vacula Exp $
d9 1
d34 1
a34 1

d40 2
a41 1

d62 1
d64 1
a64 1
	my %attributes = defineAttr($style->{form}, $name, $x_label, $y_label, $style->{layout}, $style->{colors});
a65 1
if ($style->{form} ne 'pie' and $style->{form} ne 'pie3d') {
d82 2
a83 1

d86 1
a86 1
		
d91 1
a91 1

d214 1
a214 1
	my $name = shift;
d237 1
a237 1
	   $attr{"title"} = $name;
@


1.5
log
@fix error in pie and pie3d graphs
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.4 2003/11/05 15:47:57 jiri_schmid Exp $
d31 1
d56 1
a56 1
	my $name = $ID; #(exists $style->{name}{$lang}) ? $style->{name}{$lang} : $ID;
d79 1
a79 1
	writeToImg(\$gd, $Const::format2DReport, $cache_dir, $name);
@


1.4
log
@minor javascript improvments and fixies
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.3 2003/11/04 15:19:01 jiri_schmid Exp $
d7 2
d23 1
a23 1
#use Data::Dumper;
d62 1
d75 1
a75 1

d104 11
d118 1
d232 1
a232 1
	if ( not ( $chart eq 'pie'  or  $chart eq 'pie3d' ) ) {
@


1.3
log
@save as - modperl fixies, code improvments
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.2 2003/11/04 09:38:43 jiri_schmid Exp $
d77 1
a77 1
	if ( $style->{form}=~/^pie$|^bars$|^lines$|^points$|^linespoints$/ ) {
@


1.2
log
@back changes
@
text
@d1 1
a1 1
# $Id: Run_graph2D.pm,v 1.1 2003/11/04 04:47:39 michald Exp $
a79 2
		print RT "Content-Type: text/html; charset=UTF-8\n\n";	#header for html

d82 3
a84 24
		print RT $$q->start_html(
			-title=>"Tabs",
			-lang=>$Const::languages->{$use_lang}{lang},	#return language specification in format: language-country (it differs from param Lang)
			-encoding=>$use_enc,
			-style=>{-src=>["$$variables->{skinPath}menu.css", "./CSS/$css.css"]},
			-script=>{-language=>'JAVASCRIPT', -src=>'js/right_menu.js'},
			-onload=>"init_menu()",
			-head=>meta({-http_equiv => 'Content-Type', -content => "text/html; charset=$use_enc"}),
		);

#		print RT <<END;
#<?xml version="1.0" encoding="$$variables->{useEnc}"?>
#<!DOCTYPE html
#	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
#	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
#<html xmlns="http://www.w3.org/1999/xhtml" lang="$Cache::languages->{$$variables->{useLang}}->{lang}" xml:lang="$Cache::languages->{$$variables->{useLang}}->{lang}">
#<head>
#<meta http-equiv="Content-Type" content="text/html; charset=$$variables->{useEnc}" />
#<title>Report Result</title>
#<style>\@@import url("./CSS/$css.css");</style>
#<style>\@@import url("$$variables->{skinPath}menu.css");</style>
#<script type="text/javascript" src="js/right_menu.js"></script>
#</head>
#<body onload="init_menu()" style="background-color: rgb($style->{colors}->{bgclr})">
@


1.1
log
@graph2D fix for mod_perl
@
text
@d1 1
a1 1
# $Id: run_graph2D.pl,v 1.1 2003/10/16 14:08:53 jiri_schmid Exp $
a5 1
use vars qw($skinPath);
d79 3
d104 1
a104 1
#<style>\@@import url("${skinPath}menu.css");</style>
@

