head	1.3;
access;
symbols
	jpivot_1_8_0:1.3
	focus_1_6_0:1.3.0.4
	wcf_1_7_0:1.3
	wcf_1_6_0:1.3
	jpivot_1_5_0:1.3.0.2
	Root_jpivot_1_5_0:1.3
	mondrian_xmla_2005_08_25:1.2.0.2
	sourceforge_sync:1.3;
locks; strict;
comment	@# @;


1.3
date	2005.12.13.11.54.18;	author avix;	state Exp;
branches;
next	1.2;

1.2
date	2005.07.25.12.53.55;	author avix;	state Exp;
branches;
next	1.1;

1.1
date	2005.07.05.14.04.28;	author avix;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Synchronized with Tonbeller CVS:
  * Added BEA / Websphere Support
  * More tags in wcf tag library
  * Bugfixes
@
text
@package com.tonbeller.tbutils.res;

import java.util.Collection;
import java.util.Collections;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NameNotFoundException;
import javax.naming.NamingException;
import javax.naming.NoInitialContextException;

import org.apache.log4j.Logger;
/**
 * Adapter for java naming
 */

public class JNDIResourceProvider implements ResourceProvider {
  Context context = null;
  boolean disabled = false;
  private static Logger logger = Logger.getLogger(JNDIResourceProvider.class);
  public static final String JNDI_NULL = "jndi.null";

  public String getString(String key) {
    if (disabled)
      return null;
    try {
      if (context == null) {
        Context initCtx = new InitialContext();
        context = (Context) initCtx.lookup("java:comp/env");
      }
      Object obj = context.lookup(key);
      if (obj == null) {
        if (logger.isInfoEnabled())
          logger.info("key is null: " + key);
        return null;
      }
      String str = obj.toString();
      
      // there MUST be a value in web.xml
      if (JNDI_NULL.equals(str)) {
        if (logger.isInfoEnabled())
          logger.info("key is jndi.null: " + key);
        return null;
      }
      
      return str;
    } catch (NameNotFoundException e) {
      if (logger.isInfoEnabled())
        logger.info("key not found: " + key);
      return null;
    } catch (NoInitialContextException e) {
      logger.warn("JNDI Context not found, assuming test environment");
      disabled = true;
      return null;
    } catch (NamingException e) {
      logger.error(key, e);
      return null;
    }
  }

  public Collection keySet() {
    return Collections.EMPTY_SET;
  }

  public void close() {
    try {
      if (context != null)
        context.close();
    } catch (NamingException e) {
      logger.error("error closing context", e);
    } finally {
      context = null;
    }
  }

  public void dump(Dumper d) {
    d.dump(this);
  }
  
  public String getName() {
    return "JNDI Lookup " + (disabled ? "disabled" : "enabled"); 
  }

}
@


1.2
log
@sourceforge_sync
@
text
@d21 1
d32 3
a34 1
      if (obj == null)
d36 11
a46 1
      return obj.toString();
d48 2
@


1.1
log
@initial version
@
text
@d20 2
a21 1
  private static Logger logger = Logger.getLogger(JNDIResourceProvider.class);  
d49 1
a49 1
  
d61 8
@

