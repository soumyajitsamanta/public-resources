head	1.4;
access;
symbols
	jpivot_1_8_0:1.3
	focus_1_6_0:1.3.0.2
	jpivot_1_7_0:1.3
	jpivot_1_6_0:1.3
	jpivot_1_5_0:1.1.0.4
	Root_jpivot_1_5_0:1.1
	mondrian_xmla_2005_08_25:1.1.0.2
	sourceforge_sync:1.3;
locks; strict;
comment	@# @;
expand	@k@;


1.4
date	2009.12.18.19.44.29;	author willgorman;	state Exp;
branches;
next	1.3;

1.3
date	2006.11.09.13.25.44;	author avix;	state Exp;
branches;
next	1.2;

1.2
date	2006.10.06.20.46.38;	author avix;	state Exp;
branches;
next	1.1;

1.1
date	2005.07.05.14.19.50;	author avix;	state Exp;
branches;
next	;


desc
@@


1.4
log
@renamed getBookmarkState to retrieveBookmarkState so that JPivot works with beanutils-1.8
@
text
@package com.tonbeller.jpivot.mondrian;

import java.util.List;

import junit.framework.TestCase;

import com.tonbeller.jpivot.olap.model.Axis;
import com.tonbeller.jpivot.olap.model.Position;
import com.tonbeller.jpivot.olap.model.Result;
import com.tonbeller.jpivot.olap.navi.DrillExpandPosition;
import com.tonbeller.jpivot.olap.query.DrillExpandPositionExt;
import com.tonbeller.jpivot.olap.query.ResultBase;
import com.tonbeller.jpivot.tags.MondrianModelFactory;
import com.tonbeller.wcf.bookmarks.Bookmarkable;

/**
 * make sure that the measures "Store Cost,Store Sales, Unit Sales"
 * are NOT "hierarchized".
 */
public class CoSalUniTest extends TestCase {

  /**
   * Constructor
   * @@param arg0
   */
  public CoSalUniTest(String arg0) {
    super(arg0);
  }

  public void testCoSalUni() throws Exception {

    /*
     select Crossjoin({[Store Size in SQFT].[All Store Size in SQFTs]},
     Crossjoin({[Store Type].[All Store Types]},
     {[Measures].[Store Cost], [Measures].[Store Sales], [Measures].[Unit Sales]})) ON columns,
     {[Product].[All Products]} ON rows
     from [Sales]
     where [Time].[1997]
     */
    String mdxQuery = "select Crossjoin({[Store Size in SQFT].[All Store Size in SQFTs]}, "
        + "Crossjoin({[Store Type].[All Store Types]}, "
        + "{[Measures].[Store Cost], [Measures].[Store Sales], [Measures].[Unit Sales]})) ON columns, "
        + "{[Product].[All Products]} ON rows from [Sales] where [Time].[1997]";

    String renderFile = null; //"c:\\x\\testCoSalUni";
    int renderNum = 0;

    Result result;

    MondrianModel model = MondrianModelFactory.instance();
    model.setMdxQuery(mdxQuery);
    TestConnection.initModel(model);

    // first step
    result = model.getResult();
    if (renderFile != null)
      ResultBase.renderHtml(result, model.getCurrentMdx(),  renderFile + renderNum++ + ".html");

    assertPosition(result, 2, new String[] { "All Store Size in SQFTs", "All Store Types",
        "Unit Sales"});

    DrillExpandPositionExt mdep = (DrillExpandPositionExt) model
        .getExtension(DrillExpandPosition.ID);

    // Drill down All Store Size
    Axis[] axes = result.getAxes();
    List positions = axes[0].getPositions();
    Position pos0 = (Position) positions.get(0); // Drill down All Store Size

    assertTrue(mdep.canExpand(pos0, pos0.getMembers()[0]));
    mdep.expand(pos0, pos0.getMembers()[0]); // drilldown All Store Size

    result = model.getResult();
    if (renderFile != null)
      ResultBase.renderHtml(result, model.getCurrentMdx(),  renderFile + renderNum++ + ".html");

    assertPosition(result, 7, new String[] { "20319", "All Store Types", "Store Sales"});

    // drill down All Store Types below 20319.0
    axes = result.getAxes();
    positions = axes[0].getPositions();
    Position pos7 = (Position) positions.get(7); // "20319.0", "All Store Types"
    mdep.expand(pos7, pos7.getMembers()[1]); // drilldown All Store Size    
    result = model.getResult();
    if (renderFile != null)
      ResultBase.renderHtml(result, model.getCurrentMdx(),  renderFile + renderNum++ + ".html");

    assertPosition(result, 24, new String[] { "20319", "Supermarket", "Store Cost"});

    // save bookmark and reload
    Object state = model.retrieveBookmarkState(Bookmarkable.EXTENSIONAL);
    result = model.getResult();
    if (renderFile != null)
      ResultBase.renderHtml(result, model.getCurrentMdx(),  renderFile + renderNum++ + ".html");

    assertPosition(result, 1, new String[] { "All Store Size in SQFTs", "All Store Types",
        "Store Sales"});

    model.setMdxQuery(mdxQuery);
    model.setBookmarkState(state);
    result = model.getResult();
    if (renderFile != null)
      ResultBase.renderHtml(result, model.getCurrentMdx(),  renderFile + renderNum++ + ".html");

    assertPosition(result, 24, new String[] { "20319", "Supermarket", "Store Cost"});

  }

  /**
   * assert position
   */
  private void assertPosition(Result result, int iPos, String[] posMembers) {
    Position pos = (Position) result.getAxes()[0].getPositions().get(iPos);
    for (int i = 0; i < posMembers.length; i++) {
      String str = pos.getMembers()[i].getLabel();
      assertEquals(str, posMembers[i]);
    }
  }
} // CoSalUni
@


1.3
log
@synchronized with tonbeller cvs
@
text
@d91 1
a91 1
    Object state = model.getBookmarkState(Bookmarkable.EXTENSIONAL);
@


1.2
log
@Bookmarks work with new Mondrian API ("compiled expressions" change). All tests pass.
@
text
@d13 1
@


1.1
log
@initial version
@
text
@d76 1
a76 1
    assertPosition(result, 4, new String[] { "20319", "All Store Types", "Store Sales"});
d81 2
a82 2
    Position pos4 = (Position) positions.get(4); // "20319.0", "All Store Types"
    mdep.expand(pos4, pos4.getMembers()[1]); // drilldown All Store Size    
d87 1
a87 1
    assertPosition(result, 21, new String[] { "20319", "Supermarket", "Store Cost"});
d104 1
a104 1
    assertPosition(result, 21, new String[] { "20319", "Supermarket", "Store Cost"});
@

