head	1.4;
access;
symbols
	jpivot_1_8_0:1.4
	focus_1_6_0:1.3.0.2
	jpivot_1_7_0:1.4
	jpivot_1_6_0:1.3
	jpivot_1_5_0:1.1.0.4
	Root_jpivot_1_5_0:1.1
	mondrian_xmla_2005_08_25:1.1.0.2
	sourceforge_sync:1.3;
locks; strict;
comment	@# @;
expand	@k@;


1.4
date	2007.03.05.20.49.05;	author remberson;	state Exp;
branches;
next	1.3;

1.3
date	2006.11.09.13.25.42;	author avix;	state Exp;
branches;
next	1.2;

1.2
date	2006.09.29.14.27.03;	author avix;	state Exp;
branches;
next	1.1;

1.1
date	2005.07.05.14.19.51;	author avix;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Upgrading for Mondrian head and adding property
"com.tonbeller.jpivot.mondrian.logical.mdx" that, if true (default
is false), JPivot attempts to keep MDX logical rather than
physical during query modification.
@
text
@/*
 * ====================================================================
 * This software is subject to the terms of the Common Public License
 * Agreement, available at the following URL:
 *   http://www.opensource.org/licenses/cpl.html .
 * Copyright (C) 2003-2004 TONBELLER AG.
 * All Rights Reserved.
 * You must accept the terms of that agreement to use this software.
 * ====================================================================
 *
 * 
 */
package com.tonbeller.jpivot.mondrian;

import java.util.Hashtable;
import java.util.Map;

import mondrian.olap.Category;
import mondrian.olap.type.TypeUtil;

import org.apache.log4j.Logger;

import com.tonbeller.jpivot.core.ExtensionSupport;
import com.tonbeller.jpivot.olap.model.DoubleExpr;
import com.tonbeller.jpivot.olap.model.Expression;
import com.tonbeller.jpivot.olap.model.IntegerExpr;
import com.tonbeller.jpivot.olap.model.StringExpr;
import com.tonbeller.jpivot.olap.navi.SetParameter;

/**
 * set parameter to query
 */
public class MondrianSetParameter extends ExtensionSupport implements SetParameter {

  static Logger logger = Logger.getLogger(MondrianSetParameter.class);

  /**
   */
  public MondrianSetParameter() {
    super.setId(SetParameter.ID);
  }

  /**
   * set parameter value to mondrian query
   * @@see SetParameter#setParameter(String, Expression)
   */
  public void setParameter(String paramName, Expression expr) {
    MondrianModel model = (MondrianModel) getModel();
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter) model.getQueryAdapter()).getMonQuery();
    mondrian.olap.Parameter[] monParams = monQuery.getParameters();
    for (int i = 0; i < monParams.length; i++) {
      mondrian.olap.Parameter monParam = monParams[i];
      int pType = TypeUtil.typeToCategory(monParam.getType());
      String monParaName = monParam.getName();
      if (paramName.equals(monParaName)) {

        // found the parameter with the given name in the query
        switch (pType) {
        case Category.Numeric:
          if (expr instanceof DoubleExpr) {
            double d = ((DoubleExpr) expr).getValue();
            monParam.setValue(new Double(d));
          } else if (expr instanceof IntegerExpr) {
            int ii = ((IntegerExpr) expr).getValue();
            monParam.setValue(new Double(ii));
          } else {
            // wrong parameter type
            String str = "wrong Numeric parameter type " + paramName + expr.getClass().toString();
            logger.error(str);
            throw new java.lang.IllegalArgumentException(str);
          }
          break;

        case Category.String:
          if (expr instanceof StringExpr) {
            String s = ((StringExpr) expr).getValue();
            monParam.setValue(s);
          } else {
            // wrong parameter type
            String str = "wrong String parameter type " + paramName + expr.getClass().toString();
            logger.error(str);
            throw new java.lang.IllegalArgumentException(str);
          }

          break;

        case Category.Member:
          if (expr instanceof MondrianMember) {
            MondrianMember m = (MondrianMember) expr;
            monParam.setValue(m.getMonMember());
          } else {
            // wrong parameter type
            String str = "wrong Member parameter type " + paramName + expr.getClass().toString();
            logger.error(str);
            throw new java.lang.IllegalArgumentException(str);
          }
          break;
        default:
        }
        model.fireModelChanged();
        return;
      }
    }
  }

  /**
   * FIXME - this crashes if the parameter contains an expression like "LastChild" or "DefaultMember".
   * @@return Map containing parameter names (= keys) and strings to display value (= value)
   * @@see com.tonbeller.jpivot.olap.navi.SetParameter#getDisplayValues()
   */
  public Map getDisplayValues() {
    Map map = new Hashtable();
    MondrianModel model = (MondrianModel) getModel();
    mondrian.olap.Query monQuery = 
        ((MondrianQueryAdapter) model.getQueryAdapter()).getMonQuery();
    mondrian.olap.Parameter[] monParams = monQuery.getParameters();
    for (int i = 0; i < monParams.length; i++) {
      mondrian.olap.Parameter monParam = monParams[i];
      int pType = TypeUtil.typeToCategory(monParam.getType());
      String monParaName = monParam.getName();
      Object value = monParam.getValue();
      switch (pType) {
      case Category.Numeric:
        map.put(monParaName, value.toString());
        break;
      case Category.String:
        map.put(monParaName, value);
        break;
      case Category.Member:
        map.put(monParaName, ((mondrian.olap.Member) value).getCaption());
        break;
      }
    }

    return map;
  }

  public String[] getParameterNames() {
    MondrianModel model = (MondrianModel) getModel();
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter)model.getQueryAdapter()).getMonQuery();
    mondrian.olap.Parameter[] monParams = monQuery.getParameters();
    String[] names = new String[monParams.length];
    for (int i = 0; i < monParams.length; i++) {
      names[i] = monParams[i].getName();
    }
    return names;
  }
  /** 
   * Returns true if the query has one or more parameters. This does not
   * evaluate the parameters. 
   * 
   * @@return 
   */
  public boolean  getHasDisplayValues() {
    MondrianModel model = (MondrianModel) getModel();
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter)model.getQueryAdapter()).getMonQuery();
    mondrian.olap.Parameter[] monParams = monQuery.getParameters();
    return (monParams.length > 0);
  }

} // MondrianSetParameter
@


1.3
log
@synchronized with tonbeller cvs
@
text
@a58 1

d98 1
d114 2
a115 1
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter) model.getQueryAdapter()).getMonQuery();
d148 13
@


1.2
log
@Fix bug 1566263
Adapted to current Mondrian (Perforce version of today)
@
text
@d49 1
a49 1
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter)model.getQueryAdapter()).getMonQuery();
d60 39
a98 39
          case Category.Numeric :
            if (expr instanceof DoubleExpr) {
              double d = ((DoubleExpr) expr).getValue();
              monParam.setValue(new Double(d));
            } else if (expr instanceof IntegerExpr) {
              int ii = ((IntegerExpr) expr).getValue();
              monParam.setValue(new Double(ii));
            } else {
              // wrong parameter type
              String str = "wrong Numeric parameter type " + paramName + expr.getClass().toString();
              logger.error(str);
              throw new java.lang.IllegalArgumentException(str);
            }
            break;

          case Category.String :
            if (expr instanceof StringExpr) {
              String s = ((StringExpr) expr).getValue();
              monParam.setValue(s);
            } else {
              // wrong parameter type
              String str = "wrong String parameter type " + paramName + expr.getClass().toString();
              logger.error(str);
              throw new java.lang.IllegalArgumentException(str);
            }

            break;

          case Category.Member :
            if (expr instanceof MondrianMember) {
              MondrianMember m = (MondrianMember) expr;
              monParam.setValue(m.getMonMember());
            } else {
              // wrong parameter type
              String str = "wrong Member parameter type " + paramName + expr.getClass().toString();
              logger.error(str);
              throw new java.lang.IllegalArgumentException(str);
            }
            break;
d107 1
d114 1
a114 1
    mondrian.olap.Query monQuery = ((MondrianQueryAdapter)model.getQueryAdapter()).getMonQuery();
d122 9
a130 9
        case Category.Numeric :
          map.put(monParaName, value.toString());
          break;
        case Category.String :
          map.put(monParaName, value);
          break;
        case Category.Member :
          map.put(monParaName, ((mondrian.olap.Member) value).getCaption());
          break;
d137 10
@


1.1
log
@initial version
@
text
@d18 3
a22 2
import mondrian.olap.Category;

d53 1
a53 1
      int pType = monParam.getCategory();
d117 1
a117 1
      int pType = monParam.getCategory();
@

