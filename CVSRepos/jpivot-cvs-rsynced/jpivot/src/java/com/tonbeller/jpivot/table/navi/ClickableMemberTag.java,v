head	1.2;
access;
symbols
	jpivot_1_8_0:1.2
	focus_1_6_0:1.2.0.2
	jpivot_1_7_0:1.2
	jpivot_1_6_0:1.2
	jpivot_1_5_0:1.1.0.4
	Root_jpivot_1_5_0:1.1
	mondrian_xmla_2005_08_25:1.1.0.2
	sourceforge_sync:1.2;
locks; strict;
comment	@# @;
expand	@k@;


1.2
date	2006.11.09.13.25.43;	author avix;	state Exp;
branches;
next	1.1;

1.1
date	2005.07.05.14.19.53;	author avix;	state Exp;
branches;
next	;


desc
@@


1.2
log
@synchronized with tonbeller cvs
@
text
@/*
 * ====================================================================
 * This software is subject to the terms of the Common Public License
 * Agreement, available at the following URL:
 *   http://www.opensource.org/licenses/cpl.html .
 * Copyright (C) 2003-2004 TONBELLER AG.
 * All Rights Reserved.
 * You must accept the terms of that agreement to use this software.
 * ====================================================================
 *
 * 
 */
package com.tonbeller.jpivot.table.navi;

import javax.servlet.jsp.JspException;
import javax.servlet.jsp.tagext.TagSupport;

import org.apache.log4j.Logger;

import com.tonbeller.jpivot.param.MemberParamProvider;
import com.tonbeller.jpivot.param.ParameterProvider;
import com.tonbeller.jpivot.param.PropertyParamProvider;
import com.tonbeller.jpivot.param.PropertyPrefixParamProvider;
import com.tonbeller.jpivot.table.AxisBuilder;
import com.tonbeller.jpivot.table.ClickableMember;
import com.tonbeller.jpivot.table.SpanBuilder;
import com.tonbeller.jpivot.table.TableComponent;
import com.tonbeller.jpivot.table.TableComponentTag;
import com.tonbeller.jpivot.tags.OlapModelTag;

/**
 * allows to click on a member in the table and pass the member
 * as parameter to another jsp page
 * 
 * @@author av
 */
public class ClickableMemberTag extends TagSupport {
  String urlPattern;
  String uniqueName;
  String menuLabel;

  String sessionParam;
  String propertyName;
  String propertyPrefix;
  String providerClass;
  String page;

  private static Logger logger = Logger.getLogger(ClickableMemberTag.class);

  public int doStartTag() throws JspException {
    if (propertyPrefix != null && sessionParam != null)
      throw new JspException("propertyPrefix and sessionParam can not be specified both");

    if (logger.isInfoEnabled())
      logger.info("creating clickable member for URL: " + urlPattern + ", uniqueName: "
          + uniqueName);

    TableComponentTag tct = (TableComponentTag) findAncestorWithClass(this, TableComponentTag.class);
    if (tct != null) {
      createStaticClickable(tct);
      return SKIP_BODY;
    }

    OlapModelTag omt = (OlapModelTag) findAncestorWithClass(this, OlapModelTag.class);
    if (omt != null) {
      createDynamicClickable(omt);
      return SKIP_BODY;
    }

    throw new JspException("ClickableMemberTag must be nested in a table or query tag");
  }

  private void createDynamicClickable(OlapModelTag omt) {
    ParameterProvider provider = createProvider();
    ClickableMember clickable = createClickable(provider);
    omt.addClickable(clickable);
  }

  private void createStaticClickable(TableComponentTag tct) throws JspException {
    TableComponent tc = (TableComponent) tct.getComponent();
    ParameterProvider provider = createProvider();
    decorate(tc.getRowAxisBuilder(), createClickable(provider));
    decorate(tc.getColumnAxisBuilder(), createClickable(provider));
  }

  private ClickableMember createClickable(ParameterProvider provider) {
    if (provider != null) {
      DynamicClickableMember dcm = new DynamicClickableMember(uniqueName, menuLabel, provider, page);
      dcm.setUrlPattern(urlPattern); // support legacy
      return dcm;
    }
    return new UrlClickableMember(uniqueName, menuLabel, urlPattern);
  }

  private ParameterProvider createProvider() {
    ParameterProvider provider = null;

    if (sessionParam != null) {
      if (propertyName != null)
        provider = new PropertyParamProvider(sessionParam, propertyName);
      else
        provider = new MemberParamProvider(sessionParam);
    } else if (propertyPrefix != null) {
      provider = new PropertyPrefixParamProvider(propertyPrefix);
    } else if (providerClass != null) {
      try {
        provider = (ParameterProvider) Class.forName(providerClass).newInstance();
      } catch (InstantiationException e) {
        logger.error(null, e);
      } catch (IllegalAccessException e) {
        logger.error(null, e);
      } catch (ClassNotFoundException e) {
        logger.error(null, e);
      }
    }
    return provider;
  }

  private void decorate(AxisBuilder axisBuilder, ClickableMember clickable) {
    SpanBuilder decoree = axisBuilder.getSpanBuilder();
    SpanBuilder decorator = new StaticClickableMember(decoree, clickable);
    axisBuilder.setSpanBuilder(decorator);
  }

  public void setUniqueName(String string) {
    uniqueName = string;
  }

  public void setUrlPattern(String string) {
    urlPattern = string;
  }

  public void setSessionParam(String sessionParam) {
    this.sessionParam = sessionParam;
  }

  public void setPropertyName(String propertyName) {
    this.propertyName = propertyName;
  }

  public void setPropertyPrefix(String propertyPrefix) {
    this.propertyPrefix = propertyPrefix;
  }

  public void setProviderClass(String providerClass) {
    this.providerClass = providerClass;
  }

  public void setPage(String page) {
    this.page = page;
  }

  public void setMenuLabel(String menuLabel) {
    this.menuLabel = menuLabel;
  }

}@


1.1
log
@initial version
@
text
@d20 1
a20 1
import com.tonbeller.jpivot.param.DefaultParamProvider;
d22 2
d25 1
d40 1
d63 2
a64 2
    
    OlapModelTag omt = (OlapModelTag)findAncestorWithClass(this, OlapModelTag.class);
d69 1
a69 1
    
d75 2
a76 2
    DynamicClickableMember dcm = new DynamicClickableMember(uniqueName, urlPattern, page, provider);
    omt.addClickable(dcm);
d82 11
a92 2
    decorate(tc.getRowAxisBuilder(), provider);
    decorate(tc.getColumnAxisBuilder(), provider);
d100 1
a100 1
        provider = DefaultParamProvider.createPropertyInstance(sessionParam, propertyName);
d102 1
a102 1
        provider = DefaultParamProvider.createMemberInstance(sessionParam);
d104 1
a104 1
      provider = DefaultParamProvider.createPropertyPrefixInstance(propertyPrefix);
d119 1
a119 1
  private void decorate(AxisBuilder axisBuilder, ParameterProvider provider) {
d121 1
a121 1
    SpanBuilder decorator = new StaticClickableMember(decoree, uniqueName, urlPattern, page, provider);
d152 5
@

